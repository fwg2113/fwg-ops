<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <script src="https://js.stripe.com/v3/"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Frederick Wraps & Graphics</title>
  
  <style>
    :root {
      --bg-dark: #0f172a;
      --bg-surface: #1e293b;
      --bg-elevated: #334155;
      --border-color: rgba(148, 163, 184, 0.2);
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent-green: #22c55e;
      --accent-red: #ef4444;
      --accent-blue: #3b82f6;
      --accent-yellow: #eab308;
      --fwg-primary: #d71cd1;
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 20px;
      overflow-x: hidden;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    
    @media (max-width: 600px) {
      .container {
        max-width: 100%;
      }
    }
    
    /* Header */
    .doc-header {
      text-align: center;
      padding: 30px 20px;
      background: var(--bg-surface);
      border-radius: var(--radius-lg);
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }
    
    .company-logo {
      font-size: 48px;
      margin-bottom: 12px;
    }
    
    .company-name {
      font-size: 24px;
      font-weight: 700;
      color: var(--fwg-primary);
      margin-bottom: 4px;
    }
    
    .company-tagline {
      font-size: 14px;
      color: var(--text-muted);
    }
    
    .doc-title {
      margin-top: 24px;
      font-size: 18px;
      font-weight: 600;
    }
    
    .doc-number {
      font-size: 14px;
      color: var(--text-muted);
      font-family: monospace;
      margin-top: 6px;
    }
    
    /* Status Banner */
    .status-banner {
      padding: 16px 20px;
      border-radius: var(--radius-md);
      text-align: center;
      margin-bottom: 20px;
      font-weight: 500;
    }
    
    .status-banner.draft {
      background: rgba(100, 116, 139, 0.15);
      color: var(--text-muted);
      border: 1px solid var(--border-color);
    }
    
    .status-banner.sent,
    .status-banner.viewed {
      background: rgba(234, 179, 8, 0.15);
      color: var(--accent-yellow);
      border: 1px solid rgba(234, 179, 8, 0.3);
    }
    
    .status-banner.approved,
    .status-banner.paid {
      background: rgba(34, 197, 94, 0.15);
      color: var(--accent-green);
      border: 1px solid rgba(34, 197, 94, 0.3);
    }
    
    .status-banner.declined,
    .status-banner.overdue,
    .status-banner.void {
      background: rgba(239, 68, 68, 0.15);
      color: var(--accent-red);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    .status-banner.expired {
      background: rgba(100, 116, 139, 0.15);
      color: var(--text-muted);
      border: 1px solid var(--border-color);
    }
    
    .status-banner.partial {
      background: rgba(59, 130, 246, 0.15);
      color: var(--accent-blue);
      border: 1px solid rgba(59, 130, 246, 0.3);
    }
    
    .status-banner.revision {
      background: rgba(234, 179, 8, 0.15);
      color: var(--accent-yellow);
      border: 1px solid rgba(234, 179, 8, 0.3);
    }
    
    /* Design Hero Section */
    .design-hero {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      overflow: hidden;
      margin-bottom: 20px;
    }
    
    .design-header {
      padding: 16px 20px;
      background: linear-gradient(135deg, var(--fwg-primary), #9333ea);
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
    }
    
    .design-gallery {
      position: relative;
    }
    
    .design-main-image {
      width: 100%;
      max-height: 70vh;
      object-fit: contain;
      cursor: pointer;
      display: block;
      background: var(--bg-dark);
    }
    
    .design-main-image.placeholder {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 14px;
    }
    
    .tap-hint {
      position: absolute;
      bottom: 12px;
      right: 12px;
      background: rgba(0,0,0,0.7);
      color: white;
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 4px;
      pointer-events: none;
    }
    
    .design-thumbnails {
      display: flex;
      gap: 8px;
      padding: 12px;
      background: var(--bg-dark);
      overflow-x: auto;
    }
    
    .design-thumb {
      width: 60px;
      height: 60px;
      min-width: 60px;
      border-radius: 8px;
      border: 2px solid var(--border-color);
      cursor: pointer;
      object-fit: cover;
      transition: border-color 0.15s ease;
    }
    
    .design-thumb:hover,
    .design-thumb.active {
      border-color: var(--fwg-primary);
    }
    
    .design-thumb-more {
      width: 60px;
      height: 60px;
      min-width: 60px;
      border-radius: 8px;
      border: 2px solid var(--border-color);
      background: var(--bg-elevated);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--text-muted);
      cursor: pointer;
    }
    
    .design-actions {
      padding: 16px;
      display: flex;
      gap: 12px;
    }
    
    .design-actions.hidden {
      display: none;
    }
    
    .btn-design {
      flex: 1;
      padding: 14px 16px;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.15s ease;
    }
    
    .btn-revision {
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }
    
    .btn-revision:hover {
      border-color: var(--accent-yellow);
      color: var(--accent-yellow);
    }
    
    .btn-love {
      background: linear-gradient(135deg, var(--accent-green), #16a34a);
      border: none;
      color: white;
    }
    
    .btn-love:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
    }
    
    .btn-love:disabled,
    .btn-revision:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    /* Revision Panel */
    .revision-panel {
      padding: 0 16px 16px;
      display: none;
    }
    
    .revision-panel.active {
      display: block;
    }
    
    .revision-box {
      background: var(--bg-dark);
      border-radius: var(--radius-md);
      padding: 16px;
      border: 1px solid var(--accent-yellow);
    }
    
    .revision-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
      color: var(--accent-yellow);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .revision-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }
    
    .revision-textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      background: var(--bg-surface);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      margin-bottom: 12px;
    }
    
    .revision-textarea:focus {
      outline: none;
      border-color: var(--accent-yellow);
    }
    
    .revision-textarea::placeholder {
      color: var(--text-muted);
    }
    
    .revision-actions {
      display: flex;
      gap: 12px;
    }
    
    .btn-cancel-revision {
      flex: 1;
      padding: 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-weight: 500;
      cursor: pointer;
    }
    
    .btn-submit-revision {
      flex: 1;
      padding: 12px;
      background: var(--accent-yellow);
      border: none;
      border-radius: var(--radius-md);
      color: #000;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-submit-revision:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Design Approved State */
    .design-approved-badge {
      padding: 16px;
      background: rgba(34, 197, 94, 0.1);
      border-top: 1px solid rgba(34, 197, 94, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: var(--accent-green);
      font-weight: 600;
    }
    
    /* Sections */
    .section {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      margin-bottom: 20px;
      overflow: hidden;
    }
    
    .section-header {
      padding: 14px 20px;
      background: var(--bg-elevated);
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .section-body {
      padding: 20px;
    }
    
    /* Info Grid */
    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    
    @media (max-width: 500px) {
      .info-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .info-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .info-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .info-value {
      font-size: 15px;
      color: var(--text-primary);
    }
    
    /* Line Items */
    .line-items {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .line-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 14px 16px;
      background: var(--bg-dark);
      border-radius: var(--radius-md);
      gap: 16px;
    }
    
    .line-item-desc {
      flex: 1;
    }
    
    .line-item-name {
      font-weight: 500;
      margin-bottom: 4px;
    }
    
    .line-item-details {
      font-size: 13px;
      color: var(--text-muted);
    }
    
    .line-item-total {
      font-weight: 600;
      text-align: right;
      min-width: 80px;
    }
    
    /* Totals */
    .totals {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 2px solid var(--border-color);
    }
    
    .total-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 14px;
    }
    
    .total-row.grand-total {
      font-size: 20px;
      font-weight: 700;
      padding-top: 12px;
      margin-top: 8px;
      border-top: 2px solid var(--border-color);
    }
    
    .total-row.deposit {
      color: var(--accent-green);
    }
    
    .total-row.paid {
      color: var(--accent-green);
    }
    
    .total-row.balance {
      font-size: 20px;
      font-weight: 700;
      padding-top: 12px;
      margin-top: 8px;
      border-top: 2px solid var(--border-color);
    }
    
    .total-row.balance.due {
      color: var(--accent-red);
    }
    
    .total-row.balance.zero {
      color: var(--accent-green);
    }
    
    .total-row.amount-due-proceed {
      font-size: 20px;
      font-weight: 700;
      color: var(--fwg-primary);
      padding-top: 12px;
      margin-top: 8px;
      border-top: 2px solid var(--border-color);
    }
    
    .total-row.balance-muted {
      color: var(--text-muted);
    }
    
    .total-label {
      color: var(--text-secondary);
    }
    
    /* Valid Until / Due Date */
    .date-notice {
      text-align: center;
      padding: 12px;
      background: var(--bg-dark);
      border-radius: var(--radius-md);
      margin-top: 16px;
      font-size: 13px;
      color: var(--text-muted);
    }
    
    /* Payment History */
    .payment-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .payment-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      background: var(--bg-dark);
      border-radius: var(--radius-md);
    }
    
    .payment-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .payment-amount {
      font-size: 16px;
      font-weight: 600;
      color: var(--accent-green);
    }
    
    .payment-method {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .payment-date {
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    /* Action Buttons */
    .actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    
    @media (max-width: 500px) {
      .actions {
        flex-direction: column;
      }
    }
    
    .btn {
      flex: 1;
      padding: 16px 24px;
      border-radius: var(--radius-md);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-approve {
      background: linear-gradient(135deg, var(--accent-green), #16a34a);
      color: white;
    }
    
    .btn-approve:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
    }
    
    .btn-decline {
      background: var(--bg-elevated);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
    }
    
    .btn-decline:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: var(--accent-red);
      color: var(--accent-red);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .btn-loading {
      opacity: 0.7;
      pointer-events: none;
    }

    /* Stripe Payment */
    .stripe-section {
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
      padding: 20px;
      margin-top: 24px;
    }
    
    .stripe-title {
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .card-element-container {
      background: #ffffff;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
    }
    
    .card-errors {
      color: var(--accent-red);
      font-size: 13px;
      margin-top: 8px;
      display: none;
    }
    
    .btn-stripe {
      width: 100%;
      padding: 16px;
      background: #635bff;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .btn-stripe:hover {
      background: #5851db;
    }
    
    .btn-stripe:disabled {
      background: #999;
      cursor: not-allowed;
    }
    
    .stripe-processing {
      display: none;
      text-align: center;
      padding: 16px;
    }
    
    .stripe-spinner {
      width: 24px;
      height: 24px;
      border: 3px solid var(--border-color);
      border-top-color: #635bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }
    
    .powered-stripe {
      text-align: center;
      margin-top: 12px;
      opacity: 0.5;
      font-size: 12px;
    }
    
    .pay-divider {
      display: flex;
      align-items: center;
      margin: 16px 0;
      color: var(--text-muted);
      font-size: 13px;
    }
    
    .pay-divider::before,
    .pay-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border-color);
    }
    
    .pay-divider span {
      padding: 0 12px;
    }
    
    /* Contact Section */
    .contact-section {
      text-align: center;
      padding: 24px;
      background: var(--bg-surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      margin-top: 20px;
    }
    
    .contact-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
    }
    
    .contact-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .contact-info a {
      color: var(--fwg-primary);
      text-decoration: none;
    }
    
    .contact-info a:hover {
      text-decoration: underline;
    }
    
    /* Loading */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-color);
      border-top-color: var(--fwg-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Error */
    .error-state {
      text-align: center;
      padding: 60px 20px;
    }
    
    .error-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .error-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .error-message {
      color: var(--text-muted);
    }
    
    /* Decline Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
    }
    
    .modal-overlay.hidden {
      display: none !important;
    }
    
    .modal {
      background: var(--bg-surface);
      border-radius: var(--radius-lg);
      max-width: 400px;
      width: 100%;
      border: 1px solid var(--border-color);
    }
    
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
      font-size: 18px;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .modal-body textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      background: var(--bg-dark);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
    }
    
    .modal-body textarea:focus {
      outline: none;
      border-color: var(--fwg-primary);
    }
    
    .modal-body label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    .modal-footer .btn {
      flex: 0;
      padding: 10px 20px;
    }
    
    .btn-cancel {
      background: var(--bg-elevated);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
    }
    
    .btn-cancel:hover {
      background: var(--bg-dark);
    }
    
    .btn-confirm-decline {
      background: var(--accent-red);
      color: white;
    }
    
    .btn-confirm-decline:hover {
      background: #dc2626;
    }
    
    /* Lightbox */
    .lightbox {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      padding: 20px;
      overflow: hidden;
    }
    
    .lightbox.hidden {
      display: none !important;
    }
    
    .lightbox img {
      max-width: 90vw;
      max-height: 85vh;
      border-radius: 8px;
      object-fit: contain;
    }
    
    .lightbox-close {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 44px;
      height: 44px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      color: #fff;
      font-size: 28px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100000;
    }
    
    .lightbox-close:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      padding: 12px 24px;
      border-radius: var(--radius-md);
      font-size: 14px;
      z-index: 3000;
      animation: slideUp 0.3s ease;
    }
    
    .toast.success {
      border-color: var(--accent-green);
      color: var(--accent-green);
    }
    
    .toast.error {
      border-color: var(--accent-red);
      color: var(--accent-red);
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="doc-content">
      <div class="loading">
        <div class="spinner"></div>
        <div>Loading your document...</div>
      </div>
    </div>
  </div>
  
  <!-- Decline Modal -->
  <div id="decline-modal" class="modal-overlay hidden">
    <div class="modal">
      <div class="modal-header">Decline Quote</div>
      <div class="modal-body">
        <label for="decline-reason">Please let us know why (optional):</label>
        <textarea id="decline-reason" placeholder="e.g., Price too high, going with another company, project cancelled..."></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn btn-cancel" onclick="closeDeclineModal()">Cancel</button>
        <button class="btn btn-confirm-decline" id="btn-confirm-decline" onclick="confirmDecline()">Decline Quote</button>
      </div>
    </div>
  </div>
  
  <!-- Lightbox -->
  <div id="lightbox" class="lightbox hidden" onclick="closeLightbox()">
    <button class="lightbox-close" onclick="event.stopPropagation(); closeLightbox();">&times;</button>
    <img id="lightbox-img" src="" alt="Attachment" onclick="event.stopPropagation();">
  </div>

  <script>
    let currentDocument = null;
    let allDesignImages = [];
    let currentImageIndex = 0;
    const docId = '<?= docId ?>';
    
    // ========================================================================
    // INITIALIZATION
    // ========================================================================
    document.addEventListener('DOMContentLoaded', function() {
      if (docId) {
        loadDocument(docId);
      } else {
        showError('No document ID provided');
      }
    });
    
    function loadDocument(id) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.ok) {
            currentDocument = result.document;
            renderDocument();
            // Mark as viewed
            markViewed(id);
          } else {
            showError(result.error || 'Document not found');
          }
        })
        .withFailureHandler(function(error) {
          showError(error.toString());
        })
        .getDocumentById(id);
    }
    
    function markViewed(id) {
      google.script.run.markDocumentViewed(id);
    }
    
    // ========================================================================
    // RENDERING
    // ========================================================================
    function renderDocument() {
      const doc = currentDocument;
      const isQuote = doc.doc_type === 'quote';
      const isInvoice = doc.doc_type === 'invoice';
      
      // Determine status banner
      const status = (doc.status || 'Draft').toLowerCase();
      let statusMessage = '';
      let canRespond = false;
      let designApproved = false;
      
      if (isQuote) {
        switch (status) {
          case 'draft':
          case 'sent':
          case 'viewed':
            statusMessage = 'Awaiting Your Response';
            canRespond = true;
            break;
          case 'revision':
          case 'revision requested':
            statusMessage = 'Revision Requested - We\'ll update your design soon!';
            break;
          case 'design approved':
            statusMessage = 'Design Approved - Awaiting Final Approval';
            canRespond = true;
            designApproved = true;
            break;
          case 'approved':
            statusMessage = 'Quote Approved - Thank You!';
            designApproved = true;
            break;
          case 'declined':
            statusMessage = 'Quote Declined';
            break;
          case 'expired':
            statusMessage = 'Quote Expired';
            break;
        }
      } else if (isInvoice) {
        const balance = Number(doc.balance_due) || 0;
        switch (status) {
          case 'draft':
          case 'sent':
          case 'viewed':
            statusMessage = balance > 0 ? 'Payment Due' : 'Paid in Full';
            canRespond = balance > 0;
            break;
          case 'partial':
            statusMessage = 'Partial Payment Received';
            canRespond = balance > 0;
            break;
          case 'paid':
            statusMessage = 'Paid in Full - Thank You!';
            break;
          case 'overdue':
            statusMessage = 'Payment Overdue';
            canRespond = true;
            break;
          case 'void':
            statusMessage = 'Invoice Void';
            break;
        }
      }
      
      const statusBanner = statusMessage ? `
        <div class="status-banner ${status.replace(' ', '-')}">${statusMessage}</div>
      ` : '';
      
      // Parse send options if available
      let sendOptions = {};
      if (doc.send_options_json) {
        try {
          sendOptions = typeof doc.send_options_json === 'string' 
            ? JSON.parse(doc.send_options_json) 
            : doc.send_options_json;
        } catch(e) {}
      }
      const showLineAttachments = sendOptions.includeLineAttachments !== false;
      const showProjectAttachments = sendOptions.includeProjectAttachments === true;
      
      // Collect all design images for the hero section
      allDesignImages = [];
      
      // Add project files if enabled
      const projectFiles = doc.project_files || [];
      if (showProjectAttachments && projectFiles.length > 0) {
        projectFiles.forEach(file => {
          const url = file.url || '';
          const name = file.name || 'File';
          const isImage = /\.(jpg|jpeg|png|gif|webp|svg)$/i.test(name);
          if (isImage && url) {
            allDesignImages.push({ url: url, name: name, source: 'project' });
          }
        });
      }
      
      // Add line item attachments if enabled
      const lineItems = doc.line_items || [];
      if (showLineAttachments) {
        lineItems.forEach(item => {
          let attachments = [];
          if (item.attachments_json) {
            try {
              attachments = typeof item.attachments_json === 'string' 
                ? JSON.parse(item.attachments_json) 
                : item.attachments_json;
            } catch(e) {}
          }
          attachments.forEach(att => {
            const name = att.name || att.filename || att.file_name || 'File';
            const url = att.url || att.file_url || '';
            const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(name);
            if (isImage && url) {
              allDesignImages.push({ url: url, name: name, source: 'line-item' });
            }
          });
        });
      }
      
      // Build Design Hero Section (only if there are images)
      let designHeroHtml = '';
      if (allDesignImages.length > 0 && isQuote) {
        const mainImage = allDesignImages[0];
        
        // Build thumbnails
        let thumbsHtml = '';
        const maxThumbs = 4;
        const displayThumbs = allDesignImages.slice(0, maxThumbs);
        displayThumbs.forEach((img, i) => {
          thumbsHtml += `<img src="${img.url}" class="design-thumb ${i === 0 ? 'active' : ''}" onclick="selectDesignImage(${i})" title="${escapeHtml(img.name)}">`;
        });
        if (allDesignImages.length > maxThumbs) {
          thumbsHtml += `<div class="design-thumb-more" onclick="openLightbox('${allDesignImages[maxThumbs].url}')">+${allDesignImages.length - maxThumbs}</div>`;
        }
        
        // Determine design section state
        const isRevisionRequested = status === 'revision' || status === 'revision requested';
        const showDesignActions = canRespond && !designApproved && !isRevisionRequested;
        
        designHeroHtml = `
          <div class="design-hero">
            <div class="design-header">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
              Your Design
            </div>
            <div class="design-gallery">
              <img id="design-main-image" src="${mainImage.url}" class="design-main-image" onclick="openLightbox('${mainImage.url}')" title="${escapeHtml(mainImage.name)}">
              <div class="tap-hint">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"></path></svg>
                Tap to enlarge
              </div>
              ${allDesignImages.length > 1 ? `<div class="design-thumbnails">${thumbsHtml}</div>` : ''}
            </div>
            ${showDesignActions ? `
            <div class="design-actions" id="design-actions">
              <button class="btn-design btn-revision" onclick="showRevisionPanel()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                Request Revision
              </button>
              <button class="btn-design btn-love" onclick="approveDesign()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                Love It!
              </button>
            </div>
            <div class="revision-panel" id="revision-panel">
              <div class="revision-box">
                <div class="revision-title">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                  Request Changes
                </div>
                <div class="revision-subtitle">Tell us what you'd like adjusted and we'll send you an updated design.</div>
                <textarea id="revision-textarea" class="revision-textarea" placeholder="Example: Can we try a matte finish instead of gloss? Also, can the logo on the hood be about 20% larger?"></textarea>
                <div class="revision-actions">
                  <button class="btn-cancel-revision" onclick="hideRevisionPanel()">Cancel</button>
                  <button class="btn-submit-revision" id="btn-submit-revision" onclick="submitRevisionRequest()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    Send Request
                  </button>
                </div>
              </div>
            </div>
            ` : ''}
            ${designApproved ? `
            <div class="design-approved-badge">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
              Design Approved
              <button onclick="undoDesignApproval()" style="margin-left: 12px; background: transparent; border: 1px solid var(--accent-green); color: var(--accent-green); padding: 4px 10px; border-radius: 4px; font-size: 12px; cursor: pointer;">Change Mind?</button>
            </div>
            ` : ''}
            ${isRevisionRequested ? `
            <div class="design-approved-badge" style="background: rgba(234, 179, 8, 0.1); border-color: rgba(234, 179, 8, 0.3); color: var(--accent-yellow);">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
              Revision in Progress
            </div>
            ` : ''}
          </div>
        `;
      }
      
      // Build line items HTML (without images since they're in the hero now)
      let lineItemsHtml = '';
      if (lineItems.length > 0) {
        lineItems.forEach(item => {
          const qty = Number(item.quantity) || 1;
          const price = Number(item.unit_price) || 0;
          const total = Number(item.line_total) || (qty * price);
          
          lineItemsHtml += `
            <div class="line-item">
              <div class="line-item-desc">
                <div class="line-item-name">${escapeHtml(item.description || 'Service')}</div>
                <div class="line-item-details">${qty > 1 ? qty + ' × $' + price.toLocaleString() : ''}</div>
              </div>
              <div class="line-item-total">$${total.toLocaleString()}</div>
            </div>
          `;
        });
      } else {
        lineItemsHtml = '<div style="color: var(--text-muted); text-align: center; padding: 20px;">No line items</div>';
      }
      
      // Valid until / Due date
      let dateNotice = '';
      if (isQuote && doc.valid_until) {
        const validDate = formatDate(doc.valid_until);
        dateNotice = `<div class="date-notice">Quote valid until ${validDate}</div>`;
      } else if (isInvoice && doc.due_date) {
        const dueDate = formatDate(doc.due_date);
        dateNotice = `<div class="date-notice">Payment due by ${dueDate}</div>`;
      }
      
      // Payment history for invoices
      let paymentHistoryHtml = '';
      if (isInvoice && doc.payments && doc.payments.length > 0) {
        let paymentsListHtml = '';
        doc.payments.forEach(p => {
          paymentsListHtml += `
            <div class="payment-item">
              <div class="payment-info">
                <div class="payment-amount">$${Number(p.amount).toLocaleString()}</div>
                <div class="payment-method">${p.method || 'Payment'}</div>
              </div>
              <div class="payment-date">${formatDate(p.date || p.paid_at)}</div>
            </div>
          `;
        });
        
        paymentHistoryHtml = `
          <div class="section">
            <div class="section-header"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="margin-right:8px;"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>Payment History</div>
            <div class="section-body">
              <div class="payment-list">${paymentsListHtml}</div>
            </div>
          </div>
        `;
      }
      
      // Action buttons for quotes (Approve/Decline at bottom)
      let quoteActionsHtml = '';
      if (isQuote && canRespond) {
        quoteActionsHtml = `
          <div class="actions">
            <button class="btn btn-decline" onclick="openDeclineModal()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
              Decline
            </button>
            <button class="btn btn-approve" id="btn-approve" onclick="approveQuote()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><polyline points="20 6 9 17 4 12"></polyline></svg>
              Approve & Pay Deposit
            </button>
          </div>
        `;
      }
      
      // Invoice payment section
      let invoicePaymentHtml = '';
      if (isInvoice && canRespond) {
        const depositRequired = Number(doc.deposit_required) || 0;
        const fullBalance = Number(doc.balance_due) || 0;
        const paymentDue = depositRequired > 0 ? depositRequired : fullBalance;
        const isPartialPayment = depositRequired > 0 && depositRequired < fullBalance;
        
        const feePercent = 0.029;
        const feeFixed = 0.30;
        const processingFee = (paymentDue * feePercent) + feeFixed;
        const processingFeeRounded = Math.round(processingFee * 100) / 100;
        const totalWithFee = paymentDue + processingFeeRounded;
        
        const paymentLabel = isPartialPayment ? 'Deposit Amount' : 'Invoice Amount';
        
        invoicePaymentHtml = `
          <div class="stripe-section">
            <div class="stripe-title">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
              Pay with Card
            </div>
            <div style="background: var(--bg-surface); border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 14px;">
              ${isPartialPayment ? `
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: var(--text-muted);">
                <span>Invoice Total</span>
                <span>$${fullBalance.toLocaleString(undefined, {minimumFractionDigits: 2})}</span>
              </div>
              ` : ''}
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>${paymentLabel}</span>
                <span>$${paymentDue.toLocaleString(undefined, {minimumFractionDigits: 2})}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: var(--text-muted);">
                <span>Processing Fee (2.9% + $0.30)</span>
                <span>$${processingFeeRounded.toFixed(2)}</span>
              </div>
              <div style="display: flex; justify-content: space-between; font-weight: 600; padding-top: 8px; border-top: 1px solid var(--border-color);">
                <span>Total</span>
                <span>$${totalWithFee.toFixed(2)}</span>
              </div>
            </div>
            <div class="card-element-container">
              <div id="card-element"></div>
            </div>
            <div id="card-errors" class="card-errors"></div>
            <button id="stripe-pay-btn" class="btn-stripe" onclick="processStripePayment()">
              Pay $${totalWithFee.toFixed(2)}
            </button>
            <div id="stripe-processing" class="stripe-processing">
              <div class="stripe-spinner"></div>
              <div>Processing payment...</div>
            </div>
            <div class="powered-stripe">Powered by Stripe</div>
          </div>
          <div class="pay-divider"><span>or</span></div>
          <div style="text-align: center; font-size: 13px; color: var(--text-muted);">
            Pay by phone: <a href="tel:+12406933715" style="color: var(--fwg-primary);">(240) 693-3715</a>
            &nbsp;•&nbsp; Zelle: info@frederickwraps.com
          </div>
        `;
      }
      
      // Balance due display
      const balanceDue = Number(doc.balance_due) || 0;
      const depositRequired = Number(doc.deposit_required) || 0;
      const isPartialPayment = depositRequired > 0 && depositRequired < balanceDue;
      
      // Build full HTML
      const html = `
        <!-- Header -->
        <div class="doc-header">
          <div class="company-logo"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48"><path d="M7 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path><path d="M17 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path><path d="M5 17h-2v-6l2 -5h9l4 5h1a2 2 0 0 1 2 2v4h-2m-4 0h-6m-6 -6h15m-6 0v-5"></path></svg></div>
          <div class="company-name">Frederick Wraps & Graphics</div>
          <div class="company-tagline">Professional Vehicle Wraps & Graphics</div>
          <div class="doc-title">Your ${isQuote ? 'Quote' : 'Invoice'}</div>
          <div class="doc-number">${isQuote ? 'Quote' : 'Invoice'} #${doc.doc_id}</div>
        </div>
        
        ${statusBanner}
        
        ${designHeroHtml}
        
        <!-- Project Details -->
        <div class="section">
          <div class="section-header"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="margin-right:8px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>${isQuote ? 'Project' : 'Invoice'} Details</div>
          <div class="section-body">
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">${isQuote ? 'Prepared For' : 'Bill To'}</div>
                <div class="info-value">${escapeHtml(doc.customer_name) || '-'}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Company</div>
                <div class="info-value">${escapeHtml(doc.company_name) || '-'}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Vehicle</div>
                <div class="info-value">${escapeHtml(doc.vehicle_description) || '-'}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Project Type</div>
                <div class="info-value">${escapeHtml(doc.project_description) || '-'}</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Line Items & Pricing -->
        <div class="section">
          <div class="section-header"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="margin-right:8px;"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>Pricing</div>
          <div class="section-body">
            <div class="line-items">${lineItemsHtml}</div>
            
            <div class="totals">
              <div class="total-row">
                <span class="total-label">Subtotal</span>
                <span>$${Number(doc.subtotal || 0).toLocaleString()}</span>
              </div>
              ${Number(doc.discount_amount) > 0 ? `
              <div class="total-row">
                <span class="total-label">Discount${doc.discount_note ? ' (' + escapeHtml(doc.discount_note) + ')' : ''}</span>
                <span style="color: var(--accent-green);">-$${Number(doc.discount_amount).toLocaleString()}</span>
              </div>
              ` : ''}
              ${Number(doc.tax_amount) > 0 ? `
              <div class="total-row">
                <span class="total-label">Tax</span>
                <span>$${Number(doc.tax_amount).toLocaleString()}</span>
              </div>
              ` : ''}
              <div class="total-row grand-total">
                <span>Total</span>
                <span>$${Number(doc.total || 0).toLocaleString()}</span>
              </div>
              ${isQuote ? `
                ${isPartialPayment ? `
                <div class="total-row balance-muted">
                  <span>Balance Due</span>
                  <span>$${balanceDue.toLocaleString()}</span>
                </div>
                <div class="total-row amount-due-proceed">
                  <span>Amount Due to Proceed</span>
                  <span>$${depositRequired.toLocaleString()}</span>
                </div>
                ` : `
                ${depositRequired > 0 ? `
                <div class="total-row deposit">
                  <span class="total-label">Deposit Required to Start</span>
                  <span>$${depositRequired.toLocaleString()}</span>
                </div>
                ` : ''}
                `}
              ` : ''}
              ${isInvoice ? `
              ${Number(doc.amount_paid) > 0 ? `
              <div class="total-row paid">
                <span class="total-label">Amount Paid</span>
                <span>$${Number(doc.amount_paid).toLocaleString()}</span>
              </div>
              ` : ''}
              ${isPartialPayment ? `
              <div class="total-row balance-muted">
                <span>Balance Due</span>
                <span>$${balanceDue.toLocaleString()}</span>
              </div>
              <div class="total-row amount-due-proceed">
                <span>Amount Due to Proceed</span>
                <span>$${depositRequired.toLocaleString()}</span>
              </div>
              ` : `
              <div class="total-row balance ${balanceDue > 0 ? 'due' : 'zero'}">
                <span>Balance Due</span>
                <span>$${balanceDue.toLocaleString()}</span>
              </div>
              `}
              ` : ''}
            </div>
            
            ${dateNotice}
          </div>
        </div>
        
        ${paymentHistoryHtml}
        
        ${doc.notes ? `
        <!-- Notes -->
        <div class="section">
          <div class="section-header"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="margin-right:8px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>Notes</div>
          <div class="section-body">
            <p style="white-space: pre-wrap; color: var(--text-secondary);">${escapeHtml(doc.notes)}</p>
          </div>
        </div>
        ` : ''}
        
        ${quoteActionsHtml}
        ${invoicePaymentHtml}
        
        <!-- Contact -->
        <div class="contact-section">
          <div class="contact-title">Questions?</div>
          <div class="contact-info">
            <span><a href="tel:+12406933715">(240) 693-3715</a></span>
            <span><a href="mailto:info@frederickwraps.com">info@frederickwraps.com</a></span>
          </div>
        </div>
      `;
      
      document.getElementById('doc-content').innerHTML = html;
      
      // Initialize Stripe if this is an unpaid invoice
      if (currentDocument.doc_type === 'invoice' && Number(currentDocument.balance_due) > 0) {
        setTimeout(initStripeAfterRender, 100);
      }
    }
    
    function showError(message) {
      document.getElementById('doc-content').innerHTML = `
        <div class="error-state">
          <div class="error-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="48" height="48"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg></div>
          <div class="error-title">Unable to Load Document</div>
          <div class="error-message">${escapeHtml(message)}</div>
        </div>
        <div class="contact-section" style="margin-top: 24px;">
          <div class="contact-title">Need Help?</div>
          <div class="contact-info">
            <span><a href="tel:+12406933715">(240) 693-3715</a></span>
            <span><a href="mailto:info@frederickwraps.com">info@frederickwraps.com</a></span>
          </div>
        </div>
      `;
    }
    
    // ========================================================================
    // DESIGN HERO FUNCTIONS
    // ========================================================================
    function selectDesignImage(index) {
      if (index >= 0 && index < allDesignImages.length) {
        currentImageIndex = index;
        const mainImg = document.getElementById('design-main-image');
        if (mainImg) {
          mainImg.src = allDesignImages[index].url;
          mainImg.onclick = function() { openLightbox(allDesignImages[index].url); };
        }
        // Update active thumbnail
        document.querySelectorAll('.design-thumb').forEach((thumb, i) => {
          thumb.classList.toggle('active', i === index);
        });
      }
    }
    
    function showRevisionPanel() {
      const actions = document.getElementById('design-actions');
      const panel = document.getElementById('revision-panel');
      if (actions) actions.classList.add('hidden');
      if (panel) panel.classList.add('active');
    }
    
    function hideRevisionPanel() {
      const actions = document.getElementById('design-actions');
      const panel = document.getElementById('revision-panel');
      if (actions) actions.classList.remove('hidden');
      if (panel) panel.classList.remove('active');
    }
    
    /**
 * Submit a revision request from customer
 */
function submitRevisionRequest(docId, message) {
  try {
    const ss = SpreadsheetApp.openById(CONFIG.opsSheetId);
    
    // Update document status and save revision notes
    const docsSheet = ss.getSheetByName('Documents');
    const docsData = docsSheet.getDataRange().getValues();
    const docsHeaders = docsData[0];
    const docIdCol = docsHeaders.indexOf('doc_id');
    const statusCol = docsHeaders.indexOf('status');
    const notesCol = docsHeaders.indexOf('notes');
    
    Logger.log('Column indexes - docId: ' + docIdCol + ', status: ' + statusCol + ', notes: ' + notesCol);
    
    let docRow = -1;
    let customerPhone = '';
    let customerName = '';
    let existingNotes = '';
    
    for (let i = 1; i < docsData.length; i++) {
      if (String(docsData[i][docIdCol]) === String(docId)) {
        docRow = i + 1;
        customerPhone = docsData[i][docsHeaders.indexOf('customer_phone')] || '';
        customerName = docsData[i][docsHeaders.indexOf('customer_name')] || '';
        existingNotes = docsData[i][notesCol] || '';
        break;
      }
    }
    
    Logger.log('Found docRow: ' + docRow + ', customerName: ' + customerName);
    
    if (docRow === -1) {
      return { ok: false, error: 'Document not found' };
    }
    
    // Update status to "Revision Requested"
    Logger.log('Setting status at row ' + docRow + ', col ' + (statusCol + 1));
    docsSheet.getRange(docRow, statusCol + 1).setValue('Revision Requested');
    
    // Prepend revision request to notes with timestamp
    const timestamp = new Date().toLocaleString();
    const revisionNote = '** REVISION REQUEST (' + timestamp + ') **\n' + message;
    const updatedNotes = existingNotes ? revisionNote + '\n\n---\n\n' + existingNotes : revisionNote;
    
    Logger.log('Setting notes at row ' + docRow + ', col ' + (notesCol + 1));
    Logger.log('Notes content: ' + updatedNotes.substring(0, 100));
    docsSheet.getRange(docRow, notesCol + 1).setValue(updatedNotes);
    
    // Save to Messages sheet for history
    const messagesSheet = ss.getSheetByName('Messages');
    const messageId = 'MSG-' + Date.now();
    const isoTimestamp = new Date().toISOString();
    
    messagesSheet.appendRow([
      messageId,
      isoTimestamp,
      'inbound',
      'web',
      customerPhone,
      '',
      customerName,
      '',
      docId,
      '',
      'REVISION REQUEST: ' + message,
      '',
      'received',
      'FALSE',
      'FALSE'
    ]);
    
    // Send SMS notification
    try {
      const notifyMessage = 'Revision request for Quote #' + docId + ' from ' + customerName + ': ' + message.substring(0, 100) + (message.length > 100 ? '...' : '');
      sendSMS('+12406933715', notifyMessage);
    } catch (smsError) {
      Logger.log('SMS notification failed: ' + smsError.toString());
    }
    
    return { ok: true };
  } catch (e) {
    Logger.log('submitRevisionRequest error: ' + e.toString());
    return { ok: false, error: e.toString() };
  }
}
    
    function approveDesign() {
      const btn = document.querySelector('.btn-love');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = 'Saving...';
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.ok) {
            showToast('Design approved! Now let\'s finalize your quote.', 'success');
            setTimeout(() => {
              loadDocument(docId);
            }, 1500);
          } else {
            if (btn) {
              btn.disabled = false;
              btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg> Love It!';
            }
            showToast('Error: ' + (result.error || 'Failed to save'), 'error');
          }
        })
        .withFailureHandler(function(error) {
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg> Love It!';
          }
          showToast('Error: ' + error, 'error');
        })
        .updateDocumentStatus(docId, 'Design Approved');
    }

    function undoDesignApproval() {
      if (!confirm('This will reset the design approval. Continue?')) return;
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.ok) {
            showToast('Design approval reset.', 'success');
            setTimeout(() => {
              loadDocument(docId);
            }, 1000);
          } else {
            showToast('Error: ' + (result.error || 'Failed'), 'error');
          }
        })
        .withFailureHandler(function(error) {
          showToast('Error: ' + error, 'error');
        })
        .updateDocumentStatus(docId, 'Sent');
    }
    
    // ========================================================================
    // QUOTE ACTIONS
    // ========================================================================
    function approveQuote() {
      const btn = document.getElementById('btn-approve');
      btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="animation: spin 0.8s linear infinite;"><circle cx="12" cy="12" r="10"></circle></svg> Processing...';
      btn.classList.add('btn-loading');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.ok) {
            showToast('Quote approved! We\'ll be in touch soon.', 'success');
            setTimeout(() => {
              loadDocument(docId);
            }, 1500);
          } else {
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><polyline points="20 6 9 17 4 12"></polyline></svg> Approve & Pay Deposit';
            btn.classList.remove('btn-loading');
            showToast('Error: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><polyline points="20 6 9 17 4 12"></polyline></svg> Approve & Pay Deposit';
          btn.classList.remove('btn-loading');
          showToast('Error: ' + error, 'error');
        })
        .updateDocumentStatus(docId, 'Approved');
    }
    
    function openDeclineModal() {
      document.getElementById('decline-modal').classList.remove('hidden');
      document.getElementById('decline-reason').value = '';
    }
    
    function closeDeclineModal() {
      document.getElementById('decline-modal').classList.add('hidden');
    }
    
    function confirmDecline() {
      const reason = document.getElementById('decline-reason').value.trim();
      const btn = document.getElementById('btn-confirm-decline');
      btn.innerHTML = 'Processing...';
      btn.classList.add('btn-loading');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.ok) {
            closeDeclineModal();
            showToast('Quote declined.', 'success');
            setTimeout(() => {
              loadDocument(docId);
            }, 1500);
          } else {
            btn.innerHTML = 'Decline Quote';
            btn.classList.remove('btn-loading');
            showToast('Error: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          btn.innerHTML = 'Decline Quote';
          btn.classList.remove('btn-loading');
          showToast('Error: ' + error, 'error');
        })
        .declineDocument(docId, reason);
    }
    
    // ========================================================================
    // STRIPE PAYMENT
    // ========================================================================
    let stripe = null;
    let cardElement = null;
    let paymentIntentClientSecret = null;
    
    function initStripeAfterRender() {
      const cardContainer = document.getElementById('card-element');
      if (!cardContainer || stripe) return;
      
      // Get public key and initialize
      google.script.run
        .withSuccessHandler(function(config) {
          if (config && config.publicKey) {
            stripe = Stripe(config.publicKey);
            const elements = stripe.elements();
            
            cardElement = elements.create('card', {
              style: {
                base: {
                  fontSize: '16px',
                  fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                  color: '#333',
                  '::placeholder': { color: '#aab7c4' }
                },
                invalid: { color: '#dc3545', iconColor: '#dc3545' }
              }
            });
            
            cardElement.mount('#card-element');
            
            cardElement.on('change', function(event) {
              const errorDiv = document.getElementById('card-errors');
              if (event.error) {
                errorDiv.textContent = event.error.message;
                errorDiv.style.display = 'block';
              } else {
                errorDiv.style.display = 'none';
              }
            });
          }
        })
        .getStripeConfig();
    }
    
    function processStripePayment() {
      const payBtn = document.getElementById('stripe-pay-btn');
      const processing = document.getElementById('stripe-processing');
      const errorDiv = document.getElementById('card-errors');
      
      payBtn.disabled = true;
      payBtn.style.display = 'none';
      processing.style.display = 'block';
      errorDiv.style.display = 'none';
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.ok) {
            paymentIntentClientSecret = result.clientSecret;
            confirmStripePayment();
          } else {
            showStripeError(result.error || 'Failed to initialize payment');
          }
        })
        .withFailureHandler(function(error) {
          showStripeError(error.message || 'Payment server error');
        })
        .createStripePaymentIntent(
          currentDocument.doc_id,
          currentDocument.balance_due,
          currentDocument.customer_email,
          currentDocument.customer_name
        );
    }
    
    function confirmStripePayment() {
      stripe.confirmCardPayment(paymentIntentClientSecret, {
        payment_method: { card: cardElement }
      }).then(function(result) {
        if (result.error) {
          showStripeError(result.error.message);
        } else if (result.paymentIntent.status === 'succeeded') {
          showPaymentSuccess();
        }
      });
    }
    
    function showStripeError(message) {
      const payBtn = document.getElementById('stripe-pay-btn');
      const processing = document.getElementById('stripe-processing');
      const errorDiv = document.getElementById('card-errors');
      
      payBtn.disabled = false;
      payBtn.style.display = 'block';
      processing.style.display = 'none';
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }
    
    function showPaymentSuccess() {
      const section = document.querySelector('.stripe-section');
      section.innerHTML = `
        <div style="text-align: center; padding: 24px;">
          <div style="margin-bottom: 16px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent-green)" stroke-width="2" width="48" height="48">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
          </div>
          <div style="font-size: 18px; font-weight: 600; color: var(--accent-green); margin-bottom: 8px;">Payment Successful!</div>
          <div style="color: var(--text-secondary); margin-bottom: 12px;">Thank you for your payment!</div>
          <div style="color: var(--text-muted); font-size: 14px;">You'll receive a confirmation text/email shortly with a link to your paid invoice.</div>
        </div>
      `;
    }
    
    // ========================================================================
    // UTILITIES
    // ========================================================================
    function openLightbox(url) {
      document.getElementById('lightbox-img').src = url;
      document.getElementById('lightbox').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
    
    function closeLightbox() {
      document.getElementById('lightbox').classList.add('hidden');
      document.body.style.overflow = '';
    }
    
    function showToast(message, type) {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();
      
      const toast = document.createElement('div');
      toast.className = 'toast ' + (type || '');
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.remove(), 4000);
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return '';
      try {
        const d = new Date(dateStr);
        return d.toLocaleDateString('en-US', { 
          month: 'long', 
          day: 'numeric', 
          year: 'numeric' 
        });
      } catch (e) {
        return dateStr;
      }
    }
    
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
    
    // Close modal on overlay click
    document.getElementById('decline-modal').addEventListener('click', function(e) {
      if (e.target === this) closeDeclineModal();
    });
    
    // Close lightbox on Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeLightbox();
        closeDeclineModal();
      }
    });
  </script>

</body>
</html>