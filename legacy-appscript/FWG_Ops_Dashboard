<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FWG Operations Dashboard</title>
  
  <style>
    /* ========================================================================
       CSS VARIABLES & RESET
       ======================================================================== */
    :root {
      --bg-dark: #282a30;
      --bg-surface: #111111;
      --bg-elevated: #1d1d1d;
      --border-color: rgba(148, 163, 184, 0.2);
      --border-hover: rgba(148, 163, 184, 0.4);
      
      --text-primary: #f1f5f9;
      --text-secondary: #51a8f1;
      --text-muted: #64748b;
      
      --accent-blue: #3b82f6;
      --accent-green: #22c55e;
      --accent-yellow: #eab308;
      --accent-red: #ef4444;
      --accent-purple: #a855f7;
      --accent-orange: #d71cd1;
      
      --fwg-primary: #d71cd1;
      --fwg-primary-soft: rgba(215, 28, 209, 0.15);
      
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
      --shadow-lg: 0 12px 40px rgba(0,0,0,0.5);
      
      --sidebar-width: 240px;
      --header-height: 60px;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    /* ========================================================================
       LAYOUT
       ======================================================================== */
    .app-container {
      display: flex;
      min-height: 100vh;
    }
    
    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: #111111;
      border-right: 1px solid rgba(255,255,255,0.08);
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      z-index: 100;
      transition: transform 0.3s ease;
    }
    
    .sidebar-header {
      padding: 24px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    
    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .sidebar-logo-icon {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, #06b6d4, #ec4899);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .sidebar-logo-icon svg {
      width: 26px;
      height: 26px;
      color: white;
    }
    
    .sidebar-logo-text {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .sidebar-logo-text .gradient {
      background: linear-gradient(90deg, #22d3ee, #a855f7, #ec4899);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .sidebar-logo-sub {
      font-size: 11px;
      color: #6b7280;
      letter-spacing: 0.5px;
    }
    
    .sidebar-nav {
      flex: 1;
      padding: 16px 0;
      overflow-y: auto;
    }
    
    .nav-section {
      margin-bottom: 8px;
    }
    
    .nav-section-title {
      font-size: 11px;
      font-weight: 600;
      color: #4b5563;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      padding: 16px 20px 10px;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s ease;
      border-left: 3px solid transparent;
    }
    
    .nav-item:hover {
      background: rgba(255,255,255,0.04);
    }
    
    .nav-item.active {
      background: rgba(6, 182, 212, 0.1);
      border-left-color: #06b6d4;
    }
    
    .nav-item-icon {
      width: 20px;
      height: 20px;
      color: #6b7280;
      flex-shrink: 0;
    }
    
    .nav-item.active .nav-item-icon {
      color: #22d3ee;
    }
    
    .nav-item-label {
      font-size: 14px;
      font-weight: 500;
      color: #e5e7eb;
    }
    
    .nav-item-label .gradient {
      background: linear-gradient(90deg, #22d3ee, #a855f7, #ec4899);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .nav-item-badge {
      margin-left: auto;
      background: linear-gradient(90deg, #06b6d4, #ec4899);
      color: white;
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
      min-width: 20px;
      text-align: center;
    }
    
    .nav-item-badge.gray {
      background: #374151;
    }
    
    .nav-item.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .nav-item.disabled:hover {
      background: transparent;
    }

     /* ========================================================================
       PRODUCTION FLOW - NEW DESIGN WITH LIGHTBAR
       ======================================================================== */
    .production-container {
      padding: 0;
    }
    
    .production-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .production-header-left h2 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .production-header-left h2 span {
      background: linear-gradient(135deg, #22d3ee, #a855f7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .production-header-left p {
      color: var(--text-muted);
      font-size: 14px;
    }
    
    .production-stats {
      display: flex;
      gap: 32px;
    }
    
    .production-stat {
      text-align: center;
    }
    
    .production-stat-value {
      font-size: 32px;
      font-weight: 700;
      font-family: 'Courier New', monospace;
      background: linear-gradient(135deg, #ec4899, #a855f7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .production-stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1.5px;
    }
    
    .production-filters {
      display: flex;
      gap: 12px;
      align-items: center;
      width: 100%;
      margin-top: 8px;
    }
    
    .production-search {
      padding: 10px 14px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 14px;
      flex: 1;
      max-width: 300px;
    }
    
    .production-search::placeholder {
      color: var(--text-muted);
    }
    
    .production-filter-select {
      padding: 10px 14px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 14px;
    }
    
    .production-queue {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    
    .svg-defs {
      position: absolute;
      width: 0;
      height: 0;
    }
    
    .production-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .production-card:hover {
      border-color: rgba(34, 211, 238, 0.3);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    
    .production-card-header {
      display: flex;
      align-items: center;
      padding: 24px;
      gap: 24px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
    }
    
    .production-card-header:hover {
      background: var(--bg-elevated);
    }
    
    .progress-ring {
      position: relative;
      width: 72px;
      height: 72px;
      flex-shrink: 0;
    }
    
    .progress-ring svg {
      transform: rotate(-90deg);
    }
    
    .progress-ring-bg {
      fill: none;
      stroke: #27272a;
      stroke-width: 6;
    }
    
    .progress-ring-fill {
      fill: none;
      stroke: url(#ringGradient);
      stroke-width: 6;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.6s ease;
    }
    
    .progress-ring-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 15px;
      font-weight: 700;
      font-family: 'Courier New', monospace;
      color: var(--text-primary);
    }
    
    .production-card-info {
      flex: 1;
    }
    
    .production-card-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    
    .production-card-meta {
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .production-card-meta .job-id {
      font-family: 'Courier New', monospace;
      color: #22d3ee;
    }
    
    .production-card-right {
      text-align: right;
    }
    
    .production-card-amount {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent-green);
      margin-bottom: 4px;
    }
    
    .production-card-category {
      font-size: 12px;
      color: #a855f7;
      background: rgba(168, 85, 247, 0.15);
      padding: 4px 12px;
      border-radius: 20px;
      display: inline-block;
    }
    
    .pipeline-section {
      padding: 24px;
      background: var(--bg-elevated);
    }
    
    .pipeline {
      display: flex;
      align-items: center;
      position: relative;
      padding: 0 10px;
    }
    
    .pipeline-track {
      position: absolute;
      top: 50%;
      left: 20px;
      right: 20px;
      height: 4px;
      background: #27272a;
      border-radius: 2px;
      transform: translateY(-50%);
      z-index: 0;
    }
    
    .pipeline-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: linear-gradient(90deg, #22d3ee, #a855f7);
      border-radius: 2px;
      transition: width 0.6s ease;
      box-shadow: 0 0 20px rgba(34, 211, 238, 0.4);
    }
    
    .pipeline-step {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 1;
    }
    
    .step-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--bg-surface);
      border: 3px solid #27272a;
      transition: all 0.3s ease;
    }
    
    .step-dot.done {
      background: var(--accent-green);
      border-color: var(--accent-green);
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.5);
    }
    
    .step-dot.active {
      border-color: #22d3ee;
      box-shadow: 0 0 12px rgba(34, 211, 238, 0.4);
    }
    
    .step-label {
      margin-top: 10px;
      font-size: 10px;
      color: var(--text-muted);
      text-align: center;
      max-width: 70px;
      line-height: 1.3;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .step-label.done {
      color: var(--accent-green);
    }
    
    .step-label.active {
      color: #22d3ee;
      font-weight: 600;
    }
    
    .task-section {
      padding: 20px 24px;
    }
    
    .production-task {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 14px 0;
      border-bottom: 1px solid var(--border-color);
      transition: background 0.2s;
    }
    
    .production-task:last-child {
      border-bottom: none;
    }
    
    .production-task:hover {
      background: rgba(255,255,255,0.02);
      margin: 0 -24px;
      padding-left: 24px;
      padding-right: 24px;
    }
    
    .production-task-checkbox {
      width: 24px;
      height: 24px;
      border-radius: 8px;
      border: 2px solid var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      flex-shrink: 0;
      background: transparent;
    }
    
    .production-task-checkbox:hover {
      border-color: #22d3ee;
      background: rgba(34, 211, 238, 0.1);
    }
    
    .production-task-checkbox.checked {
      background: var(--accent-green);
      border-color: var(--accent-green);
    }
    
    .production-task-checkbox svg {
      width: 14px;
      height: 14px;
      color: white;
      opacity: 0;
      transform: scale(0.5);
      transition: all 0.2s ease;
    }
    
    .production-task-checkbox.checked svg {
      opacity: 1;
      transform: scale(1);
    }
    
    .production-task-content {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .production-task-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }
    
    .production-task.completed .production-task-name {
      text-decoration: line-through;
      color: var(--text-muted);
    }
    
    .production-task-badge {
      font-size: 9px;
      padding: 3px 8px;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    
    .production-task-badge.auto {
      background: rgba(168, 85, 247, 0.15);
      color: #a855f7;
    }
    
    .production-task-badge.next {
      background: rgba(34, 211, 238, 0.15);
      color: #22d3ee;
    }
    
    .production-task-meta {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .expand-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      color: var(--text-muted);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      border-top: 1px solid var(--border-color);
    }
    
    .expand-toggle:hover {
      color: #22d3ee;
      background: rgba(34, 211, 238, 0.05);
    }
    
    .expand-toggle svg {
      width: 18px;
      height: 18px;
      transition: transform 0.3s ease;
    }
    
    .expand-toggle.expanded svg {
      transform: rotate(180deg);
    }
    
    .production-task.hidden-task {
      display: none;
    }
    
    .task-section.expanded .production-task.hidden-task {
      display: flex;
    }
    
    .production-empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
    
    .production-empty svg {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      color: var(--accent-green);
    }
    
    .nav-item-badge.yellow {
      background: var(--accent-yellow);
      color: #000;
    }
    
    .sidebar-footer {
      padding: 16px 20px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }
    
    .plan-badge {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .plan-status {
      width: 8px;
      height: 8px;
      background: #22d3ee;
      border-radius: 50%;
      box-shadow: 0 0 8px #22d3ee;
    }
    
    .plan-text {
      font-size: 13px;
      color: #9ca3af;
    }
    
    .plan-text strong {
      color: #ffffff;
    }
    
    .nav-item-label {
      font-size: 14px;
      font-weight: 500;
    }
    
    .nav-item-badge {
      margin-left: auto;
      background: var(--accent-red);
      color: white;
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 999px;
      min-width: 20px;
      text-align: center;
    }
    
    .nav-item-badge.green {
      background: var(--accent-green);
    }
    
    .nav-item-badge.yellow {
      background: var(--accent-yellow);
      color: #000;
    }
    
    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* Header */
    .header {
      height: var(--header-height);
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      position: sticky;
      top: 0;
      z-index: 50;
    }
    
    .header-title {
      font-size: 20px;
      font-weight: 600;
    }
    
    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    /* Content Area */
    .content {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
    }

    /* Archive Button */
    .archive-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--accent-green);
      color: #000;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-left: auto;
    }
    
    .archive-btn:hover {
      background: #16a34a;
      transform: scale(1.02);
    }
    
    /* ========================================================================
       COMPONENTS
       ======================================================================== */
    
    /* Cards */
    .card {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }
    
    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .card-title {
      font-size: 16px;
      font-weight: 600;
    }
    
    .card-body {
      padding: 20px;
    }
    
    /* Summary Cards */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .summary-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 20px;
      display: flex;
      align-items: flex-start;
      gap: 16px;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .summary-card:hover {
      border-color: var(--fwg-primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .summary-card-icon {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .summary-card-icon svg {
      width: 24px;
      height: 24px;
    }
    
    .summary-card-icon.blue { background: rgba(59, 130, 246, 0.15); }
    .summary-card-icon.blue svg { color: #3b82f6; }
    .summary-card-icon.green { background: rgba(34, 197, 94, 0.15); }
    .summary-card-icon.green svg { color: #22c55e; }
    .summary-card-icon.yellow { background: rgba(234, 179, 8, 0.15); }
    .summary-card-icon.yellow svg { color: #eab308; }
    .summary-card-icon.red { background: rgba(239, 68, 68, 0.15); }
    .summary-card-icon.red svg { color: #ef4444; }
    .summary-card-icon.purple { background: rgba(168, 85, 247, 0.15); }
    .summary-card-icon.purple svg { color: #a855f7; }
    .summary-card-icon.cyan { background: rgba(34, 211, 238, 0.15); }
    .summary-card-icon.cyan svg { color: #22d3ee; }
    .summary-card-icon.pink { background: rgba(215, 28, 209, 0.15); }
    .summary-card-icon.pink svg { color: #d71cd1; }
    
    .summary-card-content {
      flex: 1;
    }
    
    .summary-card-value {
      font-size: 28px;
      font-weight: 700;
      line-height: 1;
      margin-bottom: 4px;
    }
    
    .summary-card-label {
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    /* Command Center Layout */
    /* ========================================================================
       PRIORITY QUEUE (ACTION CENTER)
       ======================================================================== */
    .priority-queue-section {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      margin-bottom: 20px;
    }
    
    .pq-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .pq-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 16px;
      font-weight: 600;
    }
    
    .pq-title-icon {
      width: 20px;
      height: 20px;
      color: var(--accent-orange);
    }
    
    .priority-queue {
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .priority-queue:empty::after {
      content: 'No action items - you are all caught up!';
      color: var(--text-muted);
      text-align: center;
      padding: 40px 20px;
    }
    
    /* Priority Queue Item */
    .pq-item {
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .pq-item:hover {
      border-color: var(--fwg-primary);
      transform: translateX(4px);
    }
    
    .pq-rank {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 13px;
      flex-shrink: 0;
      background: var(--bg-dark);
      color: var(--text-secondary);
    }
    
    .pq-rank.urgent {
      background: linear-gradient(135deg, var(--accent-orange), var(--accent-red));
      color: white;
    }
    
    .pq-content {
      flex: 1;
      min-width: 0;
    }
    
    .pq-action-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }
    
    .pq-action-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    
    .pq-action-badge svg {
      width: 12px;
      height: 12px;
    }
    
    .pq-action-badge.schedule { background: rgba(34, 197, 94, 0.15); color: var(--accent-green); }
    .pq-action-badge.convert { background: rgba(168, 85, 247, 0.15); color: var(--accent-purple); }
    .pq-action-badge.followup { background: rgba(236, 72, 153, 0.15); color: #ec4899; }
    .pq-action-badge.send { background: rgba(59, 130, 246, 0.15); color: var(--accent-blue); }
    .pq-action-badge.new-lead { background: rgba(215, 28, 209, 0.15); color: var(--fwg-primary); }
    .pq-action-badge.task { background: rgba(148, 163, 184, 0.15); color: var(--text-secondary); }
    
    .pq-doc-type {
      font-size: 11px;
      color: var(--text-muted);
      padding: 2px 8px;
      background: var(--bg-dark);
      border-radius: 4px;
    }
    
    .pq-customer {
      font-size: 16px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .pq-details {
      font-size: 13px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .pq-amount {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent-green);
      flex-shrink: 0;
    }
    
    .pq-arrow {
      color: var(--text-muted);
      flex-shrink: 0;
    }
    
    .pq-arrow svg {
      width: 20px;
      height: 20px;
    }

    .pq-pin {
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.15s ease;
      flex-shrink: 0;
    }
    
    .pq-pin:hover {
      color: var(--accent-yellow);
      background: rgba(234, 179, 8, 0.1);
    }
    
    .pq-pin.pinned {
      color: var(--accent-yellow);
    }
    
    .pq-pin svg {
      width: 16px;
      height: 16px;
    }
    
    .pq-complete {
      padding: 6px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.15s ease;
      opacity: 0;
    }
    
    .pq-item:hover .pq-complete {
      opacity: 1;
    }
    
    .pq-complete:hover {
      color: var(--accent-green);
      background: rgba(34, 197, 94, 0.1);
    }
    
    .pq-complete svg {
      width: 16px;
      height: 16px;
    }
    
    .pq-item.pinned {
      border-left: 3px solid var(--accent-yellow);
    }
    
    .pq-pinned-divider {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      color: var(--text-muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .pq-pinned-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border-color);
    }
    
    /* ========================================================================
       WAITING ON CUSTOMER SECTION
       ======================================================================== */
    .waiting-section {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .waiting-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    
    .waiting-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-muted);
    }
    
    .waiting-icon {
      width: 18px;
      height: 18px;
      color: var(--accent-blue);
    }
    
    .waiting-total {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent-blue);
    }
    
    .waiting-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
    }
    
    .waiting-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.15s ease;
      border: 1px solid transparent;
    }
    
    .waiting-card:hover {
      border-color: var(--accent-blue);
    }
    
    .waiting-viewed-icon {
      flex-shrink: 0;
      color: var(--text-muted);
    }
    
    .waiting-viewed-icon.viewed {
      color: var(--accent-purple);
    }
    
    .waiting-viewed-icon svg {
      width: 16px;
      height: 16px;
    }
    
    .waiting-info {
      flex: 1;
      min-width: 0;
    }
    
    .waiting-name {
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .waiting-meta {
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .waiting-amount {
      font-weight: 600;
      color: var(--text-secondary);
      flex-shrink: 0;
    }
    
    /* ========================================================================
       SNAPSHOT METRICS
       ======================================================================== */
    .snapshot-section {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .snapshot-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }
    
    .snapshot-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }
    
    .snapshot-card {
      padding: 16px;
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
      text-align: center;
    }
    
    .snapshot-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--fwg-primary);
      line-height: 1;
      margin-bottom: 4px;
    }
    
    .snapshot-value.green { color: var(--accent-green); }
    .snapshot-value.cyan { color: #06b6d4; }
    
    .snapshot-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    
    /* ========================================================================
       MTD BY CATEGORY
       ======================================================================== */
    .category-section {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .category-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }
    
    .category-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .category-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .category-name {
      width: 100px;
      font-size: 13px;
      color: var(--text-secondary);
      flex-shrink: 0;
    }
    
    .category-bar-container {
      flex: 1;
      height: 20px;
      background: var(--bg-elevated);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .category-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--fwg-primary), #06b6d4);
      border-radius: 4px;
      transition: width 0.4s ease;
    }
    
    .category-value {
      width: 80px;
      text-align: right;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    /* ========================================================================
       ADD TASK MODAL
       ======================================================================== */
    .add-task-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }
    
    .add-task-modal.active {
      opacity: 1;
      visibility: visible;
    }
    
    .add-task-modal-content {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(-20px);
      transition: transform 0.2s ease;
    }
    
    .add-task-modal.active .add-task-modal-content {
      transform: translateY(0);
    }
    
    .add-task-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .add-task-modal-title {
      font-size: 18px;
      font-weight: 600;
    }
    
    .add-task-modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
    }
    
    .add-task-modal-close:hover {
      color: var(--text-primary);
    }
    
    .add-task-modal-body {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .add-task-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 16px 20px;
      border-top: 1px solid var(--border-color);
    }

    /* Form Elements for Modal */
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .form-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
    }
    
    .form-input {
      padding: 10px 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      background: var(--bg-elevated);
      color: var(--text-primary);
      font-size: 14px;
      transition: border-color 0.15s ease;
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--fwg-primary);
    }
    
    .form-input::placeholder {
      color: var(--text-muted);
    }
    
    textarea.form-input {
      resize: vertical;
      min-height: 80px;
    }
    
    select.form-input {
      cursor: pointer;
    }
    
    .form-row {
      display: flex;
      gap: 12px;
    }
    
    @media (max-width: 500px) {
      .form-row {
        flex-direction: column;
      }
    }

    .task-link-display {
      padding: 10px 12px;
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
    }
    
    .task-link-display a {
      color: var(--fwg-primary);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .task-link-display a:hover {
      text-decoration: underline;
    }
    
    .btn-danger {
      background: var(--accent-red);
      color: white;
      border: none;
    }
    
    .btn-danger:hover {
      background: #dc2626;
    }

    /* ========================================================================
       KANBAN PIPELINE
       ======================================================================== */
    .pipeline-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .pipeline-search-wrapper {
      position: relative;
      flex: 1;
      max-width: 300px;
    }
    
    .pipeline-search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      color: var(--text-muted);
      pointer-events: none;
    }
    
    .pipeline-search {
      width: 100%;
      padding: 10px 12px 10px 40px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      background: var(--bg-surface);
      color: var(--text-primary);
      font-size: 14px;
    }
    
    .pipeline-search:focus {
      outline: none;
      border-color: var(--fwg-primary);
    }
    
    .pipeline-stats {
      display: flex;
      gap: 24px;
    }
    
    .pipeline-stat {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    
    .pipeline-stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--fwg-primary);
    }
    
    .pipeline-stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
    }
    
    .kanban-container {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding-bottom: 12px;
      min-height: 500px;
    }
    
    .kanban-lane {
      flex: 1;
      min-width: 220px;
      max-width: 280px;
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      display: flex;
      flex-direction: column;
    }
    
    /* Cold Section (horizontal at bottom) */
    .cold-section {
      margin-top: 20px;
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 16px;
    }
    
    .cold-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    
    .cold-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-muted);
    }
    
    .cold-icon {
      width: 18px;
      height: 18px;
      color: var(--accent-purple);
    }
    
    .cold-count {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .cold-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
    }
    
    .kanban-lane-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .kanban-lane-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 600;
    }
    
    .kanban-lane-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    
    .kanban-lane-dot.new { background: var(--fwg-primary); }
    .kanban-lane-dot.action { background: var(--accent-orange); }
    .kanban-lane-dot.waiting { background: var(--accent-blue); }
    .kanban-lane-dot.cold { background: var(--accent-purple); }
    .kanban-lane-dot.production { background: var(--accent-cyan, #06b6d4); }
    
    .kanban-lane-count {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      background: var(--bg-elevated);
      padding: 2px 8px;
      border-radius: 10px;
    }
    
    .kanban-lane-body {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 600px;
    }
    
    .kanban-card {
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 12px;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .kanban-card:hover {
      border-color: var(--fwg-primary);
      transform: translateY(-2px);
    }
    
    .kanban-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .kanban-card-type {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      padding: 2px 6px;
      border-radius: 4px;
    }
    
    .kanban-card-type.submission {
      background: rgba(215, 28, 209, 0.15);
      color: var(--fwg-primary);
    }
    
    .kanban-card-type.quote {
      background: rgba(168, 85, 247, 0.15);
      color: var(--accent-purple);
    }
    
    .kanban-card-type.invoice {
      background: rgba(34, 197, 94, 0.15);
      color: var(--accent-green);
    }
    
    .kanban-card-amount {
      font-size: 14px;
      font-weight: 700;
      color: var(--accent-green);
    }
    
    .kanban-card-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .kanban-card-desc {
      font-size: 12px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .kanban-card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid var(--border-color);
    }
    
    .kanban-card-date {
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .kanban-card-viewed {
      color: var(--text-muted);
    }
    
    .kanban-card-viewed.viewed {
      color: var(--accent-purple);
    }
    
    .kanban-card-viewed svg {
      width: 14px;
      height: 14px;
    }

    .kanban-card-cold-btn {
      color: var(--text-muted);
      cursor: pointer;
      padding: 2px;
      border-radius: 4px;
      transition: all 0.15s ease;
      opacity: 0;
    }
    
    .kanban-card:hover .kanban-card-cold-btn {
      opacity: 1;
    }
    
    .kanban-card-cold-btn:hover {
      color: var(--accent-purple);
      background: rgba(168, 85, 247, 0.1);
    }
    
    .kanban-card-cold-btn svg {
      width: 14px;
      height: 14px;
    }
    
    .kanban-card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid var(--border-color);
    }
    
    .kanban-card-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .kanban-empty {
      text-align: center;
      padding: 20px;
      color: var(--text-muted);
      font-size: 13px;
    }
    
    .category-value {
      width: 80px;
      text-align: right;
      font-size: 13px;
      font-weight: 600;
      flex-shrink: 0;
    }
    
    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.15s ease;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--fwg-primary), #02f9fb);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(249, 115, 22, 0.4);
    }
    
    .btn-secondary {
      background: var(--bg-elevated);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    
    .btn-secondary:hover {
      background: var(--border-hover);
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }
    
    /* Status Pills */
    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-pill.new { background: rgba(59, 130, 246, 0.15); color: var(--accent-blue); }
    .status-pill.in-progress { background: rgba(234, 179, 8, 0.15); color: var(--accent-yellow); }
    .status-pill.quoted { background: rgba(168, 85, 247, 0.15); color: var(--accent-purple); }
    .status-pill.won { background: rgba(34, 197, 94, 0.15); color: var(--accent-green); }
    .status-pill.lost { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }
    .status-pill.sent { background: rgba(59, 130, 246, 0.15); color: var(--accent-blue); }
    .status-pill.paid { background: rgba(34, 197, 94, 0.15); color: var(--accent-green); }
    
    /* Tables */
    .table-container {
      overflow-x: auto;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th {
      text-align: left;
      padding: 12px 16px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-elevated);
    }
    
    .data-table td {
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
      font-size: 14px;
    }
    
    .data-table tr:hover td {
      background: rgba(255,255,255,0.02);
    }
    
    .data-table .customer-cell {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .data-table .customer-name {
      font-weight: 500;
    }
    
    .data-table .customer-company {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .data-table .vehicle-cell {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .data-table .vehicle-type {
      font-weight: 500;
    }
    
    .data-table .vehicle-details {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .data-table .price-range {
      font-weight: 600;
      color: var(--accent-green);
    }
    
    .data-table .date-cell {
      color: var(--text-secondary);
      font-size: 13px;
    }
    
    .data-table .actions-cell {
      display: flex;
      gap: 8px;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .empty-state-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    
    .empty-state-text {
      font-size: 14px;
    }
    
    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: var(--text-muted);
    }
    
    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border-color);
      border-top-color: var(--fwg-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 12px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Search & Filters */
    .filters-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    .search-input {
      flex: 1;
      min-width: 200px;
      padding: 10px 16px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      background: var(--bg-dark);
      color: var(--text-primary);
      font-size: 14px;
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--fwg-primary);
    }

    /* Pipeline Snapshot Section */
    .pipeline-section {
      margin-top: 24px;
    }
    
    .pipeline-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .pipeline-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .pipeline-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    
    @media (max-width: 768px) {
      .pipeline-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .pipeline-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 16px;
    }
    
    .pipeline-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .pipeline-card-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .pipeline-card-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--fwg-primary);
    }
    
    .pipeline-buckets {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .pipeline-bucket-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: var(--bg-elevated);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .pipeline-bucket-row:hover {
      background: var(--bg-input);
    }
    
    .pipeline-bucket-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .pipeline-bucket-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .pipeline-bucket-dot.action { background: #f59e0b; }
    .pipeline-bucket-dot.waiting { background: #3b82f6; }
    .pipeline-bucket-dot.cold { background: #6b7280; }
    .pipeline-bucket-dot.followup { background: #ec4899; }
    .pipeline-bucket-dot.approved { background: #10b981; }
    .pipeline-bucket-dot.viewed { background: #a855f7; }
    
    .pipeline-bucket-count {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      min-width: 24px;
      text-align: right;
    }
    
    .pipeline-bucket-count.highlight {
      color: #f59e0b;
    }
    
    .pipeline-alert {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: rgba(236, 72, 153, 0.1);
      border: 1px solid rgba(236, 72, 153, 0.3);
      border-radius: var(--radius-sm);
      margin-top: 8px;
      cursor: pointer;
    }
    
    .pipeline-alert:hover {
      background: rgba(236, 72, 153, 0.15);
    }
    
    .pipeline-alert-icon {
      color: #ec4899;
    }
    
    .pipeline-alert-text {
      font-size: 12px;
      color: #f472b6;
      font-weight: 500;
    }

    /* Bucket badges */
    .bucket-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      white-space: nowrap;
    }
    
    .bucket-badge.ready-for-action { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
    .bucket-badge.waiting-on-customer { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .bucket-badge.cold { background: rgba(107, 114, 128, 0.15); color: #9ca3af; }
    .bucket-badge.archive-won { background: rgba(16, 185, 129, 0.15); color: #10b981; }
    .bucket-badge.archive-lost { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    
    /* Status indicator badges (viewed, declined, revision) */
    .indicator-badge {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      margin-left: 6px;
    }
    
    .indicator-badge.viewed { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
    .indicator-badge.declined { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .indicator-badge.revision { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
    .indicator-badge.approved { background: rgba(16, 185, 129, 0.2); color: #34d399; }
    .indicator-badge.followup { background: rgba(236, 72, 153, 0.2); color: #f472b6; }
    
    /* Bucket filter select */
    .bucket-filter {
      min-width: 180px;
    }
    
    .filter-select {
      padding: 10px 16px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      background: var(--bg-dark);
      color: var(--text-primary);
      font-size: 14px;
      cursor: pointer;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }
      
      .sidebar.open {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .summary-grid {
        grid-template-columns: 1fr;
      }
    }
    
    /* View Containers (hidden by default) */
    .view {
      display: none;
    }
    
    .view.active {
      display: block;
    }
    
    /* Schedule Badges */
    .sched-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      white-space: nowrap;
    }
    
    .sched-badge.scheduled {
      background: rgba(34, 197, 94, 0.15);
      color: var(--accent-green);
    }
    
    .sched-badge.needs-sched {
      background: rgba(234, 179, 8, 0.15);
      color: #eab308;
    }
  </style>
</head>

<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="sidebar-logo-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="1" y="3" width="15" height="13" rx="2" ry="2"></rect>
              <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
              <circle cx="5.5" cy="18.5" r="2.5"></circle>
              <circle cx="18.5" cy="18.5" r="2.5"></circle>
            </svg>
          </div>
          <div>
            <div class="sidebar-logo-text">Frederick <span class="gradient">Wraps</span></div>
            <div class="sidebar-logo-sub">Operations Hub</div>
          </div>
        </div>
      </div>
      
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Core</div>
          <div class="nav-item active" data-view="overview" onclick="showView('overview')">
            <svg class="nav-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="7" height="7"></rect>
              <rect x="14" y="3" width="7" height="7"></rect>
              <rect x="14" y="14" width="7" height="7"></rect>
              <rect x="3" y="14" width="7" height="7"></rect>
            </svg>
            <span class="nav-item-label">Command <span class="gradient">Center</span></span>
          </div>
          <div class="nav-item" data-view="submissions" onclick="showView('submissions')">
            <svg class="nav-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
            </svg>
            <span class="nav-item-label">Lead <span class="gradient">Pipeline</span></span>
            <span class="nav-item-badge" id="submissions-badge" style="display:none;">0</span>
          </div>
        </div>
        
        <div class="nav-section">
          <div class="nav-section-title">Sales</div>
          <div class="nav-item" data-view="quotes" onclick="showView('quotes')">
            <svg class="nav-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            <span class="nav-item-label">Quote <span class="gradient">Builder</span></span>
          </div>
          <div class="nav-item" data-view="invoices" onclick="showView('invoices')">
            <svg class="nav-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
              <line x1="1" y1="10" x2="23" y2="10"></line>
            </svg>
            <span class="nav-item-label">Invoice <span class="gradient">Manager</span></span>
          </div>
          <div class="nav-item" data-view="payments" onclick="showView('payments')">
            <svg class="nav-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="1" x2="12" y2="23"></line>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
            <span class="nav-item-label">Payment <span class="gradient">History</span></span>
          </div>
        </div>
        
        <div class="nav-section">
          <div class="nav-section-title">Communication</div>
          <div class="nav-item" data-view="messages" onclick="showView('messages')">
            <svg class="nav-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            <span class="nav-item-label">Message <span class="gradient">Hub</span></span>
            <span class="nav-item-badge" id="messages-badge" style="display:none;">0</span>
          </div>
          <div class="nav-item" data-view="customers" onclick="showView('customers')">
            <svg class="nav-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <span class="nav-item-label">Customer <span class="gradient">Database</span></span>
          </div>
          <div class="nav-item disabled" data-view="email" onclick="">
            <svg class="nav-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
              <polyline points="22,6 12,13 2,6"></polyline>
            </svg>
            <span class="nav-item-label">Email <span class="gradient">Templates</span></span>
            <span class="nav-item-badge gray">Soon</span>
          </div>
        </div>
        
        <div class="nav-section">
          <div class="nav-section-title">Production</div>
          <div class="nav-item" data-view="calendar" onclick="showView('calendar')">
            <svg class="nav-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <span class="nav-item-label">Job <span class="gradient">Calendar</span></span>
          </div>
          <div class="nav-item" data-view="tasks" onclick="showView('tasks')">
            <svg class="nav-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 11l3 3L22 4"></path>
              <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
            </svg>
            <span class="nav-item-label">Task <span class="gradient">Board</span></span>
            <span class="nav-item-badge" id="tasks-badge" style="display:none;">0</span>
          </div>
          <div class="nav-item" data-view="production" onclick="showView('production')">
            <svg class="nav-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <span class="nav-item-label">Production <span class="gradient">Flow</span></span>
            <span class="nav-item-badge" id="production-badge" style="display:none;">0</span>
          </div>
        </div>
        
        <div class="nav-section">
          <div class="nav-section-title">Account</div>
          <div class="nav-item" data-view="settings" onclick="showView('settings')">
            <svg class="nav-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
            <span class="nav-item-label">System <span class="gradient">Settings</span></span>
          </div>
        </div>
      </nav>
      
      <div class="sidebar-footer">
        <div class="plan-badge">
          <div class="plan-status"></div>
          <div class="plan-text"><strong>FWG Ops</strong> &bull; Active</div>
        </div>
      </div>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
      <header class="header">
        <h1 class="header-title" id="header-title">Overview</h1>
        <div class="header-actions">
          <button class="btn btn-secondary btn-sm" id="btn-refresh" onclick="refreshData()">
            Refresh
          </button>
        </div>
      </header>
      
      <div class="content">
        <!-- Overview View -->
        <div class="view active" id="view-overview">
          
          <!-- Priority Queue (Action Center) -->
          <div class="priority-queue-section">
            <div class="pq-header">
              <div class="pq-title">
                <svg class="pq-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
                Customer Action Center
              </div>
              <button class="btn btn-primary btn-sm" onclick="openAddTaskModal()">+ Add Task</button>
            </div>
            <div class="priority-queue" id="priority-queue">
              <div class="loading">
                <div class="spinner"></div>
                Loading action items...
              </div>
            </div>
          </div>
          
          <!-- Waiting on Customer -->
          <div class="waiting-section" id="waiting-section" style="display:none;">
            <div class="waiting-header">
              <div class="waiting-title">
                <svg class="waiting-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                Waiting on Customer
              </div>
              <div class="waiting-total" id="waiting-total">$0</div>
            </div>
            <div class="waiting-grid" id="waiting-grid">
              <!-- Populated by JS -->
            </div>
          </div>
          
          <!-- Snapshot Metrics -->
          <div class="snapshot-section" id="snapshot-section">
            <div class="snapshot-title">Snapshot</div>
            <div class="snapshot-grid" id="snapshot-grid">
              <div class="snapshot-card">
                <div class="snapshot-value" id="metric-revenue">$0</div>
                <div class="snapshot-label" id="metric-revenue-label">Jan Revenue</div>
              </div>
              <div class="snapshot-card">
                <div class="snapshot-value" id="metric-ppf-vinyl">$0</div>
                <div class="snapshot-label">PPF & Vinyl</div>
              </div>
              <div class="snapshot-card">
                <div class="snapshot-value green" id="metric-bonus">$0</div>
                <div class="snapshot-label">2.5% Bonus</div>
              </div>
              <div class="snapshot-card">
                <div class="snapshot-value cyan" id="metric-pipeline">$0</div>
                <div class="snapshot-label">Pipeline Value</div>
              </div>
            </div>
          </div>
          
          <!-- MTD by Category -->
          <div class="category-section" id="category-section">
            <div class="category-title">MTD by Category</div>
            <div class="category-list" id="category-list">
              <div class="loading">
                <div class="spinner"></div>
                Loading...
              </div>
            </div>
          </div>
          
        </div>

        <!-- Task Detail Modal -->
        <div class="add-task-modal" id="task-detail-modal">
          <div class="add-task-modal-content">
            <div class="add-task-modal-header">
              <div class="add-task-modal-title">Task Details</div>
              <button class="add-task-modal-close" onclick="closeTaskDetailModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
              </button>
            </div>
            <div class="add-task-modal-body">
              <input type="hidden" id="task-detail-id">
              <div class="form-group">
                <label class="form-label">Task Title <span style="color: var(--accent-red);">*</span></label>
                <input type="text" class="form-input" id="task-detail-title" placeholder="What needs to be done?">
              </div>
              <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-input" id="task-detail-description" rows="3" placeholder="Optional details..."></textarea>
              </div>
              <div class="form-row">
                <div class="form-group" style="flex: 1;">
                  <label class="form-label">Status</label>
                  <select class="form-input" id="task-detail-status">
                    <option value="TO_DO">To Do</option>
                    <option value="IN_PROGRESS">In Progress</option>
                    <option value="COMPLETED">Completed</option>
                  </select>
                </div>
                <div class="form-group" style="flex: 1;">
                  <label class="form-label">Priority</label>
                  <select class="form-input" id="task-detail-priority">
                    <option value="LOW">Low</option>
                    <option value="NORMAL">Normal</option>
                    <option value="HIGH">High</option>
                    <option value="URGENT">Urgent</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Due Date</label>
                <input type="date" class="form-input" id="task-detail-due-date">
              </div>
              <div class="form-group" id="task-detail-link-group" style="display: none;">
                <label class="form-label">Linked Document</label>
                <div class="task-link-display" id="task-detail-link-display">
                  <!-- Populated by JS -->
                </div>
              </div>
            </div>
            <div class="add-task-modal-footer">
              <button class="btn btn-danger" id="btn-delete-task" onclick="deleteTask()" style="margin-right: auto;">Delete</button>
              <button class="btn btn-success" id="btn-complete-task" onclick="completeTaskFromModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;margin-right:6px;"><polyline points="20 6 9 17 4 12"></polyline></svg>
                Mark Complete
              </button>
              <button class="btn btn-secondary" onclick="closeTaskDetailModal()">Cancel</button>
              <button class="btn btn-primary" id="btn-update-task" onclick="updateTask()">Save Changes</button>
            </div>
          </div>
        </div>
        
        <!-- Add Task Modal -->
        <div class="add-task-modal" id="add-task-modal">
          <div class="add-task-modal-content">
            <div class="add-task-modal-header">
              <div class="add-task-modal-title">Add Task</div>
              <button class="add-task-modal-close" onclick="closeAddTaskModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
              </button>
            </div>
            <div class="add-task-modal-body">
              <div class="form-group">
                <label class="form-label">Task Title <span style="color: var(--accent-red);">*</span></label>
                <input type="text" class="form-input" id="task-title" placeholder="What needs to be done?">
              </div>
              <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-input" id="task-description" rows="3" placeholder="Optional details..."></textarea>
              </div>
              <div class="form-row">
                <div class="form-group" style="flex: 1;">
                  <label class="form-label">Priority</label>
                  <select class="form-input" id="task-priority">
                    <option value="NORMAL">Normal</option>
                    <option value="HIGH">High</option>
                    <option value="URGENT">Urgent</option>
                    <option value="LOW">Low</option>
                  </select>
                </div>
                <div class="form-group" style="flex: 1;">
                  <label class="form-label">Due Date</label>
                  <input type="date" class="form-input" id="task-due-date">
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Link to Document (Optional)</label>
                <select class="form-input" id="task-link-type" onchange="updateTaskLinkOptions()">
                  <option value="">No link</option>
                  <option value="quote">Quote</option>
                  <option value="invoice">Invoice</option>
                  <option value="submission">Submission</option>
                </select>
              </div>
              <div class="form-group" id="task-link-select-group" style="display: none;">
                <label class="form-label">Select Document</label>
                <select class="form-input" id="task-link-id">
                  <option value="">Select...</option>
                </select>
              </div>
            </div>
            <div class="add-task-modal-footer">
              <button class="btn btn-secondary" onclick="closeAddTaskModal()">Cancel</button>
              <button class="btn btn-primary" id="btn-save-task" onclick="saveNewTask()">Create Task</button>
            </div>
          </div>
        </div>
        
        <!-- Lead Pipeline View (Kanban) -->
        <div class="view" id="view-submissions">
          <div class="pipeline-controls">
            <div class="pipeline-search-wrapper">
              <svg class="pipeline-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
              <input type="text" class="pipeline-search" id="pipeline-search" placeholder="Search pipeline..." oninput="filterPipeline()">
            </div>
            <div class="pipeline-stats" id="pipeline-stats">
              <div class="pipeline-stat">
                <span class="pipeline-stat-value" id="pipeline-total-value">$0</span>
                <span class="pipeline-stat-label">Total Pipeline</span>
              </div>
              <div class="pipeline-stat">
                <span class="pipeline-stat-value" id="pipeline-item-count">0</span>
                <span class="pipeline-stat-label">Active Items</span>
              </div>
            </div>
          </div>
          
          <div class="kanban-container" id="kanban-container">
            <div class="kanban-lane" data-bucket="NEW_LEADS">
              <div class="kanban-lane-header">
                <div class="kanban-lane-title">
                  <span class="kanban-lane-dot new"></span>
                  New Leads
                </div>
                <div class="kanban-lane-count" id="lane-count-new">0</div>
              </div>
              <div class="kanban-lane-body" id="lane-new">
                <div class="loading"><div class="spinner"></div></div>
              </div>
            </div>
            
            <div class="kanban-lane" data-bucket="READY_FOR_ACTION">
              <div class="kanban-lane-header">
                <div class="kanban-lane-title">
                  <span class="kanban-lane-dot action"></span>
                  Action Needed
                </div>
                <div class="kanban-lane-count" id="lane-count-action">0</div>
              </div>
              <div class="kanban-lane-body" id="lane-action">
                <div class="loading"><div class="spinner"></div></div>
              </div>
            </div>
            
            <div class="kanban-lane" data-bucket="WAITING_ON_CUSTOMER">
              <div class="kanban-lane-header">
                <div class="kanban-lane-title">
                  <span class="kanban-lane-dot waiting"></span>
                  Waiting
                </div>
                <div class="kanban-lane-count" id="lane-count-waiting">0</div>
              </div>
              <div class="kanban-lane-body" id="lane-waiting">
                <div class="loading"><div class="spinner"></div></div>
              </div>
            </div>
            
            <div class="kanban-lane" data-bucket="IN_PRODUCTION">
              <div class="kanban-lane-header">
                <div class="kanban-lane-title">
                  <span class="kanban-lane-dot production"></span>
                  In Production
                </div>
                <div class="kanban-lane-count" id="lane-count-production">0</div>
              </div>
              <div class="kanban-lane-body" id="lane-production">
                <div class="loading"><div class="spinner"></div></div>
              </div>
            </div>
          </div>
          
          <!-- Cold Section (horizontal at bottom) -->
          <div class="cold-section" id="cold-section" style="display:none;">
            <div class="cold-header">
              <div class="cold-title">
                <svg class="cold-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M2 12h20M12 2l4 4M12 2l-4 4M12 22l4-4M12 22l-4-4M2 12l4 4M2 12l4-4M22 12l-4 4M22 12l-4-4"></path></svg>
                Cold
              </div>
              <div class="cold-count" id="lane-count-cold">0 items</div>
            </div>
            <div class="cold-grid" id="lane-cold">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>
        
        <!-- Quotes View -->
        <div class="view" id="view-quotes">
          <div class="filters-bar">
            <input type="text" class="search-input" id="quotes-search" placeholder="Search by name, company..." oninput="filterQuotes()">
            <select class="filter-select bucket-filter" id="quotes-bucket-filter" onchange="filterQuotes()">
              <option value="active">Active</option>
              <option value="">All Buckets</option>
              <option value="READY_FOR_ACTION">Ready for Action</option>
              <option value="WAITING_ON_CUSTOMER">Waiting on Customer</option>
              <option value="COLD">Cold</option>
              <option value="ARCHIVE_WON">Archived - Won</option>
              <option value="ARCHIVE_LOST">Archived - Lost</option>
            </select>
            <select class="filter-select" id="quotes-status-filter" onchange="filterQuotes()">
              <option value="">All Statuses</option>
              <option value="Draft">Draft</option>
              <option value="Sent">Sent</option>
              <option value="Viewed">Viewed</option>
              <option value="Approved">Approved</option>
              <option value="Declined">Declined</option>
              <option value="Expired">Expired</option>
            </select>
            <button class="btn btn-primary" id="btn-new-quote" onclick="createNewQuote()">+ New Quote</button>
          </div>
          
          <div class="card">
            <div class="table-container" id="quotes-table">
              <div class="loading">
                <div class="spinner"></div>
                Loading quotes...
              </div>
            </div>
          </div>
        </div>
        
        <!-- Quote Detail View -->
        <div class="view" id="view-quote-detail">
          <?!= include('FWG_Ops_DocumentDetail'); ?>
        </div>
        
        <!-- Invoices View -->
        <div class="view" id="view-invoices">
          <div class="filters-bar">
            <input type="text" class="search-input" id="invoices-search" placeholder="Search by name, company..." oninput="filterInvoices()">
            <select class="filter-select bucket-filter" id="invoices-bucket-filter" onchange="filterInvoices()">
              <option value="active">Active</option>
              <option value="">All Buckets</option>
              <option value="READY_FOR_ACTION">Ready for Action</option>
              <option value="WAITING_ON_CUSTOMER">Waiting on Customer</option>
              <option value="COLD">Cold</option>
              <option value="ARCHIVE_WON">Archived - Won</option>
              <option value="ARCHIVE_LOST">Archived - Lost</option>
            </select>
            <select class="filter-select" id="invoices-status-filter" onchange="filterInvoices()">
              <option value="">All Statuses</option>
              <option value="Draft">Draft</option>
              <option value="Sent">Sent</option>
              <option value="Partial">Partial</option>
              <option value="Paid">Paid</option>
              <option value="Overdue">Overdue</option>
              <option value="Void">Void</option>
            </select>
          </div>
          
          <div class="card">
            <div class="table-container" id="invoices-table">
              <div class="loading">
                <div class="spinner"></div>
                Loading invoices...
              </div>
            </div>
          </div>
        </div>
        
        <!-- Invoice Detail View -->
        <div class="view" id="view-invoice-detail">
          <!-- Uses same DocumentDetail, loaded via viewInvoice() -->
        </div>
        
        <!-- Messages View -->
        <div class="view" id="view-messages">
          <?!= include('FWG_Ops_MessagesView'); ?>
        </div>
        
        <!-- Calendar View -->
        <div class="view" id="view-calendar">
          <?!= include('FWG_Ops_Calendar'); ?>
        </div>
        
        <!-- Tasks View -->
        <div class="view" id="view-tasks">
          <?!= include('FWG_Ops_TaskBoard'); ?>
        </div>

        <div id="view-production" class="view">
          <!-- SVG Gradient Definition for Progress Rings -->
          <svg class="svg-defs">
            <defs>
              <linearGradient id="ringGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#22d3ee"/>
                <stop offset="100%" stop-color="#a855f7"/>
              </linearGradient>
            </defs>
          </svg>
          
          <div class="production-container">
            <div class="production-header">
              <div class="production-header-left">
                <h2>Production <span>Flow</span></h2>
                <p>Track jobs through your production pipeline</p>
              </div>
              <div class="production-stats">
                <div class="production-stat">
                  <div class="production-stat-value" id="production-active-count">0</div>
                  <div class="production-stat-label">Active Jobs</div>
                </div>
                <div class="production-stat">
                  <div class="production-stat-value" id="production-tasks-pending">0</div>
                  <div class="production-stat-label">Tasks</div>
                </div>
                <div class="production-stat">
                  <div class="production-stat-value" id="production-tasks-today">0</div>
                  <div class="production-stat-label">Done Today</div>
                </div>
              </div>
            </div>
            <div class="production-filters">
              <input type="text" class="production-search" id="production-search" placeholder="Search jobs..." oninput="filterProduction()">
              <select class="production-filter-select" id="production-category-filter" onchange="filterProduction()">
                <option value="">All Categories</option>
              </select>
            </div>
            <div class="production-queue" id="production-queue">
              <div class="loading">
                <div class="spinner"></div>
                Loading production queue...
              </div>
            </div>
          </div>
        </div>
      
        
        <!-- Customers View -->
        <div id="view-customers" class="view">
          <?!= include('FWG_Ops_Customers'); ?>
        </div>
        
        <!-- Settings View -->
        <div id="view-settings" class="view">
          <?!= include('FWG_Ops_SystemSet'); ?>
        </div>
      </div>
    </main>
  </div>
  
  <!-- Toast Notification -->
  <div id="toast-container"></div>
  
  <style>
    /* Toast Notifications */
    #toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .toast {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 12px 16px;
      min-width: 250px;
      max-width: 400px;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideIn 0.3s ease;
    }
    
    .toast.success {
      border-left: 4px solid var(--accent-green);
    }
    
    .toast.error {
      border-left: 4px solid var(--accent-red);
    }
    
    .toast.info {
      border-left: 4px solid var(--accent-blue);
    }
    
    .toast-icon {
      font-size: 18px;
    }
    
    .toast-message {
      flex: 1;
      font-size: 14px;
    }
    
    .toast-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 16px;
      padding: 0;
    }
    
    .toast-close:hover {
      color: var(--text-primary);
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
    
    /* Button States */
    .btn:active {
      transform: scale(0.96);
    }
    
    .btn-saving, .btn-loading {
      background: var(--accent-blue) !important;
      border-color: var(--accent-blue) !important;
      pointer-events: none;
      opacity: 0.9;
    }
    
    .btn-saved, .btn-success {
      background: var(--accent-green) !important;
      border-color: var(--accent-green) !important;
    }
    
    .btn-error {
      background: var(--accent-red) !important;
      border-color: var(--accent-red) !important;
    }
    
    .btn.loading {
      opacity: 0.7;
      pointer-events: none;
      position: relative;
    }
    
    .btn.loading::after {
      content: '';
      position: absolute;
      width: 14px;
      height: 14px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-left: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>

  <script>
    // ========================================================================
    // STATE
    // ========================================================================
    let currentView = 'overview';
    let allSubmissions = [];
    let dashboardSummary = null;
    let commandCenterMetrics = null;
    
    // ========================================================================
    // TOAST NOTIFICATIONS
    // ========================================================================
    function showToast(message, type = 'info', duration = 3000) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast ' + type;
      
      const icons = {
        success: '&#10003;',
        error: '&#10007;',
        info: 'i'
      };
      
      toast.innerHTML = `
        <span class="toast-icon">${icons[type] || icons.info}</span>
        <span class="toast-message">${message}</span>
        <button class="toast-close" onclick="this.parentElement.remove()">&#215;</button>
      `;
      
      container.appendChild(toast);
      
      // Auto remove after duration
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }
    
    // Button loading state helpers
    function setButtonLoading(btn, loading) {
      if (loading) {
        btn.classList.add('loading');
        btn.dataset.originalText = btn.textContent;
      } else {
        btn.classList.remove('loading');
      }
    }
    
    // ========================================================================
    // VIEW MANAGEMENT
    // ========================================================================
    function showView(viewName) {
      currentView = viewName;
      
      // Update nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.view === viewName);
      });
      
      // Update views
      document.querySelectorAll('.view').forEach(view => {
        view.classList.toggle('active', view.id === 'view-' + viewName);
      });
      
      // Update header title
      const titles = {
        'overview': 'Overview',
        'submissions': 'Lead Pipeline',
        'quotes': 'Quotes',
        'invoices': 'Invoices',
        'messages': 'Messages',
        'customers': 'Customers',
        'calendar': 'Calendar',
        'tasks': 'Task Board',
        'production': 'Production Flow',
        'settings': 'Settings'
      };
      document.getElementById('header-title').textContent = titles[viewName] || 'Dashboard';
      
      // Load view-specific data
      if (viewName === 'overview') {
        loadDashboardSummary();
        loadCommandCenterMetrics();
        loadPriorityQueue();
      } else if (viewName === 'submissions') {
        loadPipeline();
      } else if (viewName === 'messages') {
        loadConversations();
      } else if (viewName === 'quotes') {
        loadQuotes();
      } else if (viewName === 'invoices') {
        loadInvoices();
      } else if (viewName === 'calendar') {
        if (typeof initCalendar === 'function') initCalendar();
      } else if (viewName === 'tasks') {
        if (typeof initTaskBoard === 'function') initTaskBoard();
      } else if (viewName === 'customers') {
        if (typeof initCustomersView === 'function') initCustomersView();
      } else if (viewName === 'production') {
        loadProductionQueue();
      } else if (viewName === 'settings') {
        if (typeof loadSettings === 'function') loadSettings();
      }
    }
    
    // ========================================================================
    // DATA LOADING
    // ========================================================================
    function loadDashboardSummary() {
      console.log('loadDashboardSummary: calling backend...');
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('loadDashboardSummary: got result:', JSON.stringify(result));
          if (result && result.ok) {
            dashboardSummary = result.summary;
            // Update pipeline value in snapshot metrics if already rendered
            renderSnapshotMetrics();
          } else {
            console.error('Error loading summary:', result ? result.error : 'null result');
          }
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load summary:', error);
        })
        .getDashboardSummary();
    }
    
    function loadCommandCenterMetrics() {
      console.log('loadCommandCenterMetrics: calling backend...');
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('loadCommandCenterMetrics: got result:', JSON.stringify(result));
          if (result && result.ok) {
            commandCenterMetrics = result;
            renderSnapshotMetrics();
            renderCategoryBreakdown();
          } else {
            console.error('Error loading command center:', result ? result.error : 'null result');
          }
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load command center:', error);
        })
        .getCommandCenterMetrics();
    }
    
    function loadPriorityQueue() {
      console.log('loadPriorityQueue: loading data...');
      
      // Load all data sources needed for priority queue
      let loadedCount = 0;
      const totalLoads = 5;
      
      function checkAllLoaded() {
        loadedCount++;
        if (loadedCount >= totalLoads) {
          renderPriorityQueue();
          renderWaitingSection();
        }
      }
      
      // Load submissions
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.ok) {
            allSubmissions = result.submissions;
          }
          checkAllLoaded();
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load submissions:', error);
          checkAllLoaded();
        })
        .getSubmissions();
      
      // Load quotes
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.ok) {
            allQuotes = result.documents;
          }
          checkAllLoaded();
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load quotes:', error);
          checkAllLoaded();
        })
        .getDocuments({ docType: 'quote' });
      
      // Load invoices
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.ok) {
            allInvoices = result.documents;
          }
          checkAllLoaded();
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load invoices:', error);
          checkAllLoaded();
        })
        .getDocuments({ docType: 'invoice' });
      
      // Load tasks
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('getTasks result:', result);
          if (result && result.ok) {
            allTasks = result.tasks || [];
            console.log('allTasks loaded:', allTasks.length, 'tasks');
          } else {
            console.error('getTasks error:', result?.error);
          }
          checkAllLoaded();
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load tasks:', error);
          checkAllLoaded();
        })
        .getTaskList({ status: 'active' });
      
      // Load pinned items
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.ok) {
            pinnedItems = result.pinned || [];
            console.log('Pinned items loaded:', pinnedItems.length);
          }
          checkAllLoaded();
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load pinned items:', error);
          checkAllLoaded();
        })
        .getPinnedItems();
    }
    
    function loadSubmissions() {
      const container = document.getElementById('submissions-table');
      container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading submissions...</div>';
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.ok) {
            allSubmissions = result.submissions;
            renderSubmissionsTable(result.submissions);
            updateSubmissionsBadge();
          } else {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:48px;height:48px;color:#eab308;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg></div><div class="empty-state-title">Error</div><div class="empty-state-text">' + (result ? result.error : 'Unknown error') + '</div></div>';
          }
        })
        .withFailureHandler(function(error) {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:48px;height:48px;color:#eab308;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg></div><div class="empty-state-title">Error</div><div class="empty-state-text">' + error + '</div></div>';
        })
        .getSubmissions();
    }
    
    function loadBadgeCounts() {
      // Unread messages
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.ok && result.count > 0) {
            const badge = document.getElementById('messages-badge');
            badge.textContent = result.count;
            badge.style.display = 'inline';
          }
        })
        .withFailureHandler(function(error) {
          console.log('getUnreadMessageCount error:', error);
        })
        .getUnreadMessageCount();
      
      // Open tasks
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.ok && result.count > 0) {
            const badge = document.getElementById('tasks-badge');
            badge.textContent = result.count;
            badge.style.display = 'inline';
          }
        })
        .withFailureHandler(function(error) {
          console.log('getOpenTaskCount error:', error);
        })
        .getOpenTaskCount();
    }
    
    function updateSubmissionsBadge() {
      const newCount = allSubmissions.filter(s => s.status === 'New').length;
      const badge = document.getElementById('submissions-badge');
      if (newCount > 0) {
        badge.textContent = newCount;
        badge.style.display = 'inline';
      } else {
        badge.style.display = 'none';
      }
    }
    
    function refreshData() {
      const btn = document.getElementById('btn-refresh');
      const originalText = btn.innerHTML;
      btn.innerHTML = 'Refreshing...';
      btn.classList.add('btn-loading');
      
      // Small delay to show the loading state, then refresh
      setTimeout(() => {
        showView(currentView);
        loadBadgeCounts();
        btn.innerHTML = '&#10003; Refreshed';
        btn.classList.remove('btn-loading');
        btn.classList.add('btn-success');
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.classList.remove('btn-success');
        }, 1500);
      }, 300);
    }

    // ========================================================================
    // PRIORITY QUEUE RENDERING
    // ========================================================================
    
    function getActionType(item, itemType) {
      // Determine what action is needed for this item
      if (itemType === 'submission') {
        if (item.status === 'New' || item.status === 'In Progress') {
          return { action: 'new-lead', label: 'New Lead', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>' };
        }
      }
      
      if (itemType === 'quote') {
        if (item.status === 'Approved') {
          return { action: 'convert', label: 'Convert to Invoice', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>' };
        }
        if (item.status === 'Draft') {
          return { action: 'send', label: 'Send Quote', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>' };
        }
        // Check if needs follow-up (sent more than 3 days ago)
        if (item.status === 'Sent' && item.sent_at) {
          const sentDate = new Date(item.sent_at);
          const daysSinceSent = (new Date() - sentDate) / (1000 * 60 * 60 * 24);
          if (daysSinceSent >= 3) {
            return { action: 'followup', label: 'Send Follow-up', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>' };
          }
        }
      }
      
      if (itemType === 'invoice') {
        if (item.status === 'Paid' && !item.event_id) {
          return { action: 'schedule', label: 'Schedule Job', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>' };
        }
        if (item.status === 'Draft') {
          return { action: 'send', label: 'Send Invoice', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>' };
        }
        // Check if needs follow-up
        if ((item.status === 'Sent' || item.status === 'Partial') && item.sent_at) {
          const sentDate = new Date(item.sent_at);
          const daysSinceSent = (new Date() - sentDate) / (1000 * 60 * 60 * 24);
          if (daysSinceSent >= 3) {
            return { action: 'followup', label: 'Send Follow-up', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>' };
          }
        }
      }
      
      if (itemType === 'task') {
        return { action: 'task', label: 'Task', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>' };
      }
      
      return null;
    }
    
    function getPriorityScore(item, itemType, actionType) {
      // Lower score = higher priority
      // 1: Paid - Schedule Job
      // 2: Approved - Convert to Invoice  
      // 3: New Submission / URGENT tasks
      // 4: Tasks due today/overdue / HIGH priority tasks
      // 5: Needs Follow-up
      // 6: Draft - Send / NORMAL tasks
      // 7: Tasks with future due dates / LOW tasks
      
      if (actionType === 'schedule') return 1;
      if (actionType === 'convert') return 2;
      if (actionType === 'new-lead') return 3;
      
      if (actionType === 'task') {
        const taskPriority = (item.priority || 'NORMAL').toUpperCase();
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const hasDueDate = item.due_date && item.due_date !== '';
        const dueDate = hasDueDate ? new Date(item.due_date) : null;
        const isOverdue = dueDate && dueDate <= today;
        
        // URGENT tasks or overdue = priority 3
        if (taskPriority === 'URGENT' || isOverdue) return 3;
        // HIGH priority = 4
        if (taskPriority === 'HIGH') return 4;
        // LOW priority = 7
        if (taskPriority === 'LOW') return 7;
        // NORMAL = 6
        return 6;
      }
      
      if (actionType === 'followup') return 5;
      if (actionType === 'send') return 6;
      
      return 99;
    }
    
    function renderPriorityQueue() {
      const container = document.getElementById('priority-queue');
      
      // Build unified list of action items
      let actionItems = [];
      
      // Add submissions that need action
      (allSubmissions || []).forEach(sub => {
        if (sub.status === 'New' || sub.status === 'In Progress') {
          const actionInfo = getActionType(sub, 'submission');
          if (actionInfo) {
            actionItems.push({
              type: 'submission',
              id: sub.submission_id,
              data: sub,
              actionInfo: actionInfo,
              priority: getPriorityScore(sub, 'submission', actionInfo.action),
              amount: sub.price_range_max || 0,
              name: sub.customer_name,
              details: (sub.vehicle_year ? sub.vehicle_year + ' ' : '') + (sub.vehicle_make || '') + ' ' + (sub.vehicle_model || '') + ' - ' + (sub.project_type || '').replace(/_/g, ' ')
            });
          }
        }
      });
      
      // Add quotes that need action (not in WAITING bucket, not archived)
      (allQuotes || []).forEach(quote => {
        const bucket = inferBucket(quote);
        if (bucket === 'READY_FOR_ACTION') {
          const actionInfo = getActionType(quote, 'quote');
          if (actionInfo) {
            actionItems.push({
              type: 'quote',
              id: quote.doc_id,
              data: quote,
              actionInfo: actionInfo,
              priority: getPriorityScore(quote, 'quote', actionInfo.action),
              amount: quote.total || 0,
              name: quote.customer_name + (quote.company_name ? ' - ' + quote.company_name : ''),
              details: (quote.vehicle_description || quote.project_description || '') + (quote.status === 'Approved' ? ' - Approved' : '')
            });
          }
        }
      });
      
      // Add invoices that need action
      (allInvoices || []).forEach(inv => {
        const bucket = inferBucket(inv);
        // Include READY_FOR_ACTION and Paid invoices without event_id (need scheduling)
        if (bucket === 'READY_FOR_ACTION' || (inv.status === 'Paid' && !inv.event_id)) {
          const actionInfo = getActionType(inv, 'invoice');
          if (actionInfo) {
            actionItems.push({
              type: 'invoice',
              id: inv.doc_id,
              data: inv,
              actionInfo: actionInfo,
              priority: getPriorityScore(inv, 'invoice', actionInfo.action),
              amount: inv.total || 0,
              name: inv.customer_name + (inv.company_name ? ' - ' + inv.company_name : ''),
              details: (inv.vehicle_description || inv.project_description || '') + ' - ' + inv.status
            });
          }
        }
      });
      
      // Add tasks that are not completed
      (allTasks || []).forEach(task => {
        if (task.status !== 'COMPLETED' && task.status !== 'DONE') {
          const actionInfo = getActionType(task, 'task');
          if (actionInfo) {
            // Build details with linked doc info
            let details = '';
            if (task.quote_id) {
              details = 'Linked to Quote ' + task.quote_id;
            } else if (task.invoice_id) {
              details = 'Linked to Invoice ' + task.invoice_id;
            } else if (task.submission_id) {
              details = 'Linked to Submission ' + task.submission_id;
            }
            
            if (task.due_date) {
              details += (details ? '  ' : '') + 'Due: ' + formatDate(task.due_date);
            }
            
            if (!details && task.description) {
              details = task.description;
            }
            
            if (!details) {
              details = 'No due date';
            }
            
            actionItems.push({
              type: 'task',
              id: task.task_id,
              data: task,
              actionInfo: actionInfo,
              priority: getPriorityScore(task, 'task', actionInfo.action),
              amount: 0,
              name: task.title,
              details: details
            });
          }
        }
      });
      
      // Mark pinned items
      actionItems.forEach(item => {
        item.pinned = pinnedItems.some(p => 
          p.item_type === item.type && p.item_id.toString() === item.id.toString()
        );
        if (item.pinned) {
          const pinnedRecord = pinnedItems.find(p => 
            p.item_type === item.type && p.item_id.toString() === item.id.toString()
          );
          item.pinnedAt = pinnedRecord ? new Date(pinnedRecord.pinned_at) : new Date();
        }
      });
      
      // Separate pinned and unpinned
      const pinnedList = actionItems.filter(i => i.pinned).sort((a, b) => a.pinnedAt - b.pinnedAt);
      const unpinnedList = actionItems.filter(i => !i.pinned).sort((a, b) => a.priority - b.priority);
      
      // Render
      if (actionItems.length === 0) {
        container.innerHTML = '<div class="empty-state" style="padding: 40px 20px; text-align: center;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 48px; height: 48px; color: var(--accent-green); margin-bottom: 12px;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg><div style="color: var(--text-muted);">No action items - you\'re all caught up!</div></div>';
        return;
      }
      
      let html = '';
      let rank = 1;
      
      // Render pinned items first
      pinnedList.forEach(item => {
        html += renderPriorityQueueItem(item, rank++, true);
      });
      
      // Add divider if there are both pinned and unpinned
      if (pinnedList.length > 0 && unpinnedList.length > 0) {
        html += '<div class="pq-pinned-divider">Suggested</div>';
      }
      
      // Render unpinned items
      unpinnedList.forEach(item => {
        html += renderPriorityQueueItem(item, rank++, false);
      });
      
      container.innerHTML = html;
    }
    
    function renderPriorityQueueItem(item, rank, isPinned) {
      const isUrgent = !isPinned && item.priority <= 3;
      const docTypeLabel = item.type === 'submission' ? 'Submission' : 
                          item.type === 'quote' ? 'Quote #' + item.data.doc_id : 
                          item.type === 'task' ? 'Task' :
                          'Invoice #' + item.data.doc_id;
      
      const clickHandler = item.type === 'submission' ? `viewSubmission('${item.data.submission_id}')` :
                          item.type === 'quote' ? `viewQuote(${item.data.doc_id})` :
                          item.type === 'task' ? `viewTask('${item.data.task_id}')` :
                          `viewInvoice(${item.data.doc_id})`;
      
      const pinIcon = `<svg viewBox="0 0 24 24" fill="${isPinned ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2"><path d="M12 17v5M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z"/></svg>`;
      
      return `
        <div class="pq-item ${isPinned ? 'pinned' : ''}" onclick="${clickHandler}">
          <div class="pq-rank ${isUrgent ? 'urgent' : ''}">${rank}</div>
          <div class="pq-content">
            <div class="pq-action-row">
              <div class="pq-action-badge ${item.actionInfo.action}">
                ${item.actionInfo.icon}
                ${item.actionInfo.label}
              </div>
              <div class="pq-doc-type">${docTypeLabel}</div>
            </div>
            <div class="pq-customer">${item.name || 'Unknown'}</div>
            <div class="pq-details">${item.details || ''}</div>
          </div>
          <div class="pq-amount">${item.amount > 0 ? '$' + formatNumber(item.amount) : ''}</div>
          <div class="pq-pin ${isPinned ? 'pinned' : ''}" onclick="event.stopPropagation(); togglePin('${item.type}', '${item.id}', ${isPinned})" title="${isPinned ? 'Unpin' : 'Pin to top'}">
            ${pinIcon}
          </div>
          ${item.type === 'task' ? `
          <div class="pq-complete" onclick="event.stopPropagation(); completeTask('${item.id}')" title="Mark Complete">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
          </div>
          ` : ''}
          <div class="pq-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
        </div>
      `;
    }
    
    function togglePin(itemType, itemId, currentlyPinned) {
      // Immediate optimistic UI update
      if (currentlyPinned) {
        pinnedItems = pinnedItems.filter(p => 
          !(p.item_type === itemType && p.item_id.toString() === itemId.toString())
        );
        showToast('Unpinned', 'success');
        renderPriorityQueue();
        
        // Then sync with server
        google.script.run
          .withFailureHandler(function(error) {
            // Revert on failure
            pinnedItems.push({ item_type: itemType, item_id: itemId, pinned_at: new Date() });
            renderPriorityQueue();
            showToast('Error: ' + error, 'error');
          })
          .unpinItem(itemType, itemId);
      } else {
        pinnedItems.push({ item_type: itemType, item_id: itemId, pinned_at: new Date() });
        showToast('Pinned to top', 'success');
        renderPriorityQueue();
        
        // Then sync with server
        google.script.run
          .withFailureHandler(function(error) {
            // Revert on failure
            pinnedItems = pinnedItems.filter(p => 
              !(p.item_type === itemType && p.item_id.toString() === itemId.toString())
            );
            renderPriorityQueue();
            showToast('Error: ' + error, 'error');
          })
          .pinItem(itemType, itemId);
      }
    }
      
    
    function renderWaitingSection() {
      const section = document.getElementById('waiting-section');
      const grid = document.getElementById('waiting-grid');
      const totalEl = document.getElementById('waiting-total');
      
      // Collect waiting items
      let waitingItems = [];
      
      (allQuotes || []).forEach(quote => {
        const bucket = inferBucket(quote);
        if (bucket === 'WAITING_ON_CUSTOMER') {
          waitingItems.push({
            type: 'quote',
            data: quote,
            name: quote.customer_name,
            amount: quote.total || 0,
            viewed: !!quote.viewed_at,
            meta: 'Quote ' + quote.doc_id + ' - Sent ' + (quote.sent_at ? formatRelativeDate(quote.sent_at) : '')
          });
        }
      });
      
      (allInvoices || []).forEach(inv => {
        const bucket = inferBucket(inv);
        if (bucket === 'WAITING_ON_CUSTOMER') {
          waitingItems.push({
            type: 'invoice',
            data: inv,
            name: inv.customer_name,
            amount: inv.total || 0,
            viewed: !!inv.viewed_at,
            meta: 'Invoice ' + inv.doc_id + ' - Sent ' + (inv.sent_at ? formatRelativeDate(inv.sent_at) : '')
          });
        }
      });
      
      if (waitingItems.length === 0) {
        section.style.display = 'none';
        return;
      }
      
      section.style.display = 'block';
      
      // Calculate total
      const total = waitingItems.reduce((sum, item) => sum + item.amount, 0);
      totalEl.textContent = '$' + formatNumber(total);
      
      // Render cards
      let html = '';
      waitingItems.forEach(item => {
        const clickHandler = item.type === 'quote' ? `viewQuote(${item.data.doc_id})` : `viewInvoice(${item.data.doc_id})`;
        
        const eyeIcon = item.viewed 
          ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>'
          : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>';
        
        html += `
          <div class="waiting-card" onclick="${clickHandler}">
            <div class="waiting-viewed-icon ${item.viewed ? 'viewed' : ''}" title="${item.viewed ? 'Viewed by customer' : 'Not yet viewed'}">
              ${eyeIcon}
            </div>
            <div class="waiting-info">
              <div class="waiting-name">${item.name || 'Unknown'}</div>
              <div class="waiting-meta">${item.meta}</div>
            </div>
            <div class="waiting-amount">$${formatNumber(item.amount)}</div>
          </div>
        `;
      });
      
      grid.innerHTML = html;
    }
    
    function formatRelativeDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) return 'today';
      if (diffDays === 1) return 'yesterday';
      if (diffDays < 7) return diffDays + ' days ago';
      if (diffDays < 30) return Math.floor(diffDays / 7) + ' weeks ago';
      return Math.floor(diffDays / 30) + ' months ago';
    }
    
    function renderSnapshotMetrics() {
      const m = commandCenterMetrics;
      if (!m) return;
      
      // Get month name
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const currentMonth = monthNames[new Date().getMonth()];
      
      document.getElementById('metric-revenue').textContent = '$' + formatNumber(m.fwgMtdTotal || 0);
      document.getElementById('metric-revenue-label').textContent = currentMonth + ' Revenue';
      document.getElementById('metric-ppf-vinyl').textContent = '$' + formatNumber(m.bonusEligibleMtd || 0);
      document.getElementById('metric-bonus').textContent = '$' + formatNumber(m.bonus25Pct || 0);
      
      // Calculate pipeline value from dashboard summary
      let pipelineValue = 0;
      if (dashboardSummary && dashboardSummary.pipeline) {
        pipelineValue = (dashboardSummary.pipeline.quotes?.totalValue || 0) + 
                        (dashboardSummary.pipeline.invoices?.totalUnpaidValue || 0);
      }
      document.getElementById('metric-pipeline').textContent = '$' + formatNumber(pipelineValue);
    }
    
    function renderCategoryBreakdown() {
      const m = commandCenterMetrics;
      if (!m) return;
      
      const container = document.getElementById('category-list');
      const categories = m.categoryMtd || {};
      
      // Find max category value for bar scaling
      const maxCatValue = Math.max(...Object.values(categories), 1);
      
      // Sort categories by value descending
      const sortedCategories = Object.entries(categories).sort((a, b) => b[1] - a[1]);
      
      if (sortedCategories.length === 0) {
        container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px; padding: 10px 0;">No revenue recorded this month</div>';
        return;
      }
      
      let html = '';
      sortedCategories.forEach(([name, value]) => {
        const barWidth = Math.round((value / maxCatValue) * 100);
        html += `
          <div class="category-row">
            <div class="category-name">${name}</div>
            <div class="category-bar-container">
              <div class="category-bar" style="width: ${barWidth}%;"></div>
            </div>
            <div class="category-value">$${formatNumber(value)}</div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    function viewTask(taskId) {
      const task = (allTasks || []).find(t => t.task_id === taskId);
      if (!task) {
        showToast('Task not found', 'error');
        return;
      }
      
      // Populate modal
      document.getElementById('task-detail-id').value = task.task_id;
      document.getElementById('task-detail-title').value = task.title || '';
      document.getElementById('task-detail-description').value = task.description || '';
      document.getElementById('task-detail-status').value = task.status || 'TO_DO';
      document.getElementById('task-detail-priority').value = task.priority || 'NORMAL';
      
      // Handle due date
      if (task.due_date) {
        const dueDate = new Date(task.due_date);
        const formatted = dueDate.toISOString().split('T')[0];
        document.getElementById('task-detail-due-date').value = formatted;
      } else {
        document.getElementById('task-detail-due-date').value = '';
      }
      
      // Handle linked document
      const linkGroup = document.getElementById('task-detail-link-group');
      const linkDisplay = document.getElementById('task-detail-link-display');
      
      if (task.quote_id) {
        linkGroup.style.display = 'block';
        linkDisplay.innerHTML = `<a href="#" onclick="closeTaskDetailModal(); viewQuote(${task.quote_id}); return false;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
          Quote #${task.quote_id}
        </a>`;
      } else if (task.invoice_id) {
        linkGroup.style.display = 'block';
        linkDisplay.innerHTML = `<a href="#" onclick="closeTaskDetailModal(); viewInvoice(${task.invoice_id}); return false;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
          Invoice #${task.invoice_id}
        </a>`;
      } else if (task.submission_id) {
        linkGroup.style.display = 'block';
        linkDisplay.innerHTML = `<a href="#" onclick="closeTaskDetailModal(); viewSubmission('${task.submission_id}'); return false;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
          Submission ${task.submission_id}
        </a>`;
      } else {
        linkGroup.style.display = 'none';
      }
      
      // Show modal
      document.getElementById('task-detail-modal').classList.add('active');
    }
    
    function closeTaskDetailModal() {
      document.getElementById('task-detail-modal').classList.remove('active');
    }
    
    function updateTask() {
      const taskId = document.getElementById('task-detail-id').value;
      const title = document.getElementById('task-detail-title').value.trim();
      
      if (!title) {
        showToast('Please enter a task title', 'error');
        return;
      }
      
      const taskData = {
        task_id: taskId,
        title: title,
        description: document.getElementById('task-detail-description').value.trim(),
        status: document.getElementById('task-detail-status').value,
        priority: document.getElementById('task-detail-priority').value,
        due_date: document.getElementById('task-detail-due-date').value || null
      };
      
      const btn = document.getElementById('btn-update-task');
      btn.disabled = true;
      btn.textContent = 'Saving...';
      
      google.script.run
        .withSuccessHandler(function(result) {
          btn.disabled = false;
          btn.textContent = 'Save Changes';
          
          if (result && result.ok) {
            showToast('Task updated!', 'success');
            closeTaskDetailModal();
            loadPriorityQueue();
          } else {
            showToast(result?.error || 'Failed to update task', 'error');
          }
        })
        .withFailureHandler(function(error) {
          btn.disabled = false;
          btn.textContent = 'Save Changes';
          showToast('Error: ' + error, 'error');
        })
        .updateTask(taskData);
    }

    function completeTask(taskId) {
      if (!confirm('Mark this task as complete?')) return;
      
      // Optimistic UI - remove from allTasks
      const taskIndex = allTasks.findIndex(t => t.task_id === taskId);
      const removedTask = taskIndex >= 0 ? allTasks.splice(taskIndex, 1)[0] : null;
      renderPriorityQueue();
      showToast('Task completed', 'success');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (!result.ok) {
            // Revert on failure
            if (removedTask) allTasks.push(removedTask);
            renderPriorityQueue();
            showToast('Error: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          // Revert on failure
          if (removedTask) allTasks.push(removedTask);
          renderPriorityQueue();
          showToast('Error: ' + error, 'error');
        })
        .completeTask(taskId);
    }

    function completeTaskFromModal() {
      const taskId = document.getElementById('task-detail-id').value;
      if (!taskId) return;
      
      completeTask(taskId);
      closeTaskDetailModal();
    }
    
    function deleteTask() {
      const taskId = document.getElementById('task-detail-id').value;
      const title = document.getElementById('task-detail-title').value;
      
      if (!confirm('Delete task "' + title + '"? This cannot be undone.')) {
        return;
      }
      
      const btn = document.getElementById('btn-delete-task');
      btn.disabled = true;
      btn.textContent = 'Deleting...';
      
      google.script.run
        .withSuccessHandler(function(result) {
          btn.disabled = false;
          btn.textContent = 'Delete';
          
          if (result && result.ok) {
            showToast('Task deleted', 'success');
            closeTaskDetailModal();
            loadPriorityQueue();
          } else {
            showToast(result?.error || 'Failed to delete task', 'error');
          }
        })
        .withFailureHandler(function(error) {
          btn.disabled = false;
          btn.textContent = 'Delete';
          showToast('Error: ' + error, 'error');
        })
        .deleteTask(taskId);
    }

    // ========================================================================
    // KANBAN PIPELINE RENDERING
    // ========================================================================
    
    function loadPipeline() {
      console.log('loadPipeline: loading data...');
      
      let loadedCount = 0;
      const totalLoads = 3;
      
      function checkAllLoaded() {
        loadedCount++;
        if (loadedCount >= totalLoads) {
          renderKanban();
        }
      }
      
      // Load submissions if not already loaded
      if (allSubmissions && allSubmissions.length > 0) {
        checkAllLoaded();
      } else {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.ok) {
              allSubmissions = result.submissions;
            }
            checkAllLoaded();
          })
          .withFailureHandler(function(error) {
            console.error('Failed to load submissions:', error);
            checkAllLoaded();
          })
          .getSubmissions();
      }
      
      // Load quotes if not already loaded
      if (allQuotes && allQuotes.length > 0) {
        checkAllLoaded();
      } else {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.ok) {
              allQuotes = result.documents;
            }
            checkAllLoaded();
          })
          .withFailureHandler(function(error) {
            console.error('Failed to load quotes:', error);
            checkAllLoaded();
          })
          .getDocuments({ docType: 'quote' });
      }
      
      // Load invoices if not already loaded
      if (allInvoices && allInvoices.length > 0) {
        checkAllLoaded();
      } else {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.ok) {
              allInvoices = result.documents;
            }
            checkAllLoaded();
          })
          .withFailureHandler(function(error) {
            console.error('Failed to load invoices:', error);
            checkAllLoaded();
          })
          .getDocuments({ docType: 'invoice' });
      }
    }
    
    function renderKanban() {
      const searchTerm = (document.getElementById('pipeline-search')?.value || '').toLowerCase();
      
      // Organize items by bucket
      const lanes = {
        new: [],
        action: [],
        waiting: [],
        production: [],
        cold: []
      };
      
      // Process submissions - New/In Progress go to "new"
      (allSubmissions || []).forEach(sub => {
        if (searchTerm && !matchesSearch(sub, searchTerm)) return;
        
        const card = {
          type: 'submission',
          id: sub.submission_id,
          name: sub.customer_name,
          desc: (sub.vehicle_year ? sub.vehicle_year + ' ' : '') + (sub.vehicle_make || '') + ' ' + (sub.vehicle_model || ''),
          amount: sub.price_range_max || 0,
          date: sub.created_at,
          viewed: false,
          data: sub
        };
        
        if (sub.status === 'New' || sub.status === 'In Progress') {
          lanes.new.push(card);
        }
        // Won/Lost/Quoted submissions don't appear in pipeline
      });
      
      // Process quotes
      (allQuotes || []).forEach(quote => {
        if (searchTerm && !matchesSearch(quote, searchTerm)) return;
        
        const bucket = inferBucket(quote);
        // Skip archived quotes
        if (bucket === 'ARCHIVE_WON' || bucket === 'ARCHIVE_LOST') return;
        
        const card = {
          type: 'quote',
          id: quote.doc_id,
          name: quote.customer_name,
          desc: quote.vehicle_description || quote.project_description || '',
          amount: quote.total || 0,
          date: quote.created_at,
          viewed: !!quote.viewed_at,
          status: quote.status,
          data: quote
        };
        
        if (bucket === 'READY_FOR_ACTION') {
          lanes.action.push(card);
        } else if (bucket === 'WAITING_ON_CUSTOMER') {
          lanes.waiting.push(card);
        } else if (bucket === 'COLD') {
          lanes.cold.push(card);
        }
      });
      
      // Process invoices
      (allInvoices || []).forEach(inv => {
        if (searchTerm && !matchesSearch(inv, searchTerm)) return;
        
        const bucket = inferBucket(inv);
        // Skip archived invoices
        if (bucket === 'ARCHIVE_WON' || bucket === 'ARCHIVE_LOST') return;
        
        const card = {
          type: 'invoice',
          id: inv.doc_id,
          name: inv.customer_name,
          desc: inv.vehicle_description || inv.project_description || '',
          amount: inv.total || 0,
          date: inv.created_at,
          viewed: !!inv.viewed_at,
          status: inv.status,
          data: inv
        };
        
        // Paid invoices go to "In Production"
        if (inv.status === 'Paid') {
          lanes.production.push(card);
        } else if (bucket === 'READY_FOR_ACTION') {
          lanes.action.push(card);
        } else if (bucket === 'WAITING_ON_CUSTOMER') {
          lanes.waiting.push(card);
        } else if (bucket === 'COLD') {
          lanes.cold.push(card);
        }
      });
      
      // Render main lanes
      renderKanbanLane('lane-new', lanes.new, 'lane-count-new');
      renderKanbanLane('lane-action', lanes.action, 'lane-count-action');
      renderKanbanLane('lane-waiting', lanes.waiting, 'lane-count-waiting');
      renderKanbanLane('lane-production', lanes.production, 'lane-count-production');
      
      // Render cold section (horizontal)
      renderColdSection(lanes.cold);
      
      // Update stats (cold not included in active count)
      const activeItems = lanes.new.length + lanes.action.length + lanes.waiting.length + lanes.production.length;
      const totalValue = [...lanes.new, ...lanes.action, ...lanes.waiting, ...lanes.production]
        .reduce((sum, card) => sum + (card.amount || 0), 0);
      
      document.getElementById('pipeline-total-value').textContent = '$' + formatNumber(totalValue);
      document.getElementById('pipeline-item-count').textContent = activeItems;
    }
    
    function renderColdSection(cards) {
      const section = document.getElementById('cold-section');
      const container = document.getElementById('lane-cold');
      const countEl = document.getElementById('lane-count-cold');
      
      if (!section || !container) return;
      
      if (cards.length === 0) {
        section.style.display = 'none';
        return;
      }
      
      section.style.display = 'block';
      countEl.textContent = cards.length + ' item' + (cards.length !== 1 ? 's' : '');
      
      // Sort by date descending
      cards.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
      
      let html = '';
      cards.forEach(card => {
        const clickHandler = card.type === 'submission' ? `viewSubmission('${card.id}')` :
                            card.type === 'quote' ? `viewQuote(${card.id})` :
                            `viewInvoice(${card.id})`;
        
        const dateStr = card.date ? formatRelativeDate(card.date) : '';
        
        html += `
          <div class="kanban-card" onclick="${clickHandler}">
            <div class="kanban-card-header">
              <span class="kanban-card-type ${card.type}">${card.type === 'submission' ? 'Submission' : card.type === 'quote' ? 'Quote' : 'Invoice'}</span>
              <span class="kanban-card-amount">${card.amount > 0 ? '$' + formatNumber(card.amount) : ''}</span>
            </div>
            <div class="kanban-card-name">${card.name || 'Unknown'}</div>
            <div class="kanban-card-desc">${card.desc || (card.status || '')}</div>
            <div class="kanban-card-footer">
              <span class="kanban-card-date">${dateStr}</span>
              <span class="kanban-card-viewed ${card.viewed ? 'viewed' : ''}" title="${card.viewed ? 'Viewed by customer' : 'Not yet viewed'}">
                ${card.viewed 
                  ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>'
                  : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>'
                }
              </span>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    function renderKanbanLane(containerId, cards, countId) {
      const container = document.getElementById(containerId);
      const countEl = document.getElementById(countId);
      
      if (!container) return;
      
      countEl.textContent = cards.length;
      
      if (cards.length === 0) {
        container.innerHTML = '<div class="kanban-empty">No items</div>';
        return;
      }
      
      // Sort by date descending (newest first)
      cards.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
      
      const snowflakeIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M2 12h20M12 2l4 4M12 2l-4 4M12 22l4-4M12 22l-4-4M2 12l4 4M2 12l4-4M22 12l-4 4M22 12l-4-4"></path></svg>';
      
      let html = '';
      cards.forEach(card => {
        const clickHandler = card.type === 'submission' ? `viewSubmission('${card.id}')` :
                            card.type === 'quote' ? `viewQuote(${card.id})` :
                            `viewInvoice(${card.id})`;
        
        const dateStr = card.date ? formatRelativeDate(card.date) : '';
        
        // Only show cold button for quotes and invoices (not submissions)
        const showColdBtn = card.type === 'quote' || card.type === 'invoice';
        
        html += `
          <div class="kanban-card" onclick="${clickHandler}">
            <div class="kanban-card-header">
              <span class="kanban-card-type ${card.type}">${card.type === 'submission' ? 'Submission ' + card.id : card.type === 'quote' ? 'Quote ' + card.id : 'Invoice ' + card.id}</span>
              <span class="kanban-card-amount">${card.amount > 0 ? '$' + formatNumber(card.amount) : ''}</span>
            </div>
            <div class="kanban-card-name">${card.name || 'Unknown'}</div>
            <div class="kanban-card-desc">${card.desc || (card.status || '')}</div>
            <div class="kanban-card-footer">
              <span class="kanban-card-date">${dateStr}</span>
              <div class="kanban-card-actions">
                <span class="kanban-card-viewed ${card.viewed ? 'viewed' : ''}" title="${card.viewed ? 'Viewed by customer' : 'Not yet viewed'}">
                  ${card.viewed 
                    ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>'
                    : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>'
                  }
                </span>
                ${showColdBtn ? `<span class="kanban-card-cold-btn" onclick="event.stopPropagation(); moveToCold('${card.type}', ${card.id})" title="Move to Cold">${snowflakeIcon}</span>` : ''}
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    function matchesSearch(item, term) {
      const searchFields = [
        item.customer_name,
        item.company_name,
        item.customer_email,
        item.vehicle_description,
        item.project_description,
        item.vehicle_make,
        item.vehicle_model
      ];
      
      return searchFields.some(field => 
        field && field.toString().toLowerCase().includes(term)
      );
    }
    
    function filterPipeline() {
      renderKanban();
    }

    function moveToCold(itemType, itemId) {
      if (!confirm('Move this ' + itemType + ' to Cold?')) {
        return;
      }
      
      showToast('Moving to cold...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.ok) {
            showToast('Moved to Cold', 'success');
            // Update local data and re-render
            if (itemType === 'quote') {
              const quote = allQuotes.find(q => q.doc_id == itemId);
              if (quote) quote.bucket = 'COLD';
            } else if (itemType === 'invoice') {
              const inv = allInvoices.find(i => i.doc_id == itemId);
              if (inv) inv.bucket = 'COLD';
            }
            renderKanban();
          } else {
            showToast(result?.error || 'Failed to move to cold', 'error');
          }
        })
        .withFailureHandler(function(error) {
          showToast('Error: ' + error, 'error');
        })
        .updateDocumentBucket(itemId, 'COLD');
    }


    
    function openAddTaskModal() {
      // Reset form
      document.getElementById('task-title').value = '';
      document.getElementById('task-description').value = '';
      document.getElementById('task-priority').value = 'NORMAL';
      document.getElementById('task-due-date').value = '';
      document.getElementById('task-link-type').value = '';
      document.getElementById('task-link-id').value = '';
      document.getElementById('task-link-select-group').style.display = 'none';
      
      // Show modal
      document.getElementById('add-task-modal').classList.add('active');
    }
    
    function closeAddTaskModal() {
      document.getElementById('add-task-modal').classList.remove('active');
    }
    
    function updateTaskLinkOptions() {
      const linkType = document.getElementById('task-link-type').value;
      const selectGroup = document.getElementById('task-link-select-group');
      const selectEl = document.getElementById('task-link-id');
      
      if (!linkType) {
        selectGroup.style.display = 'none';
        return;
      }
      
      selectGroup.style.display = 'block';
      selectEl.innerHTML = '<option value="">Loading...</option>';
      
      let options = '<option value="">Select...</option>';
      
      if (linkType === 'quote') {
        (allQuotes || []).forEach(q => {
          options += `<option value="${q.doc_id}">Quote #${q.doc_id} - ${q.customer_name}</option>`;
        });
      } else if (linkType === 'invoice') {
        (allInvoices || []).forEach(inv => {
          options += `<option value="${inv.doc_id}">Invoice #${inv.doc_id} - ${inv.customer_name}</option>`;
        });
      } else if (linkType === 'submission') {
        (allSubmissions || []).forEach(sub => {
          options += `<option value="${sub.submission_id}">${sub.submission_id} - ${sub.customer_name}</option>`;
        });
      }
      
      selectEl.innerHTML = options;
    }
    
    function saveNewTask() {
      const title = document.getElementById('task-title').value.trim();
      if (!title) {
        showToast('Please enter a task title', 'error');
        return;
      }
      
      const taskData = {
        title: title,
        description: document.getElementById('task-description').value.trim(),
        priority: document.getElementById('task-priority').value,
        due_date: document.getElementById('task-due-date').value || null,
        status: 'TO_DO'
      };
      
      // Add link if selected
      const linkType = document.getElementById('task-link-type').value;
      const linkId = document.getElementById('task-link-id').value;
      if (linkType && linkId) {
        if (linkType === 'quote') taskData.quote_id = parseInt(linkId);
        else if (linkType === 'invoice') taskData.invoice_id = parseInt(linkId);
        else if (linkType === 'submission') taskData.submission_id = linkId;
      }
      
      // Disable button while saving
      const btn = document.getElementById('btn-save-task');
      btn.disabled = true;
      btn.textContent = 'Creating...';
      
      google.script.run
        .withSuccessHandler(function(result) {
          btn.disabled = false;
          btn.textContent = 'Create Task';
          
          if (result && result.ok) {
            showToast('Task created!', 'success');
            closeAddTaskModal();
            // Refresh priority queue to show new task
            loadPriorityQueue();
          } else {
            showToast(result?.error || 'Failed to create task', 'error');
          }
        })
        .withFailureHandler(function(error) {
          btn.disabled = false;
          btn.textContent = 'Create Task';
          showToast('Error: ' + error, 'error');
        })
        .createTask(taskData);
    }
    
    // ========================================================================
    // RENDERING
    // ========================================================================
    function renderSummaryCards() {
      const s = dashboardSummary;
      const html = `
        <div class="summary-card" onclick="showView('submissions')" title="View new submissions">
          <div class="summary-card-icon blue">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
          </div>
          <div class="summary-card-content">
            <div class="summary-card-value">${s.newSubmissions}</div>
            <div class="summary-card-label">New Submissions</div>
          </div>
        </div>
        <div class="summary-card" onclick="showView('submissions')" title="View in-progress submissions">
          <div class="summary-card-icon yellow">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
            </svg>
          </div>
          <div class="summary-card-content">
            <div class="summary-card-value">${s.inProgressSubmissions}</div>
            <div class="summary-card-label">In Progress</div>
          </div>
        </div>
        <div class="summary-card" onclick="showView('quotes')" title="View pending quotes">
          <div class="summary-card-icon purple">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
            </svg>
          </div>
          <div class="summary-card-content">
            <div class="summary-card-value">${s.pendingQuotes}</div>
            <div class="summary-card-label">Pending Quotes</div>
          </div>
        </div>
        <div class="summary-card" onclick="showView('invoices')" title="View unpaid invoices">
          <div class="summary-card-icon red">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
              <line x1="1" y1="10" x2="23" y2="10"></line>
            </svg>
          </div>
          <div class="summary-card-content">
            <div class="summary-card-value">${s.unpaidInvoices}</div>
            <div class="summary-card-label">Unpaid Invoices</div>
          </div>
        </div>
        <div class="summary-card" onclick="showView('invoices')" title="View invoices">
          <div class="summary-card-icon cyan">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
          </div>
          <div class="summary-card-content">
            <div class="summary-card-value">$${s.paidThisMonth.toLocaleString()}</div>
            <div class="summary-card-label">Collected This Month</div>
          </div>
        </div>
      `;
      document.getElementById('summary-grid').innerHTML = html;
    }
    
    function renderCommandCenter() {
      const m = commandCenterMetrics;
      if (!m) return;
      
      const a = m.actionItems || {};
      const categories = m.categoryMtd || {};
      
      // Find max category value for bar scaling
      const maxCatValue = Math.max(...Object.values(categories), 1);
      
      // Sort categories by value descending
      const sortedCategories = Object.entries(categories)
        .sort((a, b) => b[1] - a[1]);
      
      // Build category rows HTML
      let categoryRowsHtml = '';
      if (sortedCategories.length === 0) {
        categoryRowsHtml = '<div style="color: var(--text-muted); font-size: 13px; padding: 10px 0;">No revenue recorded this month</div>';
      } else {
        sortedCategories.forEach(([name, value]) => {
          const barWidth = Math.round((value / maxCatValue) * 100);
          categoryRowsHtml += `
            <div class="category-row">
              <div class="category-name">${name}</div>
              <div class="category-bar-container">
                <div class="category-bar" style="width: ${barWidth}%;"></div>
              </div>
              <div class="category-value">$${formatNumber(value)}</div>
            </div>
          `;
        });
      }
      
      const html = `
        <!-- Action Required -->
        <div class="cc-section">
          <div class="cc-section-title">Action Required</div>
          <div class="action-items">
            <div class="action-item ${a.newSubmissions > 0 ? 'has-items' : ''}" onclick="showView('submissions')" title="View new submissions">
              <div class="action-item-count">${a.newSubmissions}</div>
              <div class="action-item-label">New Submissions</div>
            </div>
            <div class="action-item ${a.approvedQuotes > 0 ? 'has-items' : ''}" onclick="showView('quotes')" title="Approved quotes - convert to invoice">
              <div class="action-item-count">${a.approvedQuotes}</div>
              <div class="action-item-label">Approved Quotes</div>
            </div>
            <div class="action-item ${a.viewedQuotes > 0 ? 'has-items' : ''}" onclick="showView('quotes')" title="Customer viewed - follow up">
              <div class="action-item-count">${a.viewedQuotes}</div>
              <div class="action-item-label">Viewed Quotes</div>
            </div>
            <div class="action-item ${a.unpaidInvoices > 0 ? 'has-items' : ''}" onclick="showView('invoices')" title="View unpaid invoices">
              <div class="action-item-count">${a.unpaidInvoices}</div>
              <div class="action-item-label">Unpaid Invoices</div>
            </div>
          </div>
        </div>
        
        <!-- Metrics -->
        <div class="cc-section">
          <div class="cc-section-title">January Metrics</div>
          <div class="metrics-row">
            <div class="metric-card">
              <div class="metric-value">$${formatNumber(m.fwgMtdTotal)}</div>
              <div class="metric-label">FWG MTD Revenue</div>
            </div>
            <div class="metric-card">
              <div class="metric-value">$${formatNumber(m.bonusEligibleMtd)}</div>
              <div class="metric-label">PPF & Vinyl Total</div>
            </div>
            <div class="metric-card">
              <div class="metric-value green">$${formatNumber(m.bonus25Pct)}</div>
              <div class="metric-label">2.5% Bonus</div>
            </div>
          </div>
        </div>
        
        <!-- MTD by Category -->
        <div class="cc-section">
          <div class="cc-section-title">MTD by Category</div>
          <div class="category-list">
            ${categoryRowsHtml}
          </div>
        </div>
      `;
      
      document.getElementById('command-center').innerHTML = html;
      
      // Render pipeline section if data available
      if (dashboardSummary && dashboardSummary.pipeline) {
        renderPipelineSnapshot(dashboardSummary);
      }
    }
    
    function renderPipelineSnapshot(s) {
      const p = s.pipeline;
      if (!p) return;
      
      document.getElementById('pipeline-section').style.display = 'block';
      
      const html = `
        <!-- Quotes Pipeline -->
        <div class="pipeline-card">
          <div class="pipeline-card-header">
            <div class="pipeline-card-title">Quotes Pipeline</div>
            <div class="pipeline-card-value">$${p.quotes.totalValue.toLocaleString()}</div>
          </div>
          <div class="pipeline-buckets">
            <div class="pipeline-bucket-row" onclick="showView('quotes'); document.getElementById('quotes-bucket-filter').value='READY_FOR_ACTION'; filterQuotes();">
              <div class="pipeline-bucket-label">
                <span class="pipeline-bucket-dot action"></span>
                Action Needed
              </div>
              <div class="pipeline-bucket-count ${p.quotes.readyForAction > 0 ? 'highlight' : ''}">${p.quotes.readyForAction}</div>
            </div>
            <div class="pipeline-bucket-row" onclick="showView('quotes'); document.getElementById('quotes-bucket-filter').value='WAITING_ON_CUSTOMER'; filterQuotes();">
              <div class="pipeline-bucket-label">
                <span class="pipeline-bucket-dot waiting"></span>
                Waiting on Customer
              </div>
              <div class="pipeline-bucket-count">${p.quotes.waitingOnCustomer}</div>
            </div>
            <div class="pipeline-bucket-row" onclick="showView('quotes'); document.getElementById('quotes-bucket-filter').value='COLD'; filterQuotes();">
              <div class="pipeline-bucket-label">
                <span class="pipeline-bucket-dot cold"></span>
                Cold
              </div>
              <div class="pipeline-bucket-count">${p.quotes.cold}</div>
            </div>
            ${s.approvedQuotes > 0 ? `
            <div class="pipeline-bucket-row" onclick="showView('quotes'); document.getElementById('quotes-status-filter').value='Approved'; filterQuotes();" style="background:rgba(16,185,129,0.1);">
              <div class="pipeline-bucket-label">
                <span class="pipeline-bucket-dot approved"></span>
                Approved - Ready to Convert
              </div>
              <div class="pipeline-bucket-count" style="color:#10b981;">${s.approvedQuotes}</div>
            </div>
            ` : ''}
            ${s.viewedQuotes > 0 ? `
            <div class="pipeline-bucket-row" onclick="showView('quotes'); document.getElementById('quotes-status-filter').value='Viewed'; filterQuotes();">
              <div class="pipeline-bucket-label">
                <span class="pipeline-bucket-dot viewed"></span>
                Viewed - Awaiting Response
              </div>
              <div class="pipeline-bucket-count">${s.viewedQuotes}</div>
            </div>
            ` : ''}
          </div>
        </div>
        
        <!-- Invoices Pipeline -->
        <div class="pipeline-card">
          <div class="pipeline-card-header">
            <div class="pipeline-card-title">Invoices Pipeline</div>
            <div class="pipeline-card-value">$${p.invoices.totalUnpaidValue.toLocaleString()}</div>
          </div>
          <div class="pipeline-buckets">
            <div class="pipeline-bucket-row" onclick="showView('invoices'); document.getElementById('invoices-bucket-filter').value='READY_FOR_ACTION'; filterInvoices();">
              <div class="pipeline-bucket-label">
                <span class="pipeline-bucket-dot action"></span>
                Action Needed
              </div>
              <div class="pipeline-bucket-count ${p.invoices.readyForAction > 0 ? 'highlight' : ''}">${p.invoices.readyForAction}</div>
            </div>
            <div class="pipeline-bucket-row" onclick="showView('invoices'); document.getElementById('invoices-bucket-filter').value='WAITING_ON_CUSTOMER'; filterInvoices();">
              <div class="pipeline-bucket-label">
                <span class="pipeline-bucket-dot waiting"></span>
                Waiting on Customer
              </div>
              <div class="pipeline-bucket-count">${p.invoices.waitingOnCustomer}</div>
            </div>
            <div class="pipeline-bucket-row" onclick="showView('invoices'); document.getElementById('invoices-bucket-filter').value='COLD'; filterInvoices();">
              <div class="pipeline-bucket-label">
                <span class="pipeline-bucket-dot cold"></span>
                Cold
              </div>
              <div class="pipeline-bucket-count">${p.invoices.cold}</div>
            </div>
          </div>
          ${s.needsFollowUp > 0 ? `
          <div class="pipeline-alert" onclick="showView('quotes');">
            <svg class="pipeline-alert-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
              <line x1="12" y1="9" x2="12" y2="13"></line>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            <span class="pipeline-alert-text">${s.needsFollowUp} document${s.needsFollowUp > 1 ? 's' : ''} need follow-up (3+ days waiting)</span>
          </div>
          ` : ''}
        </div>
      `;
      
      document.getElementById('pipeline-grid').innerHTML = html;
    }

    function formatNumber(num) {
      if (num === undefined || num === null) return '0';
      return Number(num).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }
    
    function renderRecentSubmissions(submissions) {
      const container = document.getElementById('recent-submissions');
      
      if (!submissions || submissions.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:48px;height:48px;color:#64748b;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></div><div class="empty-state-title">No Submissions Yet</div><div class="empty-state-text">Submissions from the estimator will appear here.</div></div>';
        return;
      }
      
      let html = '<table class="data-table"><thead><tr><th>Customer</th><th>Vehicle</th><th>Project</th><th>Status</th><th>Date</th></tr></thead><tbody>';
      
      submissions.forEach(sub => {
        const statusClass = sub.status.toLowerCase().replace(' ', '-');
        const date = sub.created_at ? new Date(sub.created_at).toLocaleDateString() : '-';
        
        html += `
          <tr onclick="viewSubmission('${sub.submission_id}')" style="cursor:pointer;">
            <td>
              <div class="customer-cell">
                <span class="customer-name">${sub.customer_name || '-'}</span>
                <span class="customer-company">${sub.company_name || ''}</span>
              </div>
            </td>
            <td>
              <div class="vehicle-cell">
                <span class="vehicle-type">${sub.vehicle_category || '-'}</span>
                <span class="vehicle-details">${sub.vehicle_year || ''} ${sub.vehicle_make || ''} ${sub.vehicle_model || ''}</span>
              </div>
            </td>
            <td>${sub.project_type || '-'}</td>
            <td><span class="status-pill ${statusClass}">${sub.status}</span></td>
            <td class="date-cell">${date}</td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }
    
    function renderSubmissionsTable(submissions) {
      const container = document.getElementById('submissions-table');
      
      if (!submissions || submissions.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:48px;height:48px;color:#64748b;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></div><div class="empty-state-title">No Submissions</div><div class="empty-state-text">Submissions from the estimator will appear here.</div></div>';
        return;
      }
      
      let html = `
        <table class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Customer</th>
              <th>Vehicle</th>
              <th>Project</th>
              <th>Price Range</th>
              <th>Status</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      submissions.forEach(sub => {
        const statusClass = sub.status.toLowerCase().replace(' ', '-');
        const date = sub.created_at ? new Date(sub.created_at).toLocaleDateString() : '-';
        const priceRange = sub.price_range_min && sub.price_range_max 
          ? `$${Number(sub.price_range_min).toLocaleString()} - $${Number(sub.price_range_max).toLocaleString()}`
          : '-';
        
        html += `
          <tr>
            <td><code style="font-size:12px;color:var(--text-muted);">${sub.submission_id}</code></td>
            <td>
              <div class="customer-cell">
                <span class="customer-name">${sub.customer_name || '-'}</span>
                <span class="customer-company">${sub.company_name || ''}</span>
              </div>
            </td>
            <td>
              <div class="vehicle-cell">
                <span class="vehicle-type">${sub.vehicle_category || '-'}</span>
                <span class="vehicle-details">${sub.vehicle_year || ''} ${sub.vehicle_make || ''} ${sub.vehicle_model || ''}</span>
              </div>
            </td>
            <td>${sub.project_type || '-'}</td>
            <td class="price-range">${priceRange}</td>
            <td><span class="status-pill ${statusClass}">${sub.status}</span></td>
            <td class="date-cell">${date}</td>
            <td class="actions-cell">
              <button class="btn btn-secondary btn-sm" onclick="viewSubmission('${sub.submission_id}')">View</button>
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }
    
    function filterSubmissions() {
      const search = document.getElementById('submissions-search').value.toLowerCase();
      const statusFilter = document.getElementById('submissions-status-filter').value;
      
      let filtered = allSubmissions;
      
      if (statusFilter) {
        filtered = filtered.filter(s => s.status === statusFilter);
      }
      
      if (search) {
        filtered = filtered.filter(s => 
          (s.customer_name || '').toLowerCase().includes(search) ||
          (s.company_name || '').toLowerCase().includes(search) ||
          (s.customer_email || '').toLowerCase().includes(search) ||
          (s.customer_phone || '').includes(search)
        );
      }
      
      renderSubmissionsTable(filtered);
    }
    
    // ========================================================================
    // ACTIONS
    // ========================================================================
    function viewSubmission(submissionId) {
      openSubmissionModal(submissionId);
    }

    // ========================================================================
    // QUOTES FUNCTIONS
    // ========================================================================
    let allQuotes = [];
    let allTasks = [];
    let pinnedItems = [];
    
    function loadQuotes() {
      const container = document.getElementById('quotes-table');
      container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading quotes...</div>';
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.ok) {
            allQuotes = result.documents;
            renderQuotesTable(result.documents);
          } else {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:48px;height:48px;color:#eab308;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg></div><div class="empty-state-title">Error</div><div class="empty-state-text">' + (result ? result.error : 'Unknown error') + '</div></div>';
          }
        })
        .withFailureHandler(function(error) {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:48px;height:48px;color:#eab308;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg></div><div class="empty-state-title">Error</div><div class="empty-state-text">' + error + '</div></div>';
        })
        .getDocuments({ doc_type: 'quote' });
    }
    
    function renderQuotesTable(quotes) {
      const container = document.getElementById('quotes-table');
      
      if (!quotes || quotes.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:48px;height:48px;color:#64748b;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg></div><div class="empty-state-title">No Quotes Yet</div><div class="empty-state-text">Create your first quote from a submission or click "+ New Quote".</div></div>';
        return;
      }
      
      let html = '<table class="data-table"><thead><tr><th>Quote #</th><th>Customer</th><th>Project</th><th>Total</th><th>Status</th><th>Bucket</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
      
      quotes.forEach(q => {
        const statusClass = (q.status || 'draft').toLowerCase();
        const date = q.created_at ? new Date(q.created_at).toLocaleDateString() : '-';
        const total = q.total ? '$' + Number(q.total).toLocaleString() : '-';
        
        // Build indicator badges
        let indicators = '';
        if (q.viewed_at && q.status !== 'Approved' && q.status !== 'Declined') {
          indicators += '<span class="indicator-badge viewed">Viewed</span>';
        }
        if (q.status === 'Approved') {
          indicators += '<span class="indicator-badge approved">Approved</span>';
        }
        if (q.status === 'Declined') {
          indicators += '<span class="indicator-badge declined">Declined</span>';
        }
        // Check for revision request in revision_history_json
        if (q.revision_history_json) {
          try {
            const history = JSON.parse(q.revision_history_json);
            const hasCustomerRevision = history.some(h => h.from === 'customer');
            if (hasCustomerRevision && q.status !== 'Approved') {
              indicators += '<span class="indicator-badge revision">Revision</span>';
            }
          } catch(e) {}
        }
        // Follow-up indicator
        if (q.bucket === 'WAITING_ON_CUSTOMER' && q.sent_at) {
          const daysSinceSent = Math.floor((Date.now() - new Date(q.last_followup_at || q.sent_at).getTime()) / (1000 * 60 * 60 * 24));
          if (daysSinceSent >= 3) {
            indicators += '<span class="indicator-badge followup">' + daysSinceSent + 'd</span>';
          }
        }
        
        // Bucket badge
        const bucketBadge = formatBucketBadge(q.bucket, q);
        
        html += '<tr>';
        html += '<td><code style="font-size:12px;">' + q.doc_id + '</code></td>';
        html += '<td><div class="customer-cell"><span class="customer-name">' + (q.customer_name || '-') + indicators + '</span><span class="customer-company">' + (q.company_name || '') + '</span></div></td>';
        html += '<td>' + (q.project_description || '-') + '</td>';
        html += '<td style="font-weight:600;">' + total + '</td>';
        html += '<td><span class="status-pill ' + statusClass + '">' + (q.status || 'Draft') + '</span></td>';
        html += '<td>' + bucketBadge + '</td>';
        html += '<td class="date-cell">' + date + '</td>';
        html += '<td><button class="btn btn-secondary btn-sm" onclick="viewQuote(\'' + q.doc_id + '\')">View</button></td>';
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }
    
    function formatBucketBadge(bucket, doc) {
      const buckets = {
        'READY_FOR_ACTION': { label: 'Action Needed', class: 'ready-for-action' },
        'WAITING_ON_CUSTOMER': { label: 'Waiting', class: 'waiting-on-customer' },
        'COLD': { label: 'Cold', class: 'cold' },
        'ARCHIVE_WON': { label: 'Won', class: 'archive-won' },
        'ARCHIVE_LOST': { label: 'Lost', class: 'archive-lost' }
      };
      
      // If bucket is set, use it
      if (bucket && buckets[bucket]) {
        const b = buckets[bucket];
        return '<span class="bucket-badge ' + b.class + '">' + b.label + '</span>';
      }
      
      // Infer bucket from status for legacy docs without bucket set
      if (doc) {
        if (doc.status === 'Paid') {
          return '<span class="bucket-badge archive-won">Won</span>';
        }
        if (doc.status === 'Void' || doc.status === 'Declined' || doc.status === 'Expired') {
          return '<span class="bucket-badge archive-lost">Lost</span>';
        }
        if (doc.status === 'Sent' || doc.status === 'Viewed') {
          return '<span class="bucket-badge waiting-on-customer">Waiting</span>';
        }
      }
      
      // Default
      return '<span class="bucket-badge ready-for-action">Action Needed</span>';
    }
    
    // Helper to infer bucket from status for legacy docs
    function inferBucket(doc) {
      if (doc.bucket) return doc.bucket;
      if (doc.status === 'Paid') return 'ARCHIVE_WON';
      if (doc.status === 'Void' || doc.status === 'Declined' || doc.status === 'Expired') return 'ARCHIVE_LOST';
      
      if (doc.status === 'Sent' || doc.status === 'Viewed') {
        // Check if 14+ days old  COLD
        if (doc.sent_at) {
          const sentDate = new Date(doc.sent_at);
          const daysSinceSent = (new Date() - sentDate) / (1000 * 60 * 60 * 24);
          if (daysSinceSent >= 14) {
            return 'COLD';
          }
        }
        return 'WAITING_ON_CUSTOMER';
      }
      
      return 'READY_FOR_ACTION';
    }
    
    function filterQuotes() {
      const search = document.getElementById('quotes-search').value.toLowerCase();
      const statusFilter = document.getElementById('quotes-status-filter').value;
      const bucketFilter = document.getElementById('quotes-bucket-filter').value;
      
      let filtered = allQuotes;
      
      // Bucket filter
      if (bucketFilter === 'active') {
        // Show only active buckets (not archived)
        const activeBuckets = ['READY_FOR_ACTION', 'WAITING_ON_CUSTOMER', 'COLD'];
        filtered = filtered.filter(q => activeBuckets.includes(inferBucket(q)));
      } else if (bucketFilter) {
        filtered = filtered.filter(q => inferBucket(q) === bucketFilter);
      }
      
      if (statusFilter) {
        filtered = filtered.filter(q => q.status === statusFilter);
      }
      
      if (search) {
        filtered = filtered.filter(q => 
          (q.customer_name || '').toLowerCase().includes(search) ||
          (q.company_name || '').toLowerCase().includes(search) ||
          String(q.doc_id || '').toLowerCase().includes(search)
        );
      }
      
      renderQuotesTable(filtered);
    }
    
    function viewQuote(quoteId) {
      // Update nav
      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
      
      // Update views
      document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
      document.getElementById('view-quote-detail').classList.add('active');
      
      // Update header
      document.getElementById('header-title').textContent = 'Quote Details';
      
      // Load document detail (unified)
      if (typeof loadDocumentDetail === 'function') {
        loadDocumentDetail(quoteId);
      } else {
        console.error('loadDocumentDetail not found');
      }
    }
    
    function createNewQuote(customerData) {
      const btn = document.getElementById('btn-new-quote');
      let originalText = '';
      if (btn) {
        originalText = btn.innerHTML;
        btn.innerHTML = 'Creating...';
        btn.classList.add('btn-loading');
      }
      
      const docData = customerData || {};
      docData.doc_type = 'quote';
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (btn) {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-loading');
          }
          if (result.ok) {
            viewQuote(result.doc_id);
          } else {
            showToast('Error creating quote: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          if (btn) {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-loading');
          }
          showToast('Error: ' + error, 'error');
        })
        .createDocument(docData);
    }
    
    // Wrapper for customer view to call
    function openNewQuote(customerData) {
      createNewQuote(customerData);
    }
    
    // Create new invoice with optional customer data
    function openNewInvoice(customerData) {
      const docData = customerData || {};
      docData.doc_type = 'invoice';
      
      showToast('Creating invoice...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.ok) {
            viewInvoice(result.doc_id);
          } else {
            showToast('Error creating invoice: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showToast('Error: ' + error, 'error');
        })
        .createDocument(docData);
    }
    
    function formatProjectType(key) {
      const labels = {
        'FULL_WRAP': 'Full Wrap',
        'PARTIAL_WRAP': 'Partial Wrap',
        'LETTERING': 'Lettering & Graphics'
      };
      return labels[key] || key || '-';
    }
    
    // ========================================================================
    // INVOICES FUNCTIONS
    // ========================================================================
    let allInvoices = [];
    let invoiceScheduleStatus = {};
    
    function loadInvoices() {
      const container = document.getElementById('invoices-table');
      container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading invoices...</div>';
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.ok) {
            allInvoices = result.documents;
            // Fetch schedule status for all invoices
            const invoiceIds = allInvoices.map(inv => inv.doc_id);
            if (invoiceIds.length > 0) {
              google.script.run
                .withSuccessHandler(function(statusResult) {
                  if (statusResult && statusResult.ok) {
                    invoiceScheduleStatus = statusResult.status;
                  }
                  renderInvoicesTable(allInvoices);
                })
                .withFailureHandler(function() {
                  renderInvoicesTable(allInvoices);
                })
                .getInvoiceScheduleStatus(invoiceIds);
            } else {
              renderInvoicesTable(allInvoices);
            }
          } else {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:48px;height:48px;color:#eab308;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg></div><div class="empty-state-title">Error</div><div class="empty-state-text">' + (result ? result.error : 'Unknown error') + '</div></div>';
          }
        })
        .withFailureHandler(function(error) {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:48px;height:48px;color:#eab308;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg></div><div class="empty-state-title">Error</div><div class="empty-state-text">' + error + '</div></div>';
        })
        .getDocuments({ doc_type: 'invoice' });
    }
    
    function renderInvoicesTable(invoices) {
      const container = document.getElementById('invoices-table');
      
      if (!invoices || invoices.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:48px;height:48px;color:#64748b;"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg></div><div class="empty-state-title">No Invoices Yet</div><div class="empty-state-text">Invoices will appear here when you convert quotes.</div></div>';
        return;
      }
      
      let html = '<table class="data-table"><thead><tr><th>Invoice #</th><th>Customer</th><th>Total</th><th>Paid</th><th>Balance</th><th>Status</th><th>Bucket</th><th>Scheduled</th><th>Actions</th></tr></thead><tbody>';
      
      invoices.forEach(inv => {
        const statusClass = (inv.status || 'draft').toLowerCase();
        const total = inv.total ? '$' + Number(inv.total).toLocaleString() : '-';
        const amountPaid = '$' + Number(inv.amount_paid || 0).toLocaleString();
        const balanceDue = '$' + Number(inv.balance_due || 0).toLocaleString();
        const balanceClass = Number(inv.balance_due) <= 0 ? 'style="color:var(--accent-green);"' : 'style="color:var(--accent-red);"';
        
        // Build indicator badges
        let indicators = '';
        if (inv.viewed_at && inv.status !== 'Paid') {
          indicators += '<span class="indicator-badge viewed">Viewed</span>';
        }
        if (inv.status === 'Paid') {
          indicators += '<span class="indicator-badge approved">Paid</span>';
        }
        // Follow-up indicator for unpaid invoices
        if (inv.bucket === 'WAITING_ON_CUSTOMER' && inv.sent_at && inv.status !== 'Paid') {
          const daysSinceSent = Math.floor((Date.now() - new Date(inv.last_followup_at || inv.sent_at).getTime()) / (1000 * 60 * 60 * 24));
          if (daysSinceSent >= 3) {
            indicators += '<span class="indicator-badge followup">' + daysSinceSent + 'd</span>';
          }
        }
        
        // Bucket badge
        const bucketBadge = formatBucketBadge(inv.bucket, inv);
        
        // Schedule status badge
        const schedStatus = invoiceScheduleStatus[inv.doc_id];
        let schedBadge = '';
        if (schedStatus && schedStatus.scheduled && schedStatus.nextEvent) {
          const schedDate = new Date(schedStatus.nextEvent).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          schedBadge = '<span class="sched-badge scheduled"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg> ' + schedDate + '</span>';
        } else if (inv.status === 'Paid' || Number(inv.balance_due) <= 0) {
          schedBadge = '<span class="sched-badge needs-sched"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg> Needs Scheduling</span>';
        } else {
          schedBadge = '<span style="color:var(--text-muted);font-size:12px;">-</span>';
        }
        
        html += '<tr>';
        html += '<td><code style="font-size:12px;">' + inv.doc_id + '</code></td>';
        html += '<td><div class="customer-cell"><span class="customer-name">' + (inv.customer_name || '-') + indicators + '</span><span class="customer-company">' + (inv.company_name || '') + '</span></div></td>';
        html += '<td style="font-weight:600;">' + total + '</td>';
        html += '<td style="color:var(--accent-green);">' + amountPaid + '</td>';
        html += '<td ' + balanceClass + '>' + balanceDue + '</td>';
        html += '<td><span class="status-pill ' + statusClass + '">' + (inv.status || 'Draft') + '</span></td>';
        html += '<td>' + bucketBadge + '</td>';
        html += '<td>' + schedBadge + '</td>';
        html += '<td><button class="btn btn-secondary btn-sm" onclick="viewInvoice(\'' + inv.doc_id + '\')">View</button></td>';
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }
    
    function filterInvoices() {
      const search = document.getElementById('invoices-search').value.toLowerCase();
      const statusFilter = document.getElementById('invoices-status-filter').value;
      const bucketFilter = document.getElementById('invoices-bucket-filter').value;
      
      let filtered = allInvoices;
      
      // Bucket filter (uses same inferBucket helper as quotes)
      if (bucketFilter === 'active') {
        // Show only active buckets (not archived)
        const activeBuckets = ['READY_FOR_ACTION', 'WAITING_ON_CUSTOMER', 'COLD'];
        filtered = filtered.filter(inv => activeBuckets.includes(inferBucket(inv)));
      } else if (bucketFilter) {
        filtered = filtered.filter(inv => inferBucket(inv) === bucketFilter);
      }
      
      if (statusFilter) {
        filtered = filtered.filter(inv => inv.status === statusFilter);
      }
      
      if (search) {
        filtered = filtered.filter(inv => 
          (inv.customer_name || '').toLowerCase().includes(search) ||
          (inv.company_name || '').toLowerCase().includes(search) ||
          String(inv.doc_id || '').toLowerCase().includes(search)
        );
      }
      
      renderInvoicesTable(filtered);
    }
    
    function viewInvoice(invoiceId) {
      // Update nav
      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
      
      // Update views
      document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
      document.getElementById('view-quote-detail').classList.add('active');
      
      // Update header
      document.getElementById('header-title').textContent = 'Invoice Details';
      
      // Load document detail (unified) - uses same view as quotes
      if (typeof loadDocumentDetail === 'function') {
        loadDocumentDetail(invoiceId);
      } else {
        console.error('loadDocumentDetail not found');
      }
    }

    // ========================================================================
    // INITIALIZATION
    // ========================================================================
    document.addEventListener('DOMContentLoaded', function() {
      showView('overview');
      loadBadgeCounts();
    });

    // Debug: Check if loadDocumentDetail exists
    console.log('loadDocumentDetail exists:', typeof loadDocumentDetail);

// ========================================================================
    // PRODUCTION FLOW - NEW DESIGN WITH LIGHTBAR
    // ========================================================================
    
    let productionQueue = [];
    let productionCategories = [];
    
    function loadProductionQueue() {
      const container = document.getElementById('production-queue');
      container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading production queue...</div>';
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.ok) {
            productionQueue = result.queue || [];
            productionCategories = result.categories || [];
            renderProductionQueue();
            updateProductionStats();
            populateCategoryFilter();
          } else {
            container.innerHTML = '<div class="production-empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg><div>Error loading production queue</div></div>';
          }
        })
        .withFailureHandler(function(error) {
          container.innerHTML = '<div class="production-empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg><div>Error: ' + error + '</div></div>';
        })
        .getProductionQueue();
    }
    
    function renderProductionQueue() {
      const container = document.getElementById('production-queue');
      const searchTerm = (document.getElementById('production-search')?.value || '').toLowerCase();
      const categoryFilter = document.getElementById('production-category-filter')?.value || '';
      
      let filtered = productionQueue;
      
      if (searchTerm) {
        filtered = filtered.filter(job => 
          (job.customer_name || '').toLowerCase().includes(searchTerm) ||
          (job.vehicle_description || '').toLowerCase().includes(searchTerm) ||
          String(job.invoice_id).includes(searchTerm)
        );
      }
      
      if (categoryFilter) {
        filtered = filtered.filter(job => 
          job.task_groups && job.task_groups.some(g => g.category === categoryFilter)
        );
      }
      
      if (filtered.length === 0) {
        container.innerHTML = '<div class="production-empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg><div>No jobs in production</div><div style="font-size:13px;margin-top:8px;">Jobs appear here when invoices are paid or manually moved to production</div></div>';
        return;
      }
      
      let html = '';
      
      filtered.forEach(job => {
        const group = job.task_groups && job.task_groups[0] ? job.task_groups[0] : { tasks: [], category: 'General', category_label: 'General' };
        const tasks = group.tasks || [];
        const totalTasks = tasks.length;
        const completedTasks = tasks.filter(t => t.status === 'DONE').length;
        const progressPct = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
        const circumference = 188.5;
        const strokeOffset = circumference - (progressPct / 100) * circumference;
        
        // Determine which tasks to show initially (first 4) and which to hide
        const visibleTasks = tasks.slice(0, 4);
        const hiddenTasks = tasks.slice(4);
        const hasHiddenTasks = hiddenTasks.length > 0;
        
        // Find the next pending task
        const nextTaskIndex = tasks.findIndex(t => t.status !== 'DONE');
        
        html += `
          <div class="production-card" data-invoice-id="${job.invoice_id}">
            <div class="production-card-header" onclick="viewInvoice(${job.invoice_id})">
              <div class="progress-ring">
                <svg width="72" height="72">
                  <circle class="progress-ring-bg" cx="36" cy="36" r="30"/>
                  <circle class="progress-ring-fill" cx="36" cy="36" r="30" 
                          stroke-dasharray="${circumference}" stroke-dashoffset="${strokeOffset}"/>
                </svg>
                <div class="progress-ring-text">${progressPct}%</div>
              </div>
              <div class="production-card-info">
                <div class="production-card-title">${escapeHtml(job.customer_name || 'Unknown')}</div>
                <div class="production-card-meta">${escapeHtml(job.vehicle_description || job.project_description || '')} &bull; <span class="job-id">#${job.invoice_id}</span></div>
              </div>
              <div class="production-card-right">
                <div class="production-card-amount">$${formatNumber(job.total || 0)}</div>
                <div class="production-card-category">${escapeHtml(group.category_label || group.category)}</div>
              </div>
            </div>
            
            <div class="pipeline-section">
              <div class="pipeline">
                <div class="pipeline-track">
                  <div class="pipeline-fill" style="width: ${progressPct}%;"></div>
                </div>
        `;
        
        // Render pipeline steps (abbreviated labels)
        const stepLabels = getStepLabels(tasks);
        tasks.forEach((task, i) => {
          const isDone = task.status === 'DONE';
          const isActive = i === nextTaskIndex;
          const dotClass = isDone ? 'done' : (isActive ? 'active' : '');
          const labelClass = isDone ? 'done' : (isActive ? 'active' : '');
          
          html += `
                <div class="pipeline-step">
                  <div class="step-dot ${dotClass}"></div>
                  <div class="step-label ${labelClass}">${stepLabels[i]}</div>
                </div>
          `;
        });
        
        html += `
              </div>
            </div>
            
            <div class="task-section" id="tasks-${job.invoice_id}">
        `;
        
        // Render visible tasks
        visibleTasks.forEach((task, i) => {
          const isCompleted = task.status === 'DONE';
          const isNext = i === nextTaskIndex;
          
          html += renderTaskItem(task, isCompleted, isNext);
        });
        
        // Render hidden tasks
        hiddenTasks.forEach((task, i) => {
          const actualIndex = i + 4;
          const isCompleted = task.status === 'DONE';
          const isNext = actualIndex === nextTaskIndex;
          
          html += renderTaskItem(task, isCompleted, isNext, true);
        });
        
        html += `
            </div>
        `;
        
        // Add expand toggle if there are hidden tasks
        if (hasHiddenTasks) {
          html += `
            <div class="expand-toggle" onclick="toggleExpand(this, 'tasks-${job.invoice_id}')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 9l-7 7-7-7"/></svg>
              <span>Show ${hiddenTasks.length} more tasks</span>
            </div>
          `;
        }
        
        html += `
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    function renderTaskItem(task, isCompleted, isNext, isHidden = false) {
      const hiddenClass = isHidden ? 'hidden-task' : '';
      const completedClass = isCompleted ? 'completed' : '';
      const checkedClass = isCompleted ? 'checked' : '';
      
      let badgeHtml = '';
      if (isNext && !isCompleted) {
        badgeHtml = '<span class="production-task-badge next">Next</span>';
      } else if (task.has_automation) {
        badgeHtml = '<span class="production-task-badge auto">Auto</span>';
      }
      
      let metaHtml = '';
      if (isCompleted && task.completed_at) {
        metaHtml = `<div class="production-task-meta">Completed ${formatRelativeDate(task.completed_at)}</div>`;
      }
      
      return `
        <div class="production-task ${completedClass} ${hiddenClass}" data-task-id="${task.task_id}">
          <div class="production-task-checkbox ${checkedClass}" onclick="toggleProductionTask('${task.task_id}', event)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 13l4 4L19 7"/></svg>
          </div>
          <div class="production-task-content">
            <span class="production-task-name">${escapeHtml(task.task_name)}</span>
            ${badgeHtml}
          </div>
          ${metaHtml}
        </div>
      `;
    }
    
    function getStepLabels(tasks) {
      // Create abbreviated labels for pipeline steps
      return tasks.map(t => {
        const name = t.task_name || '';
        // Common abbreviations
        if (name.toLowerCase().includes('verify')) return 'Verify';
        if (name.toLowerCase().includes('design') || name.toLowerCase().includes('artwork')) return 'Design';
        if (name.toLowerCase().includes('print')) return 'Print';
        if (name.toLowerCase().includes('outgas')) return 'Outgas';
        if (name.toLowerCase().includes('laminate')) return 'Laminate';
        if (name.toLowerCase().includes('cutdown') || name.toLowerCase().includes('cut')) return 'Cut';
        if (name.toLowerCase().includes('prep')) return 'Prep';
        if (name.toLowerCase().includes('install')) return 'Install';
        if (name.toLowerCase().includes('quality') || name.toLowerCase().includes('qc')) return 'QC';
        if (name.toLowerCase().includes('pickup')) return 'Pickup';
        // Default: first word
        return name.split(' ')[0].substring(0, 8);
      });
    }
    
    function toggleExpand(toggle, sectionId) {
      const section = document.getElementById(sectionId);
      section.classList.toggle('expanded');
      toggle.classList.toggle('expanded');
      
      const hiddenCount = section.querySelectorAll('.production-task.hidden-task').length;
      const span = toggle.querySelector('span');
      
      if (section.classList.contains('expanded')) {
        span.textContent = 'Show less';
      } else {
        span.textContent = `Show ${hiddenCount} more tasks`;
      }
    }
    
    function toggleProductionTask(taskId, event) {
      event.stopPropagation();
      
      const checkbox = event.currentTarget;
      const isNowCompleted = !checkbox.classList.contains('checked');
      
      // Optimistic UI update
      checkbox.classList.toggle('checked');
      const taskEl = checkbox.closest('.production-task');
      taskEl.classList.toggle('completed');
      
      // Update in queue data
      productionQueue.forEach(job => {
        if (job.task_groups) {
          job.task_groups.forEach(group => {
            const task = group.tasks.find(t => t.task_id === taskId);
            if (task) {
              task.status = isNowCompleted ? 'DONE' : 'TODO';
              task.completed_at = isNowCompleted ? new Date().toISOString() : null;
            }
          });
        }
      });
      
      // Update visuals
      updateJobCardProgress(taskId);
      updateProductionStats();
      
      // Save to backend
      google.script.run
        .withSuccessHandler(function(result) {
          if (!result || !result.ok) {
            // Revert on failure
            checkbox.classList.toggle('checked');
            taskEl.classList.toggle('completed');
            showToast('Error updating task', 'error');
            return;
          }
          
          // Check if all tasks are now complete
          if (result.all_complete && isNowCompleted) {
            showArchiveModal(result.invoice_id, result.customer_name);
          }
          
          // Show toast for any automations that ran
          if (result.automations && result.automations.length > 0) {
            result.automations.forEach(auto => {
              if (auto.action === 'sms') {
                showToast('SMS sent to customer', 'success');
              }
            });
          }
        })
        .withFailureHandler(function(error) {
          checkbox.classList.toggle('checked');
          taskEl.classList.toggle('completed');
          showToast('Error: ' + error, 'error');
        })
        .updateProductionTask(taskId, { status: isNowCompleted ? 'DONE' : 'TODO' });
    }

    // ========================================================================
    // ARCHIVE MODAL & FUNCTIONS
    // ========================================================================
    
    function launchCelebration(callback) {
      const container = document.createElement('div');
      container.id = 'celebration-container';
      container.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999;overflow:hidden;';
      document.body.appendChild(container);
      
      const rect = { width: window.innerWidth, height: window.innerHeight };
      const centerX = rect.width / 2;
      const centerY = rect.height / 2;
      
      const confettiColors = ['#22d3ee', '#a855f7', '#ec4899', '#22c55e', '#f59e0b', '#3b82f6', '#f43f5e', '#d71cd1'];
      
      // Initial flash
      const flash = document.createElement('div');
      flash.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at center, rgba(168, 85, 247, 0.3) 0%, transparent 70%);opacity:0;transition:opacity 0.15s;';
      container.appendChild(flash);
      setTimeout(() => flash.style.opacity = '1', 10);
      setTimeout(() => { flash.style.opacity = '0'; setTimeout(() => flash.remove(), 200); }, 200);
      
      // Fire confetti cannons
      fireConfettiCannon(container, 0, rect.height, 1, rect, confettiColors);
      setTimeout(() => fireConfettiCannon(container, rect.width, rect.height, -1, rect, confettiColors), 100);
      
      // Overhead fireworks
      setTimeout(() => createCelebrationFirework(container, rect.width * 0.25, rect.height * 0.2, '#22d3ee'), 400);
      setTimeout(() => createCelebrationFirework(container, rect.width * 0.75, rect.height * 0.25, '#ec4899'), 600);
      setTimeout(() => createCelebrationFirework(container, rect.width * 0.5, rect.height * 0.15, '#a855f7'), 800);
      
      // Glow pulse
      const glow = document.createElement('div');
      glow.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);width:200px;height:200px;border-radius:50%;background:radial-gradient(circle, rgba(168, 85, 247, 0.3) 0%, transparent 70%);opacity:0;transition:opacity 0.4s;';
      container.appendChild(glow);
      setTimeout(() => { glow.style.opacity = '1'; }, 700);
      
      // Success badge
      const badge = document.createElement('div');
      badge.innerHTML = `
        <svg viewBox="0 0 100 100" width="100" height="100">
          <defs>
            <linearGradient id="checkGradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#22d3ee"/>
              <stop offset="50%" style="stop-color:#a855f7"/>
              <stop offset="100%" style="stop-color:#ec4899"/>
            </linearGradient>
          </defs>
          <circle cx="50" cy="50" r="45" fill="none" stroke="url(#checkGradient)" stroke-width="3" opacity="0.4" stroke-dasharray="283" stroke-dashoffset="283">
            <animate attributeName="stroke-dashoffset" from="283" to="0" dur="0.6s" fill="freeze"/>
          </circle>
          <path d="M28 50 L42 64 L72 34" fill="none" stroke="url(#checkGradient)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="70" stroke-dashoffset="70">
            <animate attributeName="stroke-dashoffset" from="70" to="0" dur="0.4s" begin="0.3s" fill="freeze"/>
          </path>
        </svg>
        <div style="margin-top:20px;font-size:28px;font-weight:800;background:linear-gradient(90deg, #22d3ee, #a855f7, #ec4899);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:3px;filter:drop-shadow(0 0 30px rgba(168, 85, 247, 0.4));">PROJECT COMPLETE</div>
      `;
      badge.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%, -50%) scale(0.5);display:flex;flex-direction:column;align-items:center;opacity:0;z-index:10;transition:all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);';
      container.appendChild(badge);
      setTimeout(() => { badge.style.opacity = '1'; badge.style.transform = 'translate(-50%, -50%) scale(1)'; }, 900);
      
      // Sparks
      setTimeout(() => {
        for (let i = 0; i < 25; i++) {
          setTimeout(() => createCelebrationSpark(container, centerX, centerY, confettiColors), i * 40);
        }
      }, 1100);
      
      // Second wave
      setTimeout(() => {
        fireConfettiCannon(container, 0, rect.height, 1, rect, confettiColors);
        fireConfettiCannon(container, rect.width, rect.height, -1, rect, confettiColors);
      }, 1400);
      
      // Final fireworks
      setTimeout(() => createCelebrationFirework(container, rect.width * 0.15, rect.height * 0.7, '#22c55e'), 1800);
      setTimeout(() => createCelebrationFirework(container, rect.width * 0.85, rect.height * 0.65, '#f59e0b'), 2000);
      
      // Cleanup and callback
      setTimeout(() => {
        container.style.transition = 'opacity 0.5s';
        container.style.opacity = '0';
        setTimeout(() => {
          container.remove();
          if (callback) callback();
        }, 500);
      }, 3500);
    }
    
    function fireConfettiCannon(container, startX, startY, direction, rect, colors) {
      for (let i = 0; i < 70; i++) {
        setTimeout(() => {
          const color = colors[Math.floor(Math.random() * colors.length)];
          const size = 8 + Math.random() * 10;
          const shapeRand = Math.random();
          let width = size, height = size, borderRadius = '2px';
          if (shapeRand < 0.25) { borderRadius = '50%'; }
          else if (shapeRand < 0.5) { width = size * 0.4; }
          else if (shapeRand < 0.75) { width = size * 0.3; height = size * 1.5; }
          
          const confetti = document.createElement('div');
          confetti.style.cssText = `position:absolute;left:${startX}px;top:${startY}px;width:${width}px;height:${height}px;background:${color};border-radius:${borderRadius};box-shadow:0 0 ${size/2}px ${color}40;`;
          container.appendChild(confetti);
          
          const angle = (Math.random() * 70 - 35) * (Math.PI / 180);
          const velocity = 12 + Math.random() * 10;
          let vx = Math.cos(angle) * velocity * direction;
          let vy = -Math.sin(angle + Math.PI / 4) * velocity - Math.random() * 8;
          let px = startX, py = startY, rotation = Math.random() * 360, rotationSpeed = (Math.random() - 0.5) * 30, opacity = 1;
          
          const interval = setInterval(() => {
            px += vx; py += vy; vy += 0.35; vx *= 0.99; rotation += rotationSpeed; rotationSpeed *= 0.99;
            if (py > rect.height * 0.7) opacity -= 0.02;
            confetti.style.left = px + 'px'; confetti.style.top = py + 'px'; confetti.style.transform = `rotate(${rotation}deg)`; confetti.style.opacity = opacity;
            if (py > rect.height + 20 || opacity <= 0) { clearInterval(interval); confetti.remove(); }
          }, 16);
        }, i * 10);
      }
    }
    
    function createCelebrationFirework(container, x, y, baseColor) {
      const burstFlash = document.createElement('div');
      burstFlash.style.cssText = `position:absolute;left:${x}px;top:${y}px;width:20px;height:20px;background:${baseColor};border-radius:50%;transform:translate(-50%, -50%);box-shadow:0 0 30px ${baseColor}, 0 0 60px ${baseColor};opacity:1;`;
      container.appendChild(burstFlash);
      setTimeout(() => { burstFlash.style.transition = 'all 0.3s'; burstFlash.style.transform = 'translate(-50%, -50%) scale(3)'; burstFlash.style.opacity = '0'; setTimeout(() => burstFlash.remove(), 300); }, 50);
      
      for (let i = 0; i < 35; i++) {
        const angle = (i / 35) * Math.PI * 2;
        const velocity = 3 + Math.random() * 5;
        const size = 3 + Math.random() * 4;
        const particle = document.createElement('div');
        particle.style.cssText = `position:absolute;left:${x}px;top:${y}px;width:${size}px;height:${size}px;background:${baseColor};border-radius:50%;box-shadow:0 0 ${size * 2}px ${baseColor};transform:translate(-50%, -50%);`;
        container.appendChild(particle);
        
        let px = x, py = y, vx = Math.cos(angle) * velocity, vy = Math.sin(angle) * velocity, opacity = 1, currentSize = size;
        const interval = setInterval(() => {
          px += vx; py += vy; vy += 0.12; vx *= 0.98; opacity -= 0.025; currentSize *= 0.98;
          particle.style.left = px + 'px'; particle.style.top = py + 'px'; particle.style.opacity = opacity; particle.style.width = currentSize + 'px'; particle.style.height = currentSize + 'px';
          if (opacity <= 0) { clearInterval(interval); particle.remove(); }
        }, 16);
      }
    }
    
    function createCelebrationSpark(container, centerX, centerY, colors) {
      const color = colors[Math.floor(Math.random() * 3)];
      const spark = document.createElement('div');
      const angle = Math.random() * Math.PI * 2;
      const startDist = 55 + Math.random() * 15;
      const startX = centerX + Math.cos(angle) * startDist;
      const startY = centerY + Math.sin(angle) * startDist;
      spark.style.cssText = `position:absolute;left:${startX}px;top:${startY}px;width:4px;height:4px;background:${color};border-radius:50%;box-shadow:0 0 8px ${color}, 0 0 16px ${color};transform:translate(-50%, -50%);`;
      container.appendChild(spark);
      
      const endDist = startDist + 30 + Math.random() * 40;
      const targetX = centerX + Math.cos(angle) * endDist;
      const targetY = centerY + Math.sin(angle) * endDist;
      let px = startX, py = startY;
      const dx = (targetX - px) / 25, dy = (targetY - py) / 25;
      let frame = 0, opacity = 1;
      
      const interval = setInterval(() => {
        frame++; px += dx; py += dy; opacity -= 0.04;
        spark.style.left = px + 'px'; spark.style.top = py + 'px'; spark.style.opacity = opacity;
        if (frame >= 25) { clearInterval(interval); spark.remove(); }
      }, 16);
    }
    
    function showArchiveModal(invoiceId, customerName) {
      // Launch celebration first, then show modal after
      launchCelebration(function() {
        const html = `
        <div class="modal-backdrop" id="archive-modal" onclick="if(event.target===this)closeArchiveModal()">
          <div class="modal" style="max-width:420px;">
            <div class="modal-header">
              <div class="modal-title" style="display:flex;align-items:center;gap:10px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent-green)" stroke-width="2" style="width:24px;height:24px;">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                All Tasks Complete!
              </div>
              <button class="btn-icon" onclick="closeArchiveModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
              </button>
            </div>
            <div class="modal-body" style="text-align:center;padding:24px;">
              <p style="font-size:15px;margin-bottom:8px;">
                <strong>${customerName || 'This project'}</strong> is complete.
              </p>
              <p style="color:var(--text-secondary);font-size:14px;">
                Archive this project now?
              </p>
            </div>
            <div class="modal-footer" style="justify-content:center;gap:12px;">
              <button class="btn btn-secondary" onclick="declineArchive('${invoiceId}')" style="min-width:100px;">Not Yet</button>
              <button class="btn btn-primary" onclick="confirmArchive('${invoiceId}')" style="min-width:100px;background:var(--accent-green);">Archive</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', html);
      });
    }
    
    function closeArchiveModal() {
      const modal = document.getElementById('archive-modal');
      if (modal) modal.remove();
    }
    
    function confirmArchive(invoiceId) {
      closeArchiveModal();
      showToast('Archiving project...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.ok) {
            showToast('Project archived!', 'success');
            // Remove the job card from the UI
            const jobCard = document.querySelector('.production-job-card[data-invoice-id="' + invoiceId + '"]');
            if (jobCard) {
              jobCard.style.transition = 'opacity 0.3s, transform 0.3s';
              jobCard.style.opacity = '0';
              jobCard.style.transform = 'scale(0.95)';
              setTimeout(() => jobCard.remove(), 300);
            }
            // Update stats
            productionQueue = productionQueue.filter(j => j.invoice_id !== invoiceId);
            updateProductionStats();
          } else {
            showToast('Error archiving: ' + (result?.error || 'Unknown error'), 'error');
          }
        })
        .withFailureHandler(function(error) {
          showToast('Error: ' + error, 'error');
        })
        .archiveProductionJob(invoiceId);
    }
    
    function declineArchive(invoiceId) {
      closeArchiveModal();
      showToast('You can archive later using the Archive button', 'info');
      
      // Add archive button to the job card
      const jobCard = document.querySelector('.production-job-card[data-invoice-id="' + invoiceId + '"]');
      if (jobCard) {
        // Check if button already exists
        if (!jobCard.querySelector('.archive-btn')) {
          const header = jobCard.querySelector('.production-job-header');
          if (header) {
            const archiveBtn = document.createElement('button');
            archiveBtn.className = 'archive-btn';
            archiveBtn.innerHTML = `
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;">
                <polyline points="21 8 21 21 3 21 3 8"></polyline>
                <rect x="1" y="3" width="22" height="5"></rect>
                <line x1="10" y1="12" x2="14" y2="12"></line>
              </svg>
              Archive
            `;
            archiveBtn.onclick = function(e) {
              e.stopPropagation();
              confirmArchive(invoiceId);
            };
            header.appendChild(archiveBtn);
          }
        }
      }
    }
    
    function updateJobCardProgress(taskId) {
      // Find the job containing this task
      productionQueue.forEach(job => {
        if (job.task_groups) {
          job.task_groups.forEach(group => {
            if (group.tasks.some(t => t.task_id === taskId)) {
              const card = document.querySelector(`.production-card[data-invoice-id="${job.invoice_id}"]`);
              if (!card) return;
              
              const tasks = group.tasks;
              const totalTasks = tasks.length;
              const completedTasks = tasks.filter(t => t.status === 'DONE').length;
              const progressPct = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
              
              // Update progress ring
              const circumference = 188.5;
              const strokeOffset = circumference - (progressPct / 100) * circumference;
              const ringFill = card.querySelector('.progress-ring-fill');
              const ringText = card.querySelector('.progress-ring-text');
              if (ringFill) ringFill.style.strokeDashoffset = strokeOffset;
              if (ringText) ringText.textContent = progressPct + '%';
              
              // Update pipeline fill
              const pipelineFill = card.querySelector('.pipeline-fill');
              if (pipelineFill) pipelineFill.style.width = progressPct + '%';
              
              // Update step dots
              const steps = card.querySelectorAll('.pipeline-step');
              const nextTaskIndex = tasks.findIndex(t => t.status !== 'DONE');
              
              steps.forEach((step, i) => {
                const dot = step.querySelector('.step-dot');
                const label = step.querySelector('.step-label');
                const task = tasks[i];
                
                dot.classList.remove('done', 'active');
                label.classList.remove('done', 'active');
                
                if (task && task.status === 'DONE') {
                  dot.classList.add('done');
                  label.classList.add('done');
                } else if (i === nextTaskIndex) {
                  dot.classList.add('active');
                  label.classList.add('active');
                }
              });
              
              // Update task badges (next indicator)
              const taskEls = card.querySelectorAll('.production-task');
              taskEls.forEach((el, i) => {
                const badge = el.querySelector('.production-task-badge');
                if (badge && badge.classList.contains('next')) {
                  badge.remove();
                }
              });
              
              if (nextTaskIndex >= 0 && nextTaskIndex < taskEls.length) {
                const nextEl = taskEls[nextTaskIndex];
                const content = nextEl.querySelector('.production-task-content');
                if (content && !content.querySelector('.production-task-badge.next')) {
                  const existingBadge = content.querySelector('.production-task-badge');
                  if (existingBadge) existingBadge.remove();
                  content.insertAdjacentHTML('beforeend', '<span class="production-task-badge next">Next</span>');
                }
              }
            }
          });
        }
      });
    }
    
    function updateProductionStats() {
      const activeJobs = productionQueue.length;
      let tasksPending = 0;
      let tasksCompletedToday = 0;
      const today = new Date().toDateString();
      
      productionQueue.forEach(job => {
        if (job.task_groups) {
          job.task_groups.forEach(group => {
            group.tasks.forEach(task => {
              if (task.status !== 'DONE') {
                tasksPending++;
              } else if (task.completed_at && new Date(task.completed_at).toDateString() === today) {
                tasksCompletedToday++;
              }
            });
          });
        }
      });
      
      document.getElementById('production-active-count').textContent = activeJobs;
      document.getElementById('production-tasks-pending').textContent = tasksPending;
      document.getElementById('production-tasks-today').textContent = tasksCompletedToday;
      
      const badge = document.getElementById('production-badge');
      if (badge) {
        if (tasksPending > 0) {
          badge.textContent = tasksPending;
          badge.style.display = 'inline-flex';
        } else {
          badge.style.display = 'none';
        }
      }
    }
    
    function populateCategoryFilter() {
      const select = document.getElementById('production-category-filter');
      if (!select) return;
      
      const categories = new Set();
      productionQueue.forEach(job => {
        if (job.task_groups) {
          job.task_groups.forEach(group => {
            categories.add(group.category);
          });
        }
      });
      
      let html = '<option value="">All Categories</option>';
      categories.forEach(cat => {
        html += `<option value="${cat}">${cat}</option>`;
      });
      select.innerHTML = html;
    }
    
    function filterProduction() {
      renderProductionQueue();
    }
    
    function filterProduction() {
      renderProductionQueue();
    }
    
    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }
    
    function formatNumber(num) {
      return Number(num || 0).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }
    
    function formatRelativeDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) return 'today';
      if (diffDays === 1) return 'yesterday';
      if (diffDays < 7) return diffDays + ' days ago';
      if (diffDays < 30) return Math.floor(diffDays / 7) + ' weeks ago';
      return date.toLocaleDateString();
    }

  </script>
  <?!= HtmlService.createHtmlOutputFromFile('FWG_Ops_Attachments_UI').getContent(); ?>
  <?!= include('FWG_Ops_SubmissionDetail'); ?>
  <?!= include('FWG_Ops_Attachments_UI'); ?>
  
</body>
</html>