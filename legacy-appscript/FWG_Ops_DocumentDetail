<!-- 
  FWG_Ops_DocumentDetail.html
  Unified document editor for quotes and invoices
  Dark theme to match dashboard
-->
<style>
  /* ========================================================================
     CSS VARIABLES - DARK THEME (Matches Dashboard)
     ======================================================================== */
  :root {
    --bg-dark: #282a30;
    --bg-surface: #1e1e1e;
    --bg-elevated: #2a2a2a;
    --bg-input: #333333;
    --border-color: rgba(148, 163, 184, 0.15);
    --border-hover: rgba(148, 163, 184, 0.3);
    
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --text-muted: #64748b;
    
    --accent-blue: #3b82f6;
    --accent-green: #22c55e;
    --accent-yellow: #eab308;
    --accent-red: #ef4444;
    --accent-purple: #a855f7;
    
    --fwg-primary: #d71cd1;
    --fwg-primary-soft: rgba(215, 28, 209, 0.15);
    
    --radius-sm: 6px;
    --radius-md: 10px;
    --radius-lg: 12px;
  }
  
  /* ========================================================================
     BASE STYLES
     ======================================================================== */
  .doc-detail-container * { box-sizing: border-box; margin: 0; padding: 0; }
  
  .doc-detail-container {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg-dark);
    color: var(--text-primary);
    line-height: 1.5;
    padding: 20px;
    padding-bottom: 100px;
    min-height: 100%;
  }
  
  /* ========================================================================
     LOADING STATE
     ======================================================================== */
  .doc-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }
  
  .doc-loading .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border-color);
    border-top-color: var(--fwg-primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-bottom: 16px;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  /* ========================================================================
     HEADER
     ======================================================================== */
  .doc-header {
    background: var(--bg-surface);
    border-radius: var(--radius-lg);
    padding: 20px;
    margin-bottom: 16px;
    border: 1px solid var(--border-color);
  }
  
  .doc-header-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 16px;
    flex-wrap: wrap;
  }
  
  .doc-title-section h1 {
    font-size: 22px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--text-primary);
  }
  
  .doc-type-badge {
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 20px;
    font-weight: 600;
    text-transform: uppercase;
  }
  
  .doc-type-badge.quote {
    background: rgba(59, 130, 246, 0.2);
    color: #60a5fa;
  }
  
  .doc-type-badge.invoice {
    background: rgba(34, 197, 94, 0.2);
    color: #4ade80;
  }
  
  .doc-status {
    font-size: 14px;
    color: var(--text-muted);
    margin-top: 6px;
  }
  
  .status-badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
  }
  
  .status-badge.draft { background: rgba(100, 116, 139, 0.2); color: #94a3b8; }
  .status-badge.sent { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
  .status-badge.viewed { background: rgba(168, 85, 247, 0.2); color: #c084fc; }
  .status-badge.approved { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
  .status-badge.declined { background: rgba(239, 68, 68, 0.2); color: #f87171; }
  .status-badge.expired { background: rgba(234, 179, 8, 0.2); color: #facc15; }
  .status-badge.partial { background: rgba(234, 179, 8, 0.2); color: #facc15; }
  .status-badge.paid { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
  .status-badge.overdue { background: rgba(239, 68, 68, 0.2); color: #f87171; }
  .status-badge.void { background: rgba(100, 116, 139, 0.2); color: #94a3b8; }
  
  .doc-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  
  /* ========================================================================
     BUTTONS
     ======================================================================== */
  .doc-detail-container .btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 16px;
    border-radius: var(--radius-md);
    font-size: 14px;
    font-weight: 500;
    border: none;
    cursor: pointer;
    transition: all 0.15s;
    text-decoration: none;
  }
  
  .doc-detail-container .btn svg { width: 16px; height: 16px; }
  
  .btn-primary {
    background: linear-gradient(135deg, var(--fwg-primary), #a855f7);
    color: white;
  }
  .btn-primary:hover { 
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(215, 28, 209, 0.3);
  }
  
  .btn-success {
    background: linear-gradient(135deg, var(--accent-green), #16a34a);
    color: white;
  }
  .btn-success:hover { 
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
  }
  
  .btn-secondary {
    background: var(--bg-elevated);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
  }
  .btn-secondary:hover { 
    background: var(--bg-input);
    border-color: var(--border-hover);
  }
  
  .btn-danger {
    background: rgba(239, 68, 68, 0.15);
    color: #f87171;
    border: 1px solid rgba(239, 68, 68, 0.3);
  }
  .btn-danger:hover { 
    background: rgba(239, 68, 68, 0.25);
  }
  
  .btn-outline {
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
  }
  .btn-outline:hover { 
    background: var(--bg-elevated);
    border-color: var(--border-hover);
  }
  
  .btn-sm {
    padding: 6px 12px;
    font-size: 13px;
  }
  
  .doc-detail-container .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
  }
  
  .btn-loading {
    position: relative;
    color: transparent !important;
  }
  
  .btn-loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    left: 50%;
    top: 50%;
    margin-left: -8px;
    margin-top: -8px;
  }
  
  /* ========================================================================
     CARDS / SECTIONS
     ======================================================================== */
  .card {
    background: var(--bg-surface);
    border-radius: var(--radius-lg);
    padding: 20px;
    margin-bottom: 16px;
    border: 1px solid var(--border-color);
  }
  
  .card-title {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    color: var(--text-primary);
  }
  
  .card-title svg {
    width: 18px;
    height: 18px;
    color: var(--text-muted);
  }
  
  /* ========================================================================
     FORM ELEMENTS
     ======================================================================== */
  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
  }
  
  .form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  
  .form-group.full-width {
    grid-column: 1 / -1;
  }
  
  .form-group label {
    font-size: 12px;
    font-weight: 500;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .form-group input,
  .form-group select,
  .form-group textarea {
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    font-size: 14px;
    transition: border-color 0.15s, box-shadow 0.15s;
    background: var(--bg-input);
    color: var(--text-primary);
  }
  
  .form-group input::placeholder,
  .form-group textarea::placeholder {
    color: var(--text-muted);
  }
  
  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--fwg-primary);
    box-shadow: 0 0 0 3px rgba(215, 28, 209, 0.15);
  }
  
  .form-group textarea {
    min-height: 80px;
    resize: vertical;
  }
  
  /* Customer Autocomplete */
  .autocomplete-wrapper {
    position: relative;
  }
  
  .autocomplete-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--bg-elevated);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    max-height: 200px;
    overflow-y: auto;
    z-index: 100;
    margin-top: 4px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    display: none;
  }
  
  .autocomplete-dropdown.active {
    display: block;
  }
  
  .autocomplete-item {
    padding: 10px 12px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
    transition: background 0.1s;
  }
  
  .autocomplete-item:last-child {
    border-bottom: none;
  }
  
  .autocomplete-item:hover,
  .autocomplete-item.selected {
    background: var(--fwg-primary-soft);
  }
  
  .autocomplete-item-name {
    font-weight: 500;
    color: var(--text-primary);
  }
  
  .autocomplete-item-details {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 2px;
  }
  
  .autocomplete-empty {
    padding: 12px;
    text-align: center;
    color: var(--text-muted);
    font-size: 13px;
  }
  
  /* ========================================================================
     LINE ITEMS TABLE
     ======================================================================== */
  .line-items-section {
    overflow-x: auto;
  }
  
  .line-items-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }
  
  .line-items-table th {
    text-align: left;
    padding: 12px 8px;
    border-bottom: 1px solid var(--border-color);
    font-weight: 600;
    color: var(--text-muted);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .line-items-table td {
    padding: 12px 8px;
    border-bottom: 1px solid var(--border-color);
    vertical-align: top;
  }
  
  .line-items-table tr:hover td {
    background: rgba(255, 255, 255, 0.02);
  }
  
  .line-items-table input,
  .line-items-table select {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    font-size: 14px;
    background: var(--bg-input);
    color: var(--text-primary);
  }
  
  .line-items-table input:focus,
  .line-items-table select:focus {
    outline: none;
    border-color: var(--fwg-primary);
  }
  
  .line-item-desc {
    min-width: 200px;
  }
  
  .line-item-qty,
  .line-item-price,
  .line-item-total {
    width: 100px;
    text-align: right;
  }
  
  .line-item-total input {
    background: var(--bg-elevated);
    font-weight: 600;
    color: var(--text-primary);
  }
  
  /* Remove number input spinners */
  input[type=number]::-webkit-outer-spin-button,
  input[type=number]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  input[type=number] {
    -moz-appearance: textfield;
  }
  
  .line-item-actions {
    width: 50px;
    text-align: center;
  }
  
  .line-item-delete {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 6px;
    border-radius: 4px;
    transition: all 0.15s;
  }
  
  .line-item-delete:hover {
    background: rgba(239, 68, 68, 0.15);
    color: #f87171;
  }
  
  .add-line-item-row td {
    padding-top: 16px;
  }
  
  /* ========================================================================
     LINE ITEM GROUPS SYSTEM
     ======================================================================== */
  .line-item-groups {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  
  .line-item-group {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    overflow: hidden;
  }
  
  .line-item-group-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--bg-elevated);
    border-bottom: 1px solid var(--border-color);
  }
  
  .line-item-group-color {
    width: 4px;
    height: 24px;
    border-radius: 2px;
    flex-shrink: 0;
  }
  
  .line-item-group-title {
    font-weight: 600;
    font-size: 14px;
    flex: 1;
  }
  
  .line-item-group-count {
    font-size: 12px;
    color: var(--text-muted);
    background: var(--bg-dark);
    padding: 2px 8px;
    border-radius: 10px;
  }
  
  .line-item-group-total {
    font-weight: 600;
    font-size: 14px;
    color: var(--accent-green);
  }
  
  .line-item-group-delete {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    opacity: 0.6;
    transition: all 0.15s;
  }
  
  .line-item-group-delete:hover {
    background: rgba(239, 68, 68, 0.15);
    color: #f87171;
    opacity: 1;
  }
  
  .line-item-group-body {
    padding: 0;
  }
  
  .line-item-group-body .line-items-table {
    margin: 0;
  }
  
  .line-item-group-body .line-items-table th {
    background: var(--bg-surface);
  }
  
  .line-item-group-add {
    padding: 12px 16px;
    border-top: 1px solid var(--border-color);
    background: var(--bg-surface);
  }
  
  .line-item-group-add button {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    background: transparent;
    border: 1px dashed var(--border-color);
    border-radius: var(--radius-sm);
    color: var(--text-muted);
    cursor: pointer;
    font-size: 13px;
    transition: all 0.15s;
  }
  
  .line-item-group-add button:hover {
    border-color: var(--fwg-primary);
    color: var(--fwg-primary);
    background: var(--fwg-primary-soft);
  }
  
  .add-section-row {
    padding: 16px 0;
  }
  
  .add-section-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    padding: 16px;
    background: transparent;
    border: 2px dashed var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-muted);
    cursor: pointer;
    font-size: 14px;
    transition: all 0.15s;
  }
  
  .add-section-btn:hover {
    border-color: var(--fwg-primary);
    color: var(--fwg-primary);
    background: var(--fwg-primary-soft);
  }
  
  /* Section Modal */
  .section-modal-tabs {
    display: flex;
    gap: 0;
    margin-bottom: 16px;
    border-bottom: 1px solid var(--border-color);
  }
  
  .section-modal-tab {
    flex: 1;
    padding: 12px 16px;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    color: var(--text-secondary);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .section-modal-tab:hover {
    color: var(--text-primary);
    background: var(--bg-elevated);
  }
  
  .section-modal-tab.active {
    color: var(--fwg-primary);
    border-bottom-color: var(--fwg-primary);
  }
  
  .section-modal-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    max-height: 300px;
    overflow-y: auto;
  }
  
  .section-option {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px;
    background: var(--bg-elevated);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.15s;
  }
  
  .section-option:hover {
    border-color: var(--fwg-primary);
    background: var(--fwg-primary-soft);
  }
  
  .section-option-color {
    width: 4px;
    height: 20px;
    border-radius: 2px;
  }
  
  .section-option-label {
    font-size: 13px;
    font-weight: 500;
  }
  
  @media (max-width: 600px) {
    .section-modal-grid {
      grid-template-columns: 1fr;
    }
  }
  
  /* Modal Backdrop (for section modal) */
  .modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 20px;
  }
  
  .modal {
    background: var(--bg-surface);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
    width: 100%;
    max-width: 500px;
    max-height: 80vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-color);
  }
  
  .modal-title {
    font-weight: 600;
    font-size: 16px;
  }
  
  .modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--text-muted);
    cursor: pointer;
    line-height: 1;
  }
  
  .modal-close:hover {
    color: var(--text-primary);
  }
  
  .modal-body {
    padding: 20px;
    overflow-y: auto;
    flex: 1;
  }
  
  /* ========================================================================
     ATTACHMENTS
     ======================================================================== */
  .attachments-row {
    background: rgba(255, 255, 255, 0.02);
  }
  
  .attachments-row td {
    padding: 8px 8px 16px 8px;
  }
  
  .attachments-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }
  
  .attachment-thumb {
    position: relative;
    width: 60px;
    height: 60px;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    border: 1px solid var(--border-color);
    background: var(--bg-elevated);
  }
  
  .attachment-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .attachment-thumb-file {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    color: var(--text-muted);
    gap: 2px;
  }
  
  .attachment-thumb-file svg {
    width: 24px;
    height: 24px;
  }
  
  .attachment-delete {
    position: absolute;
    top: 2px;
    right: 2px;
    width: 18px;
    height: 18px;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 12px;
    line-height: 1;
    display: none;
    align-items: center;
    justify-content: center;
  }
  
  .attachment-thumb:hover .attachment-delete {
    display: flex;
  }
  
  .attachment-add {
    width: 60px;
    height: 60px;
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.15s;
    background: transparent;
  }
  
  .attachment-add:hover {
    border-color: var(--fwg-primary);
    background: var(--fwg-primary-soft);
  }
  
  .attachment-add svg {
    width: 24px;
    height: 24px;
    color: var(--text-muted);
  }
  
  .attachment-add:hover svg {
    color: var(--fwg-primary);
  }
  
  .attachment-add input {
    display: none;
  }
  
  /* ========================================================================
     PROJECT FILES
     ======================================================================== */
  .project-files-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
  }
  
  .project-file {
    position: relative;
    width: 100px;
    height: 100px;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    border: 1px solid var(--border-color);
    background: var(--bg-elevated);
  }
  
  .project-file img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .project-file-info {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.8));
    color: white;
    padding: 20px 6px 6px;
    font-size: 10px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .project-file-delete {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 22px;
    height: 22px;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 14px;
    display: none;
    align-items: center;
    justify-content: center;
  }
  
  .project-file:hover .project-file-delete {
    display: flex;
  }
  
  .project-file-add {
    width: 100px;
    height: 100px;
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.15s;
    gap: 4px;
    font-size: 12px;
    color: var(--text-muted);
  }
  
  .project-file-add:hover {
    border-color: var(--fwg-primary);
    background: var(--fwg-primary-soft);
    color: var(--fwg-primary);
  }
  
  .project-file-add svg {
    width: 28px;
    height: 28px;
  }
  
  .project-file-add input {
    display: none;
  }

  /* Fees Section */
  .fees-section {
    margin-top: 20px;
    padding: 16px;
    background: var(--bg-elevated);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
  }
  
  .fees-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }
  
  .fees-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
  }
  
  .fees-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .fee-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    background: var(--bg-surface);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
  }
  
  .fee-type {
    flex: 0 0 120px;
  }
  
  .fee-description {
    flex: 1;
  }
  
  .fee-amount {
    flex: 0 0 100px;
  }
  
  .fee-row input, .fee-row select {
    width: 100%;
    padding: 6px 8px;
    background: var(--bg-dark);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-size: 13px;
  }
  
  .fee-delete {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 4px;
  }
  
  .fee-delete:hover {
    color: var(--accent-red);
  }
  
  .fees-total {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 12px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border-color);
    font-size: 14px;
  }
  
  .fees-total-label {
    color: var(--text-secondary);
  }
  
  .fees-total-amount {
    font-weight: 600;
    color: var(--text-primary);
  }
  
  .add-fee-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: none;
    border: 1px dashed var(--border-color);
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    font-size: 13px;
    cursor: pointer;
    transition: all 0.15s;
  }
  
  .add-fee-btn:hover {
    border-color: var(--fwg-primary);
    color: var(--fwg-primary);
  }
  
  /* ========================================================================
     TOTALS
     ======================================================================== */
  .totals-section {
    margin-top: 20px;
    display: flex;
    justify-content: flex-end;
  }
  
  .totals-box {
    min-width: 280px;
  }
  
  .totals-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    font-size: 14px;
    color: var(--text-secondary);
  }

  .discount-row .discount-controls {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .discount-row select {
    padding: 6px 8px;
    background: var(--bg-dark);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-size: 13px;
    min-width: 90px;
  }
  
  .discount-row input[type="number"] {
    width: 80px;
    padding: 6px 8px;
    background: var(--bg-dark);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-size: 13px;
  }
  
  .discount-display {
    color: var(--accent-green);
    font-weight: 500;
    min-width: 70px;
    text-align: right;
  }
  
  .totals-row.subtotal {
    border-bottom: 1px solid var(--border-color);
  }
  
  .totals-row.total {
    font-size: 18px;
    font-weight: 700;
    border-top: 2px solid var(--border-hover);
    margin-top: 8px;
    padding-top: 12px;
    color: var(--text-primary);
  }
  
  .totals-row.balance {
    color: #f87171;
    font-weight: 600;
  }
  
  .totals-row.paid {
    color: #4ade80;
  }
  
  .totals-row input {
    width: 120px;
    text-align: right;
    padding: 6px 8px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    background: var(--bg-input);
    color: var(--text-primary);
  }
  
  .totals-row input:focus {
    outline: none;
    border-color: var(--fwg-primary);
  }
  
  /* ========================================================================
     PAYMENT SECTION (Invoice Only)
     ======================================================================== */
  .payments-list {
    margin-bottom: 16px;
  }
  
  .payment-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: var(--bg-elevated);
    border-radius: 8px;
    margin-bottom: 8px;
    border: 1px solid var(--border-color);
  }
  
  .payment-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  
  .payment-amount {
    font-weight: 600;
    font-size: 16px;
    color: #4ade80;
  }
  
  .payment-meta {
    font-size: 12px;
    color: var(--text-muted);
  }
  
  .record-payment-form {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 12px;
    align-items: end;
    padding-top: 12px;
    border-top: 1px solid var(--border-color);
  }
  
  @media (max-width: 600px) {
    .record-payment-form {
      grid-template-columns: 1fr;
    }
  }
  
  /* ========================================================================
     LIGHTBOX - Advanced with zoom, pan, navigation
     ======================================================================== */
  .lightbox {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.95);
    z-index: 10000;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }
  
  .lightbox.active {
    display: flex;
  }
  
  .lightbox-header {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent);
    z-index: 10;
  }
  
  .lightbox-counter {
    color: white;
    font-size: 14px;
    font-weight: 500;
  }
  
  .lightbox-controls {
    display: flex;
    gap: 8px;
  }
  
  .lightbox-btn {
    background: rgba(255,255,255,0.1);
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.15s;
  }
  
  .lightbox-btn:hover {
    background: rgba(255,255,255,0.2);
  }
  
  .lightbox-btn svg {
    width: 20px;
    height: 20px;
  }
  
  .lightbox-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255,255,255,0.1);
    border: none;
    color: white;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.15s, opacity 0.15s;
    z-index: 10;
  }
  
  .lightbox-nav:hover {
    background: rgba(255,255,255,0.25);
  }
  
  .lightbox-nav.disabled {
    opacity: 0.3;
    cursor: default;
  }
  
  .lightbox-nav.prev {
    left: 20px;
  }
  
  .lightbox-nav.next {
    right: 20px;
  }
  
  .lightbox-nav svg {
    width: 24px;
    height: 24px;
  }
  
  .lightbox-image-container {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    touch-action: none;
  }
  
  .lightbox-image {
    max-width: 90vw;
    max-height: 85vh;
    object-fit: contain;
    transition: transform 0.1s ease-out;
    cursor: grab;
    user-select: none;
    -webkit-user-drag: none;
  }
  
  .lightbox-image.zoomed {
    cursor: move;
  }
  
  .lightbox-footer {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 16px 20px;
    background: linear-gradient(to top, rgba(0,0,0,0.6), transparent);
  }
  
  .lightbox-filename {
    color: white;
    font-size: 14px;
    margin-bottom: 8px;
    max-width: 80%;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .lightbox-actions {
    display: flex;
    gap: 12px;
  }
  
  .lightbox-actions a {
    padding: 8px 16px;
    background: rgba(255,255,255,0.1);
    color: white;
    border-radius: var(--radius-md);
    text-decoration: none;
    font-size: 13px;
    transition: background 0.15s;
  }
  
  .lightbox-actions a:hover {
    background: rgba(255,255,255,0.2);
  }
  
  @media (max-width: 768px) {
    .lightbox-nav {
      width: 40px;
      height: 40px;
    }
    .lightbox-nav.prev { left: 10px; }
    .lightbox-nav.next { right: 10px; }
  }
  
  /* ========================================================================
     STICKY FOOTER
     ======================================================================== */
  .sticky-footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--bg-surface);
    border-top: 1px solid var(--border-color);
    padding: 12px 20px;
    display: none;
    justify-content: space-between;
    align-items: center;
    z-index: 100;
    gap: 12px;
  }
  
  .sticky-footer .footer-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .sticky-footer .footer-right {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  /* ========================================================================
     NOTES SECTION
     ======================================================================== */
  .notes-textarea {
    width: 100%;
    min-height: 100px;
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    font-size: 14px;
    resize: vertical;
    background: var(--bg-input);
    color: var(--text-primary);
    font-family: inherit;
  }
  
  .notes-textarea:focus {
    outline: none;
    border-color: var(--fwg-primary);
  }
  
  .notes-textarea::placeholder {
    color: var(--text-muted);
  }
  
  /* ========================================================================
     LINKED TASKS
     ======================================================================== */
  .linked-tasks-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .linked-task-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    background: var(--bg-elevated);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
  }
  
  .linked-task-item:hover {
    border-color: var(--text-muted);
  }
  
  .linked-task-checkbox {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: var(--accent-green);
  }
  
  .linked-task-content {
    flex: 1;
    min-width: 0;
  }
  
  .linked-task-title {
    font-weight: 500;
    color: var(--text-primary);
  }
  
  .linked-task-item.completed .linked-task-title {
    text-decoration: line-through;
    color: var(--text-muted);
  }
  
  .linked-task-meta {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 2px;
  }
  
  .linked-task-priority {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 500;
  }
  
  .linked-task-priority.urgent { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }
  .linked-task-priority.high { background: rgba(245, 158, 11, 0.15); color: var(--accent-orange); }
  .linked-task-priority.normal { background: rgba(100, 116, 139, 0.15); color: var(--text-secondary); }
  .linked-task-priority.low { background: rgba(100, 116, 139, 0.1); color: var(--text-muted); }
  
  .linked-task-delete {
    padding: 4px;
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    border-radius: var(--radius-sm);
  }
  
  .linked-task-delete:hover {
    color: var(--accent-red);
    background: rgba(239, 68, 68, 0.1);
  }
  
  /* ========================================================================
     SCHEDULED EVENTS
     ======================================================================== */
  .scheduled-events-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  
  .scheduled-event-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: var(--bg-elevated);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
  }
  
  .scheduled-event-color {
    width: 4px;
    height: 40px;
    border-radius: 2px;
    flex-shrink: 0;
  }
  
  .scheduled-event-info {
    flex: 1;
    min-width: 0;
  }
  
  .scheduled-event-title {
    font-weight: 500;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .scheduled-event-time {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 2px;
  }
  
  .scheduled-event-actions {
    display: flex;
    gap: 6px;
  }
  
  .scheduled-event-btn {
    background: var(--bg-input);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    padding: 6px 10px;
    border-radius: var(--radius-sm);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.15s;
  }
  
  .scheduled-event-btn:hover {
    background: var(--bg-surface);
    border-color: var(--border-hover);
  }
  
  .scheduled-event-btn.delete:hover {
    background: rgba(239, 68, 68, 0.15);
    border-color: rgba(239, 68, 68, 0.3);
    color: #f87171;
  }
  
  .no-events-message {
    text-align: center;
    padding: 20px;
    color: var(--text-muted);
    font-size: 13px;
  }

  /* ========================================================================
     MODAL BASE STYLES
     ======================================================================== */
  .modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    padding: 20px;
  }
  
  .modal {
    background: var(--bg-surface);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  }
  
  .modal-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  
  .modal-title {
    font-size: 18px;
    font-weight: 600;
  }
  
  .modal-close {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-sm);
    border: none;
    background: transparent;
    color: var(--text-secondary);
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .modal-close:hover {
    background: var(--bg-elevated);
    color: var(--text-primary);
  }
  
  .modal-body {
    padding: 20px;
  }
  
  .modal-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
  }
  
  /* Follow-up Modal Styles */
  .followup-templates {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 16px;
  }
  
  .followup-template-option {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.15s ease;
  }
  
  .followup-template-option:hover {
    border-color: var(--fwg-primary);
    background: var(--fwg-primary-soft);
  }
  
  .followup-template-option.selected {
    border-color: var(--fwg-primary);
    background: var(--fwg-primary-soft);
  }
  
  .followup-template-option input[type="radio"] {
    margin-top: 2px;
  }
  
  .followup-template-label {
    font-weight: 500;
    margin-bottom: 2px;
  }
  
  .followup-template-preview {
    font-size: 12px;
    color: var(--text-muted);
  }
  
  .followup-incentive-section {
    background: var(--bg-elevated);
    border-radius: var(--radius-md);
    padding: 16px;
    margin-top: 16px;
  }
  
  .followup-incentive-toggle {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    margin-bottom: 12px;
  }
  
  .followup-incentive-toggle input {
    width: 18px;
    height: 18px;
  }
  
  .followup-incentive-options {
    display: none;
    gap: 12px;
    margin-top: 12px;
  }
  
  .followup-incentive-options.show {
    display: grid;
    grid-template-columns: 1fr 1fr;
  }
  
  /* Archive Modal Styles */
  .archive-reason-options {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .archive-reason-option {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.15s ease;
  }
  
  .archive-reason-option:hover {
    border-color: var(--accent-red);
    background: rgba(239, 68, 68, 0.1);
  }
  
  .archive-reason-option.selected {
    border-color: var(--accent-red);
    background: rgba(239, 68, 68, 0.1);
  }
  
  .archive-other-input {
    margin-top: 12px;
    display: none;
  }
  
  .archive-other-input.show {
    display: block;
  }
  
  .bucket-select-section {
    margin-bottom: 20px;
  }
  
  .bucket-select-options {
    display: flex;
    gap: 10px;
    margin-top: 8px;
  }
  
  .bucket-select-btn {
    flex: 1;
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    background: transparent;
    color: var(--text-primary);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
  }
  
  .bucket-select-btn:hover {
    border-color: var(--border-hover);
  }
  
  .bucket-select-btn.won {
    border-color: var(--accent-green);
    background: rgba(34, 197, 94, 0.1);
  }
  
  .bucket-select-btn.won:hover,
  .bucket-select-btn.won.selected {
    background: rgba(34, 197, 94, 0.2);
  }
  
  .bucket-select-btn.lost {
    border-color: var(--accent-red);
    background: rgba(239, 68, 68, 0.1);
  }
  
  .bucket-select-btn.lost:hover,
  .bucket-select-btn.lost.selected {
    background: rgba(239, 68, 68, 0.2);
  }

  /* Schedule Modal */
  .schedule-form {
  
  /* Schedule Modal */
  .schedule-form {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  
  .schedule-form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  
  @media (max-width: 500px) {
    .schedule-form-row {
      grid-template-columns: 1fr;
    }
  }
  
  .schedule-form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  
  .schedule-form-group.full-width {
    grid-column: 1 / -1;
  }
  
  .schedule-form-label {
    font-size: 12px;
    font-weight: 500;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .schedule-form-input,
  .schedule-form-select,
  .schedule-form-textarea {
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    font-size: 14px;
    background: var(--bg-input);
    color: var(--text-primary);
  }
  
  .schedule-form-input:focus,
  .schedule-form-select:focus,
  .schedule-form-textarea:focus {
    outline: none;
    border-color: var(--fwg-primary);
  }
  
  .schedule-form-textarea {
    min-height: 60px;
    resize: vertical;
  }
  
  /* ========================================================================
     TOAST
     ======================================================================== */
  .toast {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    padding: 12px 24px;
    border-radius: var(--radius-md);
    font-size: 14px;
    font-weight: 500;
    z-index: 10001;
    animation: toastIn 0.3s ease;
    background: var(--bg-surface);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
  }
  
  .toast.success {
    background: rgba(34, 197, 94, 0.15);
    border-color: rgba(34, 197, 94, 0.3);
    color: #4ade80;
  }
  
  .toast.error {
    background: rgba(239, 68, 68, 0.15);
    border-color: rgba(239, 68, 68, 0.3);
    color: #f87171;
  }
  
  @keyframes toastIn {
    from {
      opacity: 0;
      transform: translateX(-50%) translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }
  
  /* ========================================================================
     MOBILE RESPONSIVE
     ======================================================================== */
  @media (max-width: 768px) {
    .doc-detail-container {
      padding: 12px;
      padding-bottom: 100px;
    }
    
    .doc-header-top {
      flex-direction: column;
    }
    
    .doc-actions {
      width: 100%;
      justify-content: flex-start;
    }
    
    .form-grid {
      grid-template-columns: 1fr;
    }
    
    .line-items-table {
      font-size: 13px;
    }
    
    .line-items-table th,
    .line-items-table td {
      padding: 8px 4px;
    }
    
    .line-item-desc {
      min-width: 120px;
    }
    
    .line-item-qty,
    .line-item-price,
    .line-item-total {
      width: 70px;
    }
    
    .totals-section {
      justify-content: stretch;
    }
    
    .totals-box {
      width: 100%;
    }
    
    .sticky-footer {
      flex-direction: column;
      align-items: stretch;
    }
    
    .sticky-footer .footer-left,
    .sticky-footer .footer-right {
      justify-content: center;
    }
  }
  
  /* Send Modal Styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 999999;
    padding: 20px;
    overflow: auto;
  }
  
  .modal-container {
    background: var(--bg-surface);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
    width: 100%;
    max-width: 500px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-color);
    background: var(--bg-elevated);
  }
  
  .modal-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
  }
  
  .modal-close-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 4px;
    border-radius: var(--radius-sm);
    transition: all 0.15s ease;
  }
  
  .modal-close-btn:hover {
    background: var(--bg-input);
    color: var(--text-primary);
  }
  
  .modal-body {
    padding: 20px;
    overflow-y: auto;
    flex: 1;
  }
  
  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding: 16px 20px;
    border-top: 1px solid var(--border-color);
    background: var(--bg-elevated);
  }
  
  .send-section {
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
  }
  
  .send-section:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
  }
  
  .send-section-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .send-section-hint {
    font-size: 12px;
    color: var(--text-muted);
    margin: -8px 0 12px 0;
  }
  
  .send-checkbox, .send-radio {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    margin: 0 0 8px 0;
    background: var(--bg-input);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.15s ease;
  }
  
  .send-checkbox:hover, .send-radio:hover {
    background: var(--bg-elevated);
  }
  
  .send-checkbox.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .send-checkbox input, .send-radio input {
    display: none;
  }
  
  .checkmark {
    width: 18px;
    height: 18px;
    border: 2px solid var(--border-hover);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s ease;
    flex-shrink: 0;
  }
  
  .send-checkbox input:checked + .checkmark {
    background: var(--fwg-primary);
    border-color: var(--fwg-primary);
  }
  
  .send-checkbox input:checked + .checkmark::after {
    content: '';
    width: 5px;
    height: 9px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
    margin-bottom: 2px;
  }
  
  .radio-mark {
    width: 18px;
    height: 18px;
    border: 2px solid var(--border-hover);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s ease;
    flex-shrink: 0;
  }
  
  .send-radio input:checked + .radio-mark {
    border-color: var(--fwg-primary);
  }
  
  .send-radio input:checked + .radio-mark::after {
    content: '';
    width: 8px;
    height: 8px;
    background: var(--fwg-primary);
    border-radius: 50%;
  }
  
  .send-checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
    font-size: 14px;
  }
  
  .send-checkbox-detail, .send-radio-detail {
    font-size: 12px;
    color: var(--text-muted);
    margin-left: auto;
  }
  
  .send-input {
    background: var(--bg-input);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    padding: 8px 12px;
    color: var(--text-primary);
    font-size: 14px;
    width: 100%;
  }
  
  .send-input:focus {
    outline: none;
    border-color: var(--fwg-primary);
  }

  /* Revision History */
    .revision-thread {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 400px;
      overflow-y: auto;
      padding: 4px;
    }
    
    .revision-message {
      padding: 12px 16px;
      border-radius: 12px;
      max-width: 85%;
      position: relative;
    }
    
    .revision-message.from-customer {
      background: var(--bg-elevated);
      border: 1px solid var(--accent-yellow);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    
    .revision-message.from-fwg {
      background: rgba(215, 28, 209, 0.15);
      border: 1px solid var(--fwg-primary);
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    
    .revision-message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .revision-message-from {
      font-weight: 600;
      color: var(--text-secondary);
    }
    
    .revision-message.from-customer .revision-message-from {
      color: var(--accent-yellow);
    }
    
    .revision-message.from-fwg .revision-message-from {
      color: var(--fwg-primary);
    }
    
    .revision-message-text {
      font-size: 14px;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    
    .revision-reply-box {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
    }
    
    .revision-reply-box textarea {
      flex: 1;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--bg-dark);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 14px;
      resize: none;
    }
    
    .revision-reply-box textarea:focus {
      outline: none;
      border-color: var(--fwg-primary);
    }
    
    .revision-reply-box .btn {
      align-self: flex-end;
    }

    .revision-reply-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .revision-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
      cursor: pointer;
    }
    
    .revision-checkbox input {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }
    
    .revision-checkbox.revision-indent {
      margin-left: 24px;
    }

    /* Line Item Configuration Modal */
  .line-item-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  
  .line-item-modal {
    background: var(--bg-surface);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    width: 95%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
  }
  
  .line-item-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-color);
  }
  
  .line-item-modal-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
  }
  
  .line-item-modal-close {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 4px;
  }
  
  .line-item-modal-close:hover {
    color: var(--text-primary);
  }
  
  .line-item-modal-body {
    padding: 20px;
  }
  
  .line-item-form-group {
    margin-bottom: 16px;
  }
  
  .line-item-form-label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 6px;
  }
  
  .line-item-form-input,
  .line-item-form-select,
  .line-item-form-textarea {
    width: 100%;
    padding: 10px 12px;
    background: var(--bg-dark);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-size: 14px;
  }
  
  .line-item-form-input:focus,
  .line-item-form-select:focus,
  .line-item-form-textarea:focus {
    outline: none;
    border-color: var(--fwg-primary);
  }
  
  .line-item-form-row {
    display: flex;
    gap: 12px;
  }
  
  .line-item-form-row .line-item-form-group {
    flex: 1;
  }
  
  .line-item-form-row .line-item-form-group.small {
    flex: 0 0 100px;
  }
  
  .line-item-price-summary {
    background: var(--bg-elevated);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 16px;
    margin-top: 20px;
  }
  
  .line-item-price-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    font-size: 14px;
  }
  
  .line-item-price-row.total {
    border-top: 1px solid var(--border-color);
    margin-top: 8px;
    padding-top: 12px;
    font-weight: 600;
    font-size: 16px;
  }
  
  .line-item-price-label {
    color: var(--text-secondary);
  }
  
  .line-item-price-value {
    color: var(--text-primary);
  }
  
  .line-item-price-row.total .line-item-price-value {
    color: var(--accent-green);
  }
  
  .line-item-modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding: 16px 20px;
    border-top: 1px solid var(--border-color);
  }
  
  .line-item-qualifier {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: var(--bg-elevated);
    border-radius: var(--radius-sm);
    margin-bottom: 16px;
  }
  
  .line-item-qualifier-label {
    font-size: 14px;
    color: var(--text-primary);
  }
  
  .line-item-qualifier-options {
    display: flex;
    gap: 8px;
  }
  
  .line-item-qualifier-btn {
    padding: 6px 16px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    background: var(--bg-dark);
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 13px;
  }
  
  .line-item-qualifier-btn.active {
    background: var(--fwg-primary);
    border-color: var(--fwg-primary);
    color: white;
  }
</style>

<!-- Document Detail Container -->
<div class="doc-detail-container">
  <!-- Loading State -->
  <div id="loading-state" class="doc-loading">
    <div class="spinner"></div>
    <div>Loading document...</div>
  </div>
  
  <!-- Main Content (hidden until loaded) -->
  <div id="main-content" style="display: none;">
    
    <!-- Header -->
    <div class="doc-header">
      <div class="doc-header-top">
        <div class="doc-title-section">
          <h1>
            <span id="doc-type-label">Quote</span> #<span id="doc-id">0000</span>
            <span id="doc-type-badge" class="doc-type-badge quote">Quote</span>
          </h1>
          <div class="doc-status">
            Status: <span id="doc-status-badge" class="status-badge draft">Draft</span>
            <span id="doc-dates"></span>
          </div>
        </div>
        <div class="doc-actions" id="doc-actions">
          <!-- Actions populated by JS based on doc_type and status -->
        </div>
      </div>
    </div>
    
    <!-- Customer Info -->
    <div class="card">
      <div class="card-title">
        <span>Customer Information</span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
      </div>
      <div class="form-grid">
        <div class="form-group autocomplete-wrapper">
          <label>Customer Name *</label>
          <input type="text" id="customer_name" placeholder="Full name" autocomplete="off" oninput="handleCustomerSearch(this.value)" onfocus="handleCustomerSearch(this.value)">
          <div class="autocomplete-dropdown" id="customer-autocomplete"></div>
        </div>
        <div class="form-group">
          <label>Company</label>
          <input type="text" id="company_name" placeholder="Company name">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="customer_email" placeholder="email@example.com">
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" id="customer_phone" placeholder="(240) 555-1234">
        </div>
        <div class="form-group full-width">
          <label>Vehicle / Subject</label>
          <input type="text" id="vehicle_description" placeholder="e.g., 2024 Ford Transit - White">
        </div>
        <div class="form-group full-width">
          <label>Project Description</label>
          <textarea id="project_description" placeholder="Describe the project scope..."></textarea>
        </div>
      </div>
    </div>
    
    <!-- Project Files (Document Level) -->
    <div class="card">
      <div class="card-title">
        <span>Project Files</span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
      </div>
      <div class="project-files-grid" id="project-files-container">
        <!-- Files populated by JS -->
        <label class="project-file-add">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
          <span>Add File</span>
          <input type="file" multiple accept=".jpg,.jpeg,.png,.svg,.pdf,.ai,.eps" onchange="handleProjectFileUpload(event)">
        </label>
      </div>
    </div>
    
    <!-- Line Items -->
    <div class="card">
      <div class="card-title">
        <span>Line Items</span>
      </div>
      
      <!-- Line Item Groups Container -->
      <div id="line-item-groups" class="line-item-groups">
        <!-- Groups populated by JS -->
      </div>
      
      <!-- Add Section Button -->
      <div class="add-section-row">
        <button class="add-section-btn" onclick="openSectionModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
          Add Section
        </button>
      </div>
      
      <!-- Fees Section -->
      <div class="fees-section" id="fees-section">
        <div class="fees-header">
          <span class="fees-title">Fees & Adjustments</span>
          <button class="add-fee-btn" onclick="addFee()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            Add Fee
          </button>
        </div>
        <div class="fees-list" id="fees-list">
          <!-- Fees populated by JS -->
        </div>
        <div class="fees-total">
          <span class="fees-total-label">Fees Total:</span>
          <span class="fees-total-amount" id="fees-total-display">$0.00</span>
        </div>
      </div>
      
      <!-- Totals -->
      <div class="totals-section">
        <div class="totals-box">
          <div class="totals-row subtotal">
            <span>Subtotal</span>
            <span id="subtotal-display">$0.00</span>
          </div>
          <div class="totals-row discount-row">
            <span>Discount</span>
            <div class="discount-controls">
              <select id="discount_type" onchange="onDiscountTypeChange()">
                <option value="none">None</option>
                <option value="5%">5%</option>
                <option value="10%">10%</option>
                <option value="15%">15%</option>
                <option value="20%">20%</option>
                <option value="25%">25%</option>
                <option value="flat">Flat $</option>
                <option value="custom%">Custom %</option>
              </select>
              <input type="number" id="discount_value" value="0" min="0" step="0.01" onchange="calculateDiscount()" style="display:none;" placeholder="Amount">
              <input type="hidden" id="discount_amount" value="0">
              <span id="discount_display" class="discount-display">-$0.00</span>
            </div>
          </div>
          <div class="totals-row">
            <span>Tax</span>
            <input type="number" id="tax_amount" value="0" min="0" step="0.01" onchange="recalculateTotals()">
          </div>
          <div class="totals-row total">
            <span>Total</span>
            <span id="total-display">$0.00</span>
          </div>
          <div class="totals-row">
            <span>Deposit Required</span>
            <input type="number" id="deposit_required" value="0" min="0" step="0.01">
          </div>
          <div class="totals-row paid" id="amount-paid-row" style="display:none;">
            <span>Amount Paid</span>
            <span id="amount-paid-display">$0.00</span>
          </div>
          <div class="totals-row balance" id="balance-due-row" style="display:none;">
            <span>Balance Due</span>
            <span id="balance-due-display">$0.00</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Line Item Configuration Modal -->
    <div id="line-item-modal-overlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:99999; justify-content:center; align-items:center;" onclick="closeLineItemModal(event)">
      <div style="background:var(--bg-surface, #1e1e1e); border:1px solid var(--border-color, rgba(148,163,184,0.15)); border-radius:12px; width:95%; max-width:500px; max-height:90vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.5);" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center; padding:20px 24px; border-bottom:1px solid var(--border-color, rgba(148,163,184,0.15));">
          <span id="line-item-modal-title" style="font-size:18px; font-weight:600; color:var(--text-primary, #f1f5f9);">Configure Line Item</span>
          <button onclick="closeLineItemModal()" style="background:none; border:none; color:var(--text-muted, #64748b); cursor:pointer; padding:4px; display:flex; align-items:center; justify-content:center;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div id="line-item-modal-body" style="padding:24px;">
          <!-- Dynamic content loaded here -->
        </div>
        <div style="display:flex; justify-content:flex-end; gap:12px; padding:16px 24px; border-top:1px solid var(--border-color, rgba(148,163,184,0.15));">
          <button class="btn btn-secondary" onclick="closeLineItemModal()">Cancel</button>
          <button class="btn btn-primary" onclick="confirmLineItem()">Add to Quote</button>
        </div>
      </div>
    </div>
    
    <!-- Payments Section (Invoice Only) -->
    <div class="card" id="payments-section" style="display:none;">
      <div class="card-title">
        <span>Payments</span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
      </div>
      <div class="payments-list" id="payments-list">
        <!-- Payments populated by JS -->
      </div>
      <div class="record-payment-form">
        <div class="form-group">
          <label>Amount</label>
          <input type="number" id="payment-amount" placeholder="0.00" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label>Method</label>
          <select id="payment-method">
            <option value="Card">Card</option>
            <option value="Cash">Cash</option>
            <option value="Check">Check</option>
            <option value="Transfer">Transfer</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <button class="btn btn-success" onclick="recordPayment()">Record Payment</button>
      </div>
    </div>

    <!-- Revision History -->
    <div class="card" id="revision-history-section" style="display:none;">
      <div class="card-title">
        <span>Revision Requests</span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
      </div>
      <div class="revision-thread" id="revision-thread"></div>
      <div class="revision-reply-box">
        <textarea id="revision-reply" placeholder="Reply to customer..." rows="2"></textarea>
        <div class="revision-reply-options">
          <label class="revision-checkbox">
            <input type="checkbox" id="revision-send-sms">
            <span>Send SMS to customer</span>
          </label>
          <label class="revision-checkbox revision-indent" id="revision-include-link-label" style="display:none;">
            <input type="checkbox" id="revision-include-link">
            <span>Include quote link</span>
          </label>
        </div>
        <button class="btn btn-primary btn-sm" onclick="sendRevisionReply()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
          Save & Send
        </button>
      </div>
    </div>
    
    <!-- Internal Notes -->
    <div class="card">
      <div class="card-title">
        <span>Internal Notes</span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
      </div>
      <textarea class="notes-textarea" id="notes" placeholder="Internal notes (not shown to customer)..."></textarea>
    </div>
    
    <!-- Linked Tasks -->
    <div class="card" id="linked-tasks-section">
      <div class="card-title">
        <span>Linked Tasks</span>
        <button class="btn btn-primary btn-sm" onclick="openAddLinkedTaskModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
          Add Task
        </button>
      </div>
      <div id="linked-tasks-list" class="linked-tasks-list">
        <div class="no-tasks-message" style="color:var(--text-muted);font-size:13px;padding:12px 0;">No tasks linked to this document</div>
      </div>
    </div>
    
    <!-- Scheduled Events (Invoice Only) -->
    <div class="card" id="scheduled-events-section" style="display:none;">
      <div class="card-title">
        <span>Scheduled Events</span>
        <button class="btn btn-primary btn-sm" onclick="openScheduleModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
          Schedule It
        </button>
      </div>
      <div class="scheduled-events-list" id="scheduled-events-list">
        <div class="no-events-message">No events scheduled</div>
      </div>
    </div>
  </div>
  
  <!-- Sticky Footer -->
  <div class="sticky-footer" id="sticky-footer">
    <div class="footer-left">
      <button class="btn btn-secondary" onclick="goBack()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
        Back
      </button>
    </div>
    <div class="footer-right">
      <button class="btn btn-primary" id="btn-save" onclick="saveDocument()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
        Save
      </button>
    </div>
  </div>
  
  <!-- Lightbox for Image Preview -->
  <div class="lightbox" id="lightbox">
    <div class="lightbox-header">
      <div class="lightbox-counter" id="lightbox-counter">1 / 1</div>
      <div class="lightbox-controls">
        <button class="lightbox-btn" onclick="lightboxZoomIn()" title="Zoom In">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
        </button>
        <button class="lightbox-btn" onclick="lightboxZoomOut()" title="Zoom Out">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
        </button>
        <button class="lightbox-btn" onclick="lightboxResetZoom()" title="Reset">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
        </button>
        <button class="lightbox-btn" onclick="closeLightbox()" title="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
    </div>
    
    <button class="lightbox-nav prev" id="lightbox-prev" onclick="lightboxPrev()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
    </button>
    
    <div class="lightbox-image-container" id="lightbox-container">
      <img class="lightbox-image" id="lightbox-img" src="" alt="" draggable="false">
    </div>
    
    <button class="lightbox-nav next" id="lightbox-next" onclick="lightboxNext()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
    </button>
    
    <div class="lightbox-footer">
      <div class="lightbox-filename" id="lightbox-filename"></div>
      <div class="lightbox-actions">
        <a id="lightbox-download" href="" download>Download</a>
      </div>
    </div>
  </div>
  
  <!-- Schedule Modal Container -->
  <div id="schedule-modal-container"></div>
  
  <!-- Follow-Up Modal Container -->
  <div id="followup-modal-container"></div>
  
  <!-- Archive Modal Container -->
  <div id="archive-modal-container"></div>
  
  <!-- Send Modal Container -->
  <div id="send-modal-container"></div>
</div>

<script>
  // ========================================================================
  // STATE
  // ========================================================================
  let currentDocument = null;
  let lineItems = [];
  let projectFiles = [];
  let isNewDocument = false;
  let lineItemGroups = [];
  let quoteBuilderConfig = { categories: [], packages: [], templates: [], lineItemTypes: [], feeTypes: [] };
  let documentFees = [];
  
  // R2 Upload Config
  const R2_WORKER_URL = 'https://fwg-upload.yellow-rain-80cf.workers.dev';
  const R2_PUBLIC_URL = 'https://pub-2ae8eecf3c4d4b5f84b0dcf3aebb2ac9.r2.dev';


  
  
  // ========================================================================
  // INITIALIZATION
  // ========================================================================
  
  // Alias for dashboard compatibility
  function loadDocumentDetail(docId) {
    loadDocument(docId);
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    // Check if we're embedded in dashboard (no auto-load) or standalone
    const urlParams = new URLSearchParams(window.location.search);
    let docId = urlParams.get('id') || '';
    
    // Try template variable
    try {
      const templateDocId = '<?!= docId || "" ?>';
      if (!docId && templateDocId && templateDocId !== '<?!= docId || "" ?>') {
        docId = templateDocId;
      }
    } catch(e) {}
    
    // Only auto-load if we have a docId from URL/template (standalone mode)
    if (docId && docId !== '' && docId !== 'new') {
      loadDocument(docId);
    } else if (window.location.search.includes('page=document') || window.location.search.includes('page=quote') || window.location.search.includes('page=invoice')) {
      // Standalone with 'new' or no id - show new document form
      isNewDocument = true;
      initNewDocument();
    }
    // Otherwise, wait for loadDocumentDetail() to be called from dashboard
  });
  
  function initNewDocument() {
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('main-content').style.display = 'block';
    document.getElementById('sticky-footer').style.display = 'flex';
    
    // Default to quote
    currentDocument = {
      doc_type: 'quote',
      status: 'Draft'
    };
    
    updateUIForDocType('quote');
    renderLineItems();
    renderProjectFiles();
    renderActions();
  }
  
  function loadDocument(docId) {
    // Show loading state
    document.getElementById('loading-state').style.display = 'flex';
    document.getElementById('main-content').style.display = 'none';
    document.getElementById('sticky-footer').style.display = 'none';
    
    // Load config first, then document
    google.script.run
      .withSuccessHandler(function(configResult) {
        if (configResult.ok) {
          quoteBuilderConfig = configResult;
        }
        // Now load the document
        loadDocumentData(docId);
      })
      .withFailureHandler(function(error) {
        console.log('Config load error, continuing:', error);
        loadDocumentData(docId);
      })
      .getQuoteBuilderConfig();
  }
  
  function loadDocumentData(docId) {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.ok) {
          currentDocument = result.document;
          lineItems = result.document.line_items || [];
          documentFees = result.document.fees || [];
          projectFiles = result.document.project_files || [];
          renderDocument();
        } else {
          showToast('Error loading document: ' + result.error, 'error');
          document.getElementById('loading-state').innerHTML = 
            '<div style="color:#f87171;">Error: ' + result.error + '</div>';
        }
      })
      .withFailureHandler(function(error) {
        showToast('Failed to load document', 'error');
        document.getElementById('loading-state').innerHTML = 
          '<div style="color:#f87171;">Error: ' + error + '</div>';
      })
      .getDocumentById(docId);
  }
  
  function initializeGroupsFromLineItems() {
    // Build groups from existing line items based on their category
    
    const categoryMap = {};
    
    lineItems.forEach(item => {
      // First restore custom fields (which may include group_id)
      if (item.custom_fields_json) {
        try {
          const custom = typeof item.custom_fields_json === 'string' 
            ? JSON.parse(item.custom_fields_json) 
            : item.custom_fields_json;
          Object.assign(item, custom);
        } catch(e) {}
      }
      
      const cat = item.category || 'OTHER';
      
      // Use existing group_id if present, otherwise create new one
      if (item.group_id) {
        if (!categoryMap[cat]) {
          categoryMap[cat] = item.group_id;
        }
      } else {
        if (!categoryMap[cat]) {
          categoryMap[cat] = 'grp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
        }
        item.group_id = categoryMap[cat];
      }
    });
    
    // Create group objects
    lineItemGroups = Object.entries(categoryMap).map(([category, groupId]) => ({
      group_id: groupId,
      category_key: category
    }));
    
  }
  
  function renderDocument() {
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('main-content').style.display = 'block';
    document.getElementById('sticky-footer').style.display = 'flex';
    
    const doc = currentDocument;
    
    // Header
    document.getElementById('doc-id').textContent = doc.doc_id;
    document.getElementById('doc-type-label').textContent = doc.doc_type === 'invoice' ? 'Invoice' : 'Quote';
    
    const badge = document.getElementById('doc-type-badge');
    badge.textContent = doc.doc_type === 'invoice' ? 'Invoice' : 'Quote';
    badge.className = 'doc-type-badge ' + doc.doc_type;
    
    const statusBadge = document.getElementById('doc-status-badge');
    statusBadge.textContent = doc.status;
    statusBadge.className = 'status-badge ' + doc.status.toLowerCase().replace(' ', '-');
    
    // Dates
    let datesHtml = '';
    if (doc.created_at) datesHtml += '  Created: ' + formatDate(doc.created_at);
    if (doc.sent_at) datesHtml += '  Sent: ' + formatDate(doc.sent_at);
    if (doc.viewed_at) datesHtml += '  Viewed: ' + formatDate(doc.viewed_at);
    document.getElementById('doc-dates').innerHTML = datesHtml;
    
    // Form fields
    document.getElementById('customer_name').value = doc.customer_name || '';
    document.getElementById('company_name').value = doc.company_name || '';
    document.getElementById('customer_email').value = doc.customer_email || '';
    document.getElementById('customer_phone').value = doc.customer_phone || '';
    document.getElementById('vehicle_description').value = doc.vehicle_description || '';
    document.getElementById('project_description').value = doc.project_description || '';
    document.getElementById('notes').value = doc.notes || '';
    
    // Load revision history
    renderRevisionHistory(doc.revision_history_json);
    
    // Totals
    // Set discount with smart detection
    const subtotal = (doc.line_items || []).reduce((sum, item) => {
      const qty = Number(item.qty) || Number(item.sqft) || Number(item.hours) || Number(item.quantity) || 1;
      const price = Number(item.rate) || Number(item.unit_price) || 0;
      return sum + (qty * price);
    }, 0);
    setDiscountFromDocument(doc.discount_amount || 0, subtotal);
    document.getElementById('tax_amount').value = doc.tax_amount || 0;
    document.getElementById('deposit_required').value = doc.deposit_required || 0;
    
    // Update UI based on doc type
    updateUIForDocType(doc.doc_type);
    
    // Initialize groups from existing line items
    initializeGroupsFromLineItems();
    
    // Render line items, project files, actions
    renderLineItems();
    renderProjectFiles();
    renderPayments();
    renderActions();
    recalculateTotals();
    loadLinkedTasks();
  }
  
  function updateUIForDocType(docType) {
    const isInvoice = docType === 'invoice';
    
    // Show/hide invoice-specific elements
    document.getElementById('payments-section').style.display = isInvoice ? 'block' : 'none';
    document.getElementById('amount-paid-row').style.display = isInvoice ? 'flex' : 'none';
    document.getElementById('balance-due-row').style.display = isInvoice ? 'flex' : 'none';
    document.getElementById('scheduled-events-section').style.display = isInvoice ? 'block' : 'none';
    
    // Load scheduled events for invoices
    if (isInvoice && currentDocument && currentDocument.doc_id) {
      loadScheduledEvents();
    }
  }

  // ========================================================================
  // REVISION HISTORY
  // ========================================================================
  function renderRevisionHistory(revisionJson) {
    const section = document.getElementById('revision-history-section');
    const thread = document.getElementById('revision-thread');
    
    let revisions = [];
    if (revisionJson) {
      try {
        revisions = typeof revisionJson === 'string' ? JSON.parse(revisionJson) : revisionJson;
      } catch(e) {
        revisions = [];
      }
    }
    
    // Show/hide section based on whether there are revisions
    if (revisions.length === 0) {
      section.style.display = 'none';
      return;
    }
    
    section.style.display = 'block';
    
    // Build thread HTML
    let html = '';
    revisions.forEach(rev => {
      const isCustomer = rev.from === 'customer';
      const timestamp = new Date(rev.timestamp).toLocaleString();
      const fromName = isCustomer ? (rev.name || 'Customer') : 'FWG';
      
      html += `
        <div class="revision-message ${isCustomer ? 'from-customer' : 'from-fwg'}">
          <div class="revision-message-header">
            <span class="revision-message-from">${escapeHtml(fromName)}</span>
            <span>${timestamp}</span>
          </div>
          <div class="revision-message-text">${escapeHtml(rev.message)}</div>
        </div>
      `;
    });
    
    thread.innerHTML = html;
    
    // Scroll to bottom
    thread.scrollTop = thread.scrollHeight;
  }
  
  function sendRevisionReply() {
    const textarea = document.getElementById('revision-reply');
    const message = textarea.value.trim();
    const sendSms = document.getElementById('revision-send-sms').checked;
    const includeLink = document.getElementById('revision-include-link').checked;
    
    if (!message) {
      showToast('Please enter a message', 'error');
      return;
    }
    
    const btn = document.querySelector('.revision-reply-box .btn');
    btn.disabled = true;
    btn.innerHTML = 'Sending...';
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.ok) {
          textarea.value = '';
          document.getElementById('revision-send-sms').checked = false;
          document.getElementById('revision-include-link').checked = false;
          document.getElementById('revision-include-link-label').style.display = 'none';
          
          const successMsg = sendSms ? 'Reply saved & SMS sent!' : 'Reply saved!';
          showToast(successMsg, 'success');
          // Reload to show updated thread
          loadDocument(currentDocument.doc_id);
        } else {
          showToast('Error: ' + (result.error || 'Failed to send'), 'error');
        }
        btn.disabled = false;
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg> Save & Send';
      })
      .withFailureHandler(function(error) {
        showToast('Error: ' + error, 'error');
        btn.disabled = false;
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg> Save & Send';
      })
      .addRevisionReply(currentDocument.doc_id, message, sendSms, includeLink);
  }
  
  // Toggle "Include quote link" visibility based on SMS checkbox
  document.addEventListener('DOMContentLoaded', function() {
    const smsCheckbox = document.getElementById('revision-send-sms');
    if (smsCheckbox) {
      smsCheckbox.addEventListener('change', function() {
        document.getElementById('revision-include-link-label').style.display = this.checked ? 'flex' : 'none';
        if (!this.checked) {
          document.getElementById('revision-include-link').checked = false;
        }
      });
    }
  });
  
  // ========================================================================
  // LINE ITEMS (Groups System)
  // ========================================================================
  function renderLineItems() {
    // Redirect to groups renderer
    renderLineItemGroups();
  }
  
  function renderLineItemGroups() {
    const container = document.getElementById('line-item-groups');
    
    if (lineItemGroups.length === 0) {
      container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No line items yet. Click "Add Section" to start building your quote.</div>';
      return;
    }
    
    container.innerHTML = lineItemGroups.map(group => renderGroup(group)).join('');
  }
  
  function renderGroup(group) {
    const category = quoteBuilderConfig.categories.find(c => c.category_key === group.category_key) || {};
    const groupItems = lineItems.filter(item => item.group_id === group.group_id);
    const template = getTemplateForCategory(group.category_key);
    
    const groupTotal = groupItems.reduce((sum, item) => {
      const qty = Number(item.qty) || Number(item.sqft) || Number(item.hours) || Number(item.quantity) || 1;
      const price = Number(item.rate) || Number(item.unit_price) || 0;
      return sum + (qty * price);
    }, 0);
    
    const color = category.calendar_color || '#6b7280';
    const label = category.label || group.category_key;
    
    return `
      <div class="line-item-group" data-group-id="${group.group_id}">
        <div class="line-item-group-header">
          <div class="line-item-group-color" style="background: ${color};"></div>
          <div class="line-item-group-title">${escapeHtml(label)}</div>
          <div class="line-item-group-count">${groupItems.length} item${groupItems.length !== 1 ? 's' : ''}</div>
          <div class="line-item-group-total">$${formatMoney(groupTotal)}</div>
          <button class="line-item-group-delete" onclick="deleteGroup('${group.group_id}')" title="Delete Section">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
          </button>
        </div>
        <div class="line-item-group-body">
          <table class="line-items-table">
            <thead>
              <tr>
                ${renderGroupHeaders(template, group.category_key)}
                <th class="line-item-actions"></th>
              </tr>
            </thead>
            <tbody>
              ${renderGroupRows(group, template)}
            </tbody>
          </table>
        </div>
        <div class="line-item-group-add">
          <button onclick="addLineItemToGroup('${group.group_id}')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            Add Line Item
          </button>
        </div>
      </div>
    `;
  }
  
  function getTemplateForCategory(categoryKey) {
    const category = quoteBuilderConfig.categories.find(c => c.category_key === categoryKey);
    const templateKey = category?.line_template || 'DEFAULT';
    const template = quoteBuilderConfig.templates.find(t => t.template_key === templateKey);
    
    // Fallback default template
    if (!template) {
      return {
        template_key: 'DEFAULT',
        column_1_key: 'description', column_1_label: 'Description', column_1_type: 'text',
        column_2_key: 'quantity', column_2_label: 'Qty', column_2_type: 'number',
        column_3_key: 'unit_price', column_3_label: 'Price', column_3_type: 'number',
        column_4_key: 'total', column_4_label: 'Total', column_4_type: 'calculated'
      };
    }
    return template;
  }
  
  function renderGroupHeaders(template, categoryKey) {
    let html = '';
    const hasPackages = categoryHasPackages(categoryKey);
    const hasTypes = categoryHasTypes(categoryKey);
    
    if (hasPackages) {
      html += '<th style="width:140px;">Package</th>';
    }
    
    // Add Type header for categories with types (only once)
    if (hasTypes) {
      html += '<th style="width:140px;">Type</th>';
    }
    
    for (let i = 1; i <= 7; i++) {
      const key = template['column_' + i + '_key'];
      const label = template['column_' + i + '_label'];
      // Skip package column if we already added package dropdown
      // Skip type column if category has types (we already added it above)
      if (key && label && !(hasPackages && key === 'package') && !(hasTypes && key === 'type')) {
        const width = template['column_' + i + '_width'] || '';
        html += `<th style="${width ? 'width:' + width + ';' : ''}">${escapeHtml(label)}</th>`;
      }
    }
    return html;
  }
  
  function renderGroupRows(group, template) {
    const groupItems = lineItems.filter(item => item.group_id === group.group_id);
    
    return groupItems.map(item => {
      const globalIndex = lineItems.indexOf(item);
      return renderGroupRow(item, globalIndex, group, template);
    }).join('');
  }
  
  function renderGroupRow(item, globalIndex, group, template) {
    const hasPackages = categoryHasPackages(group.category_key);
    const hasTypes = categoryHasTypes(group.category_key);
    
    let cells = '';
    
    // Type dropdown if applicable
    if (hasTypes) {
      cells += `
        <td>
          <select class="line-item-input" onchange="onInlineTypeChange(${globalIndex}, this.value)">
            <option value="">-- Select Type --</option>
            ${renderTypeOptions(group.category_key, item.line_type || item.type_key)}
          </select>
        </td>
      `;
    }
    
    // Package dropdown if applicable
    if (hasPackages) {
      cells += `
        <td>
          <select class="line-item-input" onchange="onPackageChange(${globalIndex}, this.value)">
            <option value="">-- Select --</option>
            ${renderPackageOptions(group.category_key, item.package_key)}
          </select>
        </td>
      `;
    }
    
    // Template columns
    for (let i = 1; i <= 7; i++) {
      const colKey = template['column_' + i + '_key'];
      const colType = template['column_' + i + '_type'];
      // Skip package column if we already added package dropdown
      // Skip type column if we already added type dropdown
      if (colKey && !(hasPackages && colKey === 'package') && !(hasTypes && colKey === 'type')) {
        cells += renderTemplateCell(item, globalIndex, colKey, colType);
      }
    }
    
    return `
      <tr data-index="${globalIndex}">
        ${cells}
        <td class="line-item-actions">
          <button class="line-item-delete" onclick="deleteLineItem(${globalIndex})" title="Delete">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
          </button>
        </td>
      </tr>
      <tr class="attachments-row">
        <td colspan="20">
          <div class="attachments-container" id="attachments-${globalIndex}">
            ${renderAttachments(item.attachments || [], globalIndex, item.line_id)}
          </div>
        </td>
      </tr>
    `;
  }
  
  function renderTemplateCell(item, index, colKey, colType) {
    const value = item[colKey] ?? '';
    
    if (colType === 'calculated') {
      // For VINYL_GRAPHICS: sqft * rate
      // For others: qty * unit_price
      const sqft = Number(item.sqft) || 0;
      const qty = Number(item.qty) || Number(item.hours) || Number(item.quantity) || 1;
      const rate = Number(item.rate) || Number(item.unit_price) || 0;
      
      // Use sqft if available, otherwise qty
      const total = sqft > 0 ? (sqft * rate) : (qty * rate);
      item.line_total = total; // Store for later use
      return `<td class="col-${colKey} col-total line-item-total">$${formatMoney(total)}</td>`;
    }
    
    // Handle dropdown type for VINYL_GRAPHICS inline editing
    if (colType === 'dropdown') {
      return renderInlineDropdown(item, index, colKey);
    }
    
    if (colType === 'number') {
      const isQtyField = ['quantity', 'qty', 'sqft', 'hours', 'width_in', 'height_in'].includes(colKey);
      const isPriceField = ['rate', 'unit_price'].includes(colKey);
      const displayValue = isPriceField ? (Number(value) || Number(item.rate) || Number(item.unit_price) || 0).toFixed(2) : (value || (isQtyField ? '' : 0));
      return `
        <td class="col-${colKey} ${isQtyField ? 'line-item-qty' : ''} ${isPriceField ? 'line-item-price' : ''}">
          <input type="number" class="line-item-input" 
                 value="${displayValue}" 
                 min="0" step="${isPriceField ? '0.01' : (isQtyField ? '0.1' : '1')}"
                 oninput="updateLineItemAndRecalc(${index}, '${colKey}', parseFloat(this.value) || 0)"
                 placeholder="${isQtyField ? '0' : ''}">
        </td>
      `;
    }
    
    if (colType === 'select') {
      return `
        <td class="col-${colKey}">
          <input type="text" class="line-item-input" value="${escapeHtml(value)}" 
                 onchange="updateLineItem(${index}, '${colKey}', this.value)">
        </td>
      `;
    }
    
    // Default: text input
    return `
      <td class="col-${colKey}">
        <input type="text" class="line-item-input" value="${escapeHtml(value)}" 
               onchange="updateLineItem(${index}, '${colKey}', this.value)"
               placeholder="${colKey === 'description' ? 'Description' : ''}">
      </td>
    `;
  }
  
  function renderInlineDropdown(item, index, colKey) {
    const typeKey = item.type_key || item.line_type || '';
    
    // TYPE dropdown
    if (colKey === 'type') {
      const types = (quoteBuilderConfig.lineItemTypes || []).filter(t => t.category_key === item.category && t.active !== false && t.active !== 'FALSE');
      return `
        <td class="col-${colKey}">
          <select class="line-item-input" onchange="onInlineTypeChange(${index}, this.value)" style="min-width:120px;">
            <option value="">-- Select --</option>
            ${types.map(t => `<option value="${t.type_key}" ${t.type_key === typeKey ? 'selected' : ''}>${escapeHtml(t.label)}</option>`).join('')}
          </select>
        </td>
      `;
    }
    
    // MEDIA dropdown
    if (colKey === 'media') {
      const mediaKey = item.media_key || '';
      const mediaLabel = item.media_label || '';
      const displayText = mediaLabel || (mediaKey ? mediaKey.replace(/_/g, ' ') : '-- Select --');
      return `
        <td class="col-${colKey}">
          <select class="line-item-input" onchange="onInlineMaterialChange(${index}, 'media', this.value)" style="min-width:100px;" id="media-select-${index}">
            <option value="">-- Select --</option>
            ${mediaKey ? `<option value="${escapeHtml(mediaKey)}" selected>${escapeHtml(displayText)}</option>` : ''}
          </select>
        </td>
      `;
    }
    
    // LAMINATION dropdown
    if (colKey === 'lamination') {
      const lamKey = item.lamination_key || '';
      const lamLabel = item.lamination_label || '';
      const displayText = lamLabel || (lamKey ? lamKey.replace(/_/g, ' ') : '-- None --');
      return `
        <td class="col-${colKey}">
          <select class="line-item-input" onchange="onInlineMaterialChange(${index}, 'lamination', this.value)" style="min-width:100px;" id="lam-select-${index}">
            <option value="">-- None --</option>
            ${lamKey ? `<option value="${escapeHtml(lamKey)}" selected>${escapeHtml(displayText)}</option>` : ''}
          </select>
        </td>
      `;
    }
    
    // TRANSFER_TAPE dropdown
    if (colKey === 'transfer_tape') {
      const tapeKey = item.transfer_tape_key || '';
      const tapeLabel = item.transfer_tape_label || '';
      const displayText = tapeLabel || (tapeKey ? tapeKey.replace(/_/g, ' ') : '-- None --');
      const typeConfig = (quoteBuilderConfig.lineItemTypes || []).find(t => t.type_key === typeKey);
      
      // Hide if type doesn't use transfer tape
      if (!typeConfig || !typeConfig.default_transfer_tape) {
        return `<td class="col-${colKey}"><span style="color:var(--text-muted); font-size:12px;">N/A</span></td>`;
      }
      
      return `
        <td class="col-${colKey}">
          <select class="line-item-input" onchange="onInlineMaterialChange(${index}, 'transfer_tape', this.value)" style="min-width:100px;" id="tape-select-${index}">
            <option value="">-- None --</option>
            ${tapeKey ? `<option value="${escapeHtml(tapeKey)}" selected>${escapeHtml(displayText)}</option>` : ''}
          </select>
        </td>
      `;
    }
    
    // Fallback
    return `<td class="col-${colKey}"><input type="text" class="line-item-input" value="" onchange="updateLineItem(${index}, '${colKey}', this.value)"></td>`;
  }
  
  function onInlineTypeChange(index, typeKey) {
    const item = lineItems[index];
    if (!item) return;
    
    item.type_key = typeKey;
    item.line_type = typeKey;
    
    // Get type config and set defaults
    const typeConfig = (quoteBuilderConfig.lineItemTypes || []).find(t => t.type_key === typeKey);
    if (typeConfig) {
      item.media_key = typeConfig.default_media || '';
      item.lamination_key = typeConfig.default_lamination || '';
      item.transfer_tape_key = typeConfig.default_transfer_tape || '';
      
      // Load materials to get labels and calculate rate
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.ok) {
            const materials = result.materials || [];
            const media = materials.find(m => m.material_key === item.media_key);
            const lam = materials.find(m => m.material_key === item.lamination_key);
            const tape = materials.find(m => m.material_key === item.transfer_tape_key);
            
            item.media_label = media ? media.Material : '';
            item.lamination_label = lam ? lam.Material : '';
            item.transfer_tape_label = tape ? tape.Material : '';
            
            const mediaCost = media ? parseFloat(media.mark_up) || 0 : 0;
            const lamCost = lam ? parseFloat(lam.mark_up) || 0 : 0;
            const tapeCost = tape ? parseFloat(tape.mark_up) || 0 : 0;
            const laborCost = parseFloat(typeConfig.labor_per_sqft) || 0;
            
            item.rate = mediaCost + lamCost + tapeCost + laborCost;
            item.unit_price = item.rate;
            
            renderLineItemGroups();
            recalculateTotals();
          }
        })
        .withFailureHandler(function(err) {
          console.error('Failed to load materials:', err);
          renderLineItemGroups();
          recalculateTotals();
        })
        .getMaterialsForType(typeKey);
    } else {
      renderLineItemGroups();
      recalculateTotals();
    }
  }
  
  function onInlineMaterialChange(index, field, materialKey) {
    const item = lineItems[index];
    if (!item) return;
    
    const keyField = field + '_key';
    item[keyField] = materialKey;
    
    // Recalculate - would need to fetch material cost
    // For now, just update and re-render
    renderLineItemGroups();
    recalculateTotals();
  }
  
  function updateLineItemAndRecalc(index, field, value) {
    const item = lineItems[index];
    if (!item) return;
    
    item[field] = value;
    
    // Sync rate and unit_price
    if (field === 'rate') {
      item.unit_price = value;
    } else if (field === 'unit_price') {
      item.rate = value;
    }
    
    // Calculate line total based on sqft * rate
    const sqft = Number(item.sqft) || 0;
    const rate = Number(item.rate) || Number(item.unit_price) || 0;
    item.line_total = sqft * rate;
    
    // Also sync quantity for backend (uses quantity not sqft for calculation)
    item.quantity = sqft;
    
    // Update the total cell without full re-render (preserves focus)
    const row = document.querySelector(`tr[data-index="${index}"]`);
    if (row) {
      const totalCell = row.querySelector('.col-total');
      if (totalCell) {
        totalCell.textContent = '$' + formatMoney(item.line_total);
      }
    }
    
    // Update group totals and document totals
    updateGroupTotals();
    recalculateTotals();
  }
  
  function categoryHasPackages(categoryKey) {
    const category = quoteBuilderConfig.categories.find(c => c.category_key === categoryKey);
    return category?.has_packages === true || category?.has_packages === 'TRUE';
  }
  
  function categoryHasTypes(categoryKey) {
    const category = quoteBuilderConfig.categories.find(c => c.category_key === categoryKey);
    return category?.has_types === true || category?.has_types === 'TRUE';
  }
  
  function renderTypeOptions(categoryKey, selectedType) {
    const types = (quoteBuilderConfig.lineItemTypes || []).filter(t => t.category_key === categoryKey);
    return types.map(type => 
      `<option value="${type.type_key}" ${type.type_key === selectedType ? 'selected' : ''}>${escapeHtml(type.label)}</option>`
    ).join('');
  }
  
  function onTypeChange(index, typeKey) {
    lineItems[index].line_type = typeKey;
    
    const type = quoteBuilderConfig.lineItemTypes.find(t => t.type_key === typeKey);
    if (type && type.default_rate) {
      lineItems[index].unit_price = type.default_rate;
      lineItems[index].rate = type.default_rate;
    }
    
    renderLineItemGroups();
    renderFees();
    recalculateTotals();
  }

  // ============================================================================
  // FEES FUNCTIONS
  // ============================================================================
  
  function renderFees() {
    const container = document.getElementById('fees-list');
    
    if (documentFees.length === 0) {
      container.innerHTML = '<div style="text-align: center; padding: 12px; color: var(--text-muted); font-size: 13px;">No fees added</div>';
    } else {
      container.innerHTML = documentFees.map((fee, index) => renderFeeRow(fee, index)).join('');
    }
    
    updateFeesTotal();
  }
  
  function renderFeeRow(fee, index) {
    const feeTypes = quoteBuilderConfig.feeTypes || [];
    const typeOptions = feeTypes.map(ft => 
      `<option value="${ft.fee_type_key}" ${ft.fee_type_key === fee.fee_type ? 'selected' : ''}>${escapeHtml(ft.label)}</option>`
    ).join('');
    
    return `
      <div class="fee-row" data-fee-index="${index}">
        <div class="fee-type">
          <select onchange="updateFee(${index}, 'fee_type', this.value)">
            <option value="">-- Select --</option>
            ${typeOptions}
          </select>
        </div>
        <div class="fee-description">
          <input type="text" value="${escapeHtml(fee.description || '')}" 
                 placeholder="Description"
                 onchange="updateFee(${index}, 'description', this.value)">
        </div>
        <div class="fee-amount">
          <input type="number" value="${fee.amount || 0}" min="0" step="0.01"
                 onchange="updateFee(${index}, 'amount', parseFloat(this.value) || 0)">
        </div>
        <button class="fee-delete" onclick="deleteFee(${index})" title="Remove fee">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          </svg>
        </button>
      </div>
    `;
  }
  
  function addFee() {
    documentFees.push({
      fee_type: '',
      description: '',
      amount: 0
    });
    renderFees();
    recalculateTotals();
  }
  
  function updateFee(index, field, value) {
    if (documentFees[index]) {
      documentFees[index][field] = value;
      
      // If fee_type changed, auto-fill description and default amount
      if (field === 'fee_type' && value) {
        const feeType = (quoteBuilderConfig.feeTypes || []).find(ft => ft.fee_type_key === value);
        if (feeType) {
          if (!documentFees[index].description) {
            documentFees[index].description = feeType.label;
          }
          if (!documentFees[index].amount && feeType.default_amount) {
            documentFees[index].amount = feeType.default_amount;
          }
          renderFees();
        }
      }
      
      updateFeesTotal();
      recalculateTotals();
    }
  }
  
  function deleteFee(index) {
    documentFees.splice(index, 1);
    renderFees();
    recalculateTotals();
  }
  
  function updateFeesTotal() {
    const total = documentFees.reduce((sum, fee) => sum + (Number(fee.amount) || 0), 0);
    document.getElementById('fees-total-display').textContent = formatCurrency(total);
  }
  
  function getFeesTotal() {
    return documentFees.reduce((sum, fee) => sum + (Number(fee.amount) || 0), 0);
  }
  
  function renderPackageOptions(categoryKey, selectedPackage) {
    const packages = quoteBuilderConfig.packages.filter(p => p.category_key === categoryKey);
    return packages.map(pkg => 
      `<option value="${pkg.package_key}" ${pkg.package_key === selectedPackage ? 'selected' : ''}>${escapeHtml(pkg.label)}</option>`
    ).join('');
  }
  
  function onPackageChange(index, packageKey) {
    if (!packageKey) {
      lineItems[index].package_key = '';
      renderLineItemGroups();
      return;
    }
    
    const pkg = quoteBuilderConfig.packages.find(p => p.package_key === packageKey);
    if (pkg) {
      lineItems[index].package_key = packageKey;
      lineItems[index].description = pkg.label + (pkg.description ? ' - ' + pkg.description : '');
      
      if (pkg.coverage_areas) {
        lineItems[index].coverage = pkg.coverage_areas;
      }
      if (pkg.material) {
        lineItems[index].material = pkg.material;
      }
      
      // Handle sqft-based pricing vs flat pricing
      if (pkg.rate_per_sqft && pkg.sqft_estimate) {
        lineItems[index].sqft = pkg.sqft_estimate;
        lineItems[index].rate = pkg.rate_per_sqft;
        lineItems[index].quantity = pkg.sqft_estimate;
        lineItems[index].unit_price = pkg.rate_per_sqft;
      } else if (pkg.base_price) {
        lineItems[index].quantity = 1;
        lineItems[index].unit_price = pkg.base_price;
      }
    }
    
    renderLineItemGroups();
    recalculateTotals();
  }
  
  function formatMoney(amount) {
    return Number(amount || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
  }
  
  function renderAttachments(attachments, lineIndex, lineItemId) {
    let html = '';
    
    // Parse attachments if string
    let atts = attachments;
    if (typeof attachments === 'string') {
      try {
        atts = JSON.parse(attachments);
      } catch (e) {
        atts = [];
      }
    }
    if (!Array.isArray(atts)) atts = [];
    
    atts.forEach((att, attIndex) => {
      const url = att.url || att.file_url || '';
      const name = att.name || att.filename || 'File';
      
      // Check if image by extension in name OR in URL
      const checkStr = (name + ' ' + url).toLowerCase();
      const isImage = /\.(jpg|jpeg|png|gif|webp|svg)/.test(checkStr);
      
      if (isImage && url) {
        html += `
          <div class="attachment-thumb" onclick="openLightbox('${url}', '${escapeHtml(name)}')">
            <img src="${url}" alt="${escapeHtml(name)}">
            <button class="attachment-delete" onclick="event.stopPropagation(); deleteAttachment(${lineIndex}, '${att.file_id || attIndex}')">&times;</button>
          </div>
        `;
      } else if (url) {
        html += `
          <div class="attachment-thumb" onclick="openLightbox('${url}', '${escapeHtml(name)}')">
            <div class="attachment-thumb-file">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
              <span>${escapeHtml(name.length > 8 ? name.substring(0, 8) + '...' : name)}</span>
            </div>
            <button class="attachment-delete" onclick="event.stopPropagation(); deleteAttachment(${lineIndex}, '${att.file_id || attIndex}')">&times;</button>
          </div>
        `;
      }
    });
    
    // Add button
    html += `
      <label class="attachment-add">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        <input type="file" multiple accept=".jpg,.jpeg,.png,.svg,.pdf,.ai,.eps" onchange="handleLineItemAttachment(${lineIndex}, '${lineItemId || ''}', event)">
      </label>
    `;
    
    return html;
  }
  
  function addLineItem() {
    // Legacy function - redirect to section modal
    openSectionModal();
  }
  
  function addLineItemToGroup(groupId) {
    console.log('addLineItemToGroup called with:', groupId);
    
    const group = lineItemGroups.find(g => g.group_id === groupId);
    console.log('Found group:', group);
    
    if (!group) return;
    
    const category = quoteBuilderConfig.categories.find(c => c.category_key === group.category_key);
    console.log('Found category:', category);
    console.log('has_types value:', category?.has_types, 'type:', typeof category?.has_types);
    
    // Special handling for VINYL_GRAPHICS - use decision tree
    if (group.category_key === 'VINYL_GRAPHICS') {
      openVinylGraphicsDecisionModal(groupId);
      return;
    }
    
    // Check if category has types - if so, open modal
    if (category && (String(category.has_types).toUpperCase() === 'TRUE' || category.has_types === true)) {
      console.log('Opening modal...');
      openLineItemModal(groupId, category);
    } else {
      console.log('Adding simple line item...');
      // No types - add simple line item directly
      lineItems.push({
        group_id: groupId,
        category: group.category_key,
        description: '',
        quantity: 1,
        unit_price: category?.default_rate || 0,
        attachments: []
      });
      renderLineItemGroups();
      recalculateTotals();
    }
  }
  
  // ============================================================================
  // VINYL GRAPHICS DECISION TREE MODAL
  // ============================================================================
  
  let vgDecisionState = {
    groupId: null,
    airRelease: null,
    plotterCut: null,
    transferTape: null
  };
  
  function openVinylGraphicsDecisionModal(groupId) {
    vgDecisionState = {
      groupId: groupId,
      airRelease: null,
      plotterCut: null,
      transferTape: null
    };
    renderVinylGraphicsDecisionModal();
  }
  
  function renderVinylGraphicsDecisionModal() {
    const state = vgDecisionState;
    const matchingType = getMatchingVinylGraphicsType();
    
    const btnBase = 'flex:1; padding:12px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:500; transition:all 0.15s;';
    const btnInactive = btnBase + 'border:2px solid var(--border-color); background:var(--bg-elevated); color:var(--text-primary);';
    const btnActive = btnBase + 'border:2px solid var(--fwg-primary); background:var(--fwg-primary-soft); color:var(--text-primary);';
    
    const modalHtml = `
      <div class="modal-backdrop" id="vg-decision-modal" onclick="closeVGDecisionModal(event)" style="position:fixed; inset:0; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:99999;">
        <div onclick="event.stopPropagation()" style="background:var(--bg-surface); border-radius:12px; width:100%; max-width:480px; max-height:90vh; overflow:hidden; border:1px solid var(--border-color);">
          
          <div style="padding:16px 20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
            <div style="font-size:18px; font-weight:600; color:var(--text-primary);">Add Vinyl Graphics</div>
            <button onclick="closeVGDecisionModal()" style="background:none; border:none; color:var(--text-muted); font-size:24px; cursor:pointer; line-height:1;">&times;</button>
          </div>
          
          <div style="padding:20px; overflow-y:auto; max-height:calc(90vh - 140px);">
            
            <div style="text-align:right; margin-bottom:16px;">
              <button onclick="skipVGDecision()" style="padding:8px 16px; background:transparent; border:1px solid var(--border-color); color:var(--text-secondary); border-radius:6px; cursor:pointer; font-size:13px;">
                Skip - I'll choose manually
              </button>
            </div>
            
            <!-- Question 1: Air Release -->
            <div style="margin-bottom:20px;">
              <div style="font-size:15px; font-weight:500; margin-bottom:8px; color:var(--text-primary);">Does this require Air Release vinyl?</div>
              <div style="font-size:13px; color:var(--text-muted); margin-bottom:12px;">Yes = Curved surfaces (cast) | No = Flat surfaces (calendared)</div>
              <div style="display:flex; gap:12px;">
                <button onclick="setVGAnswer('airRelease','yes')" style="${state.airRelease === 'yes' ? btnActive : btnInactive}">Yes</button>
                <button onclick="setVGAnswer('airRelease','no')" style="${state.airRelease === 'no' ? btnActive : btnInactive}">No</button>
              </div>
            </div>
            
            <!-- Question 2: Plotter Cut -->
            <div style="margin-bottom:20px;">
              <div style="font-size:15px; font-weight:500; margin-bottom:8px; color:var(--text-primary);">Cutting with a plotter?</div>
              <div style="font-size:13px; color:var(--text-muted); margin-bottom:12px;">Yes = Lettering, decals | No = Large panels, bulk install</div>
              <div style="display:flex; gap:12px;">
                <button onclick="setVGAnswer('plotterCut','yes')" style="${state.plotterCut === 'yes' ? btnActive : btnInactive}">Yes</button>
                <button onclick="setVGAnswer('plotterCut','no')" style="${state.plotterCut === 'no' ? btnActive : btnInactive}">No</button>
              </div>
            </div>
            
            <!-- Question 3: Transfer Tape (only if plotter = yes) -->
            ${state.plotterCut === 'yes' ? `
            <div style="margin-bottom:20px;">
              <div style="font-size:15px; font-weight:500; margin-bottom:8px; color:var(--text-primary);">Using transfer tape?</div>
              <div style="font-size:13px; color:var(--text-muted); margin-bottom:12px;">Yes = Multiple pieces, lettering | No = Single contour cut piece</div>
              <div style="display:flex; gap:12px;">
                <button onclick="setVGAnswer('transferTape','yes')" style="${state.transferTape === 'yes' ? btnActive : btnInactive}">Yes</button>
                <button onclick="setVGAnswer('transferTape','no')" style="${state.transferTape === 'no' ? btnActive : btnInactive}">No</button>
              </div>
            </div>
            ` : ''}
            
            <!-- Result -->
            ${matchingType ? `
            <div style="margin-top:20px; padding:16px; background:var(--bg-dark); border-radius:8px; border:1px solid var(--border-color);">
              <div style="font-size:13px; color:var(--text-muted); margin-bottom:6px;">Recommended Type:</div>
              <div style="font-size:16px; font-weight:600; color:var(--accent-green);">${escapeHtml(matchingType.label)}</div>
              ${matchingType.description ? `<div style="font-size:13px; color:var(--text-secondary); margin-top:4px;">${escapeHtml(matchingType.description)}</div>` : ''}
            </div>
            ` : ''}
            
          </div>
          
          <div style="padding:16px 20px; border-top:1px solid var(--border-color); display:flex; gap:12px;">
            <button onclick="closeVGDecisionModal()" style="flex:1; padding:12px; background:var(--bg-elevated); border:1px solid var(--border-color); color:var(--text-secondary); border-radius:8px; cursor:pointer; font-size:14px;">Cancel</button>
            <button onclick="confirmVGDecision()" style="flex:1; padding:12px; background:var(--fwg-primary); border:none; color:white; border-radius:8px; cursor:pointer; font-size:14px; font-weight:500; ${!matchingType ? 'opacity:0.5; cursor:not-allowed;' : ''}" ${!matchingType ? 'disabled' : ''}>Add Line Item</button>
          </div>
          
        </div>
      </div>
    `;
    
    const existing = document.getElementById('vg-decision-modal');
    if (existing) existing.remove();
    document.body.insertAdjacentHTML('beforeend', modalHtml);
  }
  
  function setVGAnswer(field, value) {
    vgDecisionState[field] = value;
    if (field === 'plotterCut' && value === 'no') {
      vgDecisionState.transferTape = null;
    }
    renderVinylGraphicsDecisionModal();
  }
  
  function getMatchingVinylGraphicsType() {
    const state = vgDecisionState;
    const types = (quoteBuilderConfig.lineItemTypes || []).filter(t => t.category_key === 'VINYL_GRAPHICS' && t.active !== false && t.active !== 'FALSE');
    
    if (!state.airRelease || !state.plotterCut) return null;
    if (state.plotterCut === 'yes' && !state.transferTape) return null;
    
    // Match logic based on answers
    if (state.airRelease === 'yes' && state.plotterCut === 'yes' && state.transferTape === 'yes') {
      return types.find(t => t.type_key === 'CAST_LET_GRAPH');
    }
    if (state.airRelease === 'yes' && state.plotterCut === 'no') {
      return types.find(t => t.type_key === 'CAST_GRAPH_BULK');
    }
    if (state.airRelease === 'no' && state.plotterCut === 'yes' && state.transferTape === 'yes') {
      return types.find(t => t.type_key === 'CAL_LET_GRAPH');
    }
    if (state.airRelease === 'no' && state.plotterCut === 'no') {
      return types.find(t => t.type_key === 'VAN_INSERTS');
    }
    
    return null;
  }
  
  function closeVGDecisionModal(event) {
    if (event && event.target !== event.currentTarget) return;
    const modal = document.getElementById('vg-decision-modal');
    if (modal) modal.remove();
  }
  
  function skipVGDecision() {
    closeVGDecisionModal();
    const category = quoteBuilderConfig.categories.find(c => c.category_key === 'VINYL_GRAPHICS');
    openLineItemModal(vgDecisionState.groupId, category);
  }
  
  function confirmVGDecision() {
    const matchingType = getMatchingVinylGraphicsType();
    if (!matchingType) return;
    
    closeVGDecisionModal();
    
    // Create line item with type defaults
    const newItem = {
      group_id: vgDecisionState.groupId,
      category: 'VINYL_GRAPHICS',
      line_type: matchingType.type_key,
      type_key: matchingType.type_key,
      description: '',
      media_key: matchingType.default_media || '',
      lamination_key: matchingType.default_lamination || '',
      transfer_tape_key: matchingType.default_transfer_tape || '',
      sqft: 0,
      quantity: 1,
      rate: 0,
      unit_price: 0,
      line_total: 0,
      attachments: []
    };
    
    // Load materials and calculate rate
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.ok) {
          const materials = result.materials || [];
          const media = materials.find(m => m.material_key === newItem.media_key);
          const lam = materials.find(m => m.material_key === newItem.lamination_key);
          const tape = materials.find(m => m.material_key === newItem.transfer_tape_key);
          
          const mediaCost = media ? parseFloat(media.mark_up) || 0 : 0;
          const lamCost = lam ? parseFloat(lam.mark_up) || 0 : 0;
          const tapeCost = tape ? parseFloat(tape.mark_up) || 0 : 0;
          const laborCost = parseFloat(matchingType.labor_per_sqft) || 0;
          
          newItem.rate = mediaCost + lamCost + tapeCost + laborCost;
          newItem.unit_price = newItem.rate;
          newItem.media_label = media ? media.Material : '';
          newItem.lamination_label = lam ? lam.Material : '';
          newItem.transfer_tape_label = tape ? tape.Material : '';
          
          lineItems.push(newItem);
          renderLineItemGroups();
          recalculateTotals();
        }
      })
      .withFailureHandler(function(err) {
        console.error('Failed to load materials:', err);
        lineItems.push(newItem);
        renderLineItemGroups();
        recalculateTotals();
      })
      .getMaterialsForType(matchingType.type_key);
  }
  
  // ============================================================================
  // LINE ITEM CONFIGURATION MODAL
  // ============================================================================
  
  let lineItemModalState = {
    groupId: null,
    category: null,
    selectedType: null,
    selectedMedia: null,
    selectedLamination: null,
    selectedTransferTape: null,
    qualifierAnswer: null,
    materials: [],
    description: '',
    sqft: 0,
    width: 0,
    height: 0,
    qty: 1
  };

  
  
  function openLineItemModal(groupId, category) {
    // Get types for this category to auto-select first one
    const types = (quoteBuilderConfig.lineItemTypes || []).filter(t => t.category_key === category.category_key);
    const firstType = types.length > 0 ? types[0].type_key : null;
    
    lineItemModalState = {
      groupId: groupId,
      category: category,
      selectedType: firstType,
      selectedMedia: null,
      selectedLamination: null,
      selectedTransferTape: null,
      qualifierAnswer: null,
      materials: [],
      description: '',
      sqft: 0,
      width: 0,
      height: 0,
      qty: 1
    };
    
    // Load materials for this category
    loadMaterialsForCategory(category.category_key);
    
    document.getElementById('line-item-modal-title').textContent = 'Add ' + category.label + ' Line Item';
    renderLineItemModalBody();
    const overlay = document.getElementById('line-item-modal-overlay');
    overlay.style.display = 'flex';
    overlay.style.zIndex = '99999';
  }
  
  function closeLineItemModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('line-item-modal-overlay').style.display = 'none';
  }
  
  function loadMaterialsForCategory(categoryKey) {
    // Materials will be loaded via backend - for now use config
    // This would call getMaterialsForCategory(categoryKey) 
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.ok) {
          lineItemModalState.materials = result.materials;
          renderLineItemModalBody();
        }
      })
      .withFailureHandler(function(err) {
        console.error('Failed to load materials:', err);
      })
      .getMaterialsForCategory(categoryKey);
  }
  
  function renderLineItemModalBody() {
    const state = lineItemModalState;
    const category = state.category;
    
    // Get types for this category
    const types = (quoteBuilderConfig.lineItemTypes || []).filter(t => t.category_key === category.category_key);
    
    // Inline styles
    const labelStyle = 'display:block; font-size:13px; font-weight:500; color:var(--text-secondary, #94a3b8); margin-bottom:8px;';
    const inputStyle = 'width:100%; padding:10px 12px; background:var(--bg-dark, #282a30); border:1px solid var(--border-color, rgba(148,163,184,0.15)); border-radius:8px; color:var(--text-primary, #f1f5f9); font-size:14px; outline:none;';
    const selectStyle = inputStyle + ' cursor:pointer;';
    const groupStyle = 'margin-bottom:16px;';
    const rowStyle = 'display:flex; gap:12px;';
    
    let html = '';
    
    // Type Dropdown
    html += `
      <div style="${groupStyle}">
        <label style="${labelStyle}">Type *</label>
        <select style="${selectStyle}" id="lim-type" onchange="onLineItemTypeChange(this.value)">
          <option value="">-- Select Type --</option>
          ${types.map(t => `<option value="${t.type_key}" ${state.selectedType === t.type_key ? 'selected' : ''}>${escapeHtml(t.label)}</option>`).join('')}
        </select>
      </div>
    `;
    
    // If type selected, show additional fields
    if (state.selectedType) {
      const typeConfig = types.find(t => t.type_key === state.selectedType);
      
      // Show qualifier question if exists (e.g., "Requires Air Release?")
      if (typeConfig && typeConfig.qualifier_question) {
        const options = (typeConfig.qualifier_options || 'Yes|No').split('|');
        html += `
          <div style="display:flex; align-items:center; gap:12px; padding:12px 16px; background:var(--bg-elevated, #2a2a2a); border-radius:8px; margin-bottom:16px;">
            <span style="font-size:14px; color:var(--text-primary, #f1f5f9);">${escapeHtml(typeConfig.qualifier_question)}</span>
            <div style="display:flex; gap:8px; margin-left:auto;">
              ${options.map(opt => `
                <button type="button" onclick="onQualifierChange('${opt}')"
                  style="padding:6px 16px; border:1px solid ${state.qualifierAnswer === opt ? 'var(--fwg-primary, #d71cd1)' : 'var(--border-color, rgba(148,163,184,0.15))'}; border-radius:6px; background:${state.qualifierAnswer === opt ? 'var(--fwg-primary, #d71cd1)' : 'var(--bg-dark, #282a30)'}; color:${state.qualifierAnswer === opt ? 'white' : 'var(--text-secondary, #94a3b8)'}; cursor:pointer; font-size:13px;">
                  ${opt}
                </button>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      // Media Dropdown (if requires_media)
      if (typeConfig && (typeConfig.requires_media === true || typeConfig.requires_media === 'TRUE')) {
        let mediaOptions = (state.materials || []).filter(m => m.dropdown_field === 'media');
        console.log('All media before filter:', mediaOptions.map(m => ({ name: m.Material, subtype: m.material_subtype })));
        
        // Filter by material_subtype based on Air Release qualifier
        if (state.qualifierAnswer === 'Yes') {
          // Air Release = Yes  Cast only
          mediaOptions = mediaOptions.filter(m => m.material_subtype === 'CAST');
        } else if (state.qualifierAnswer === 'No') {
          // Air Release = No  Calendared only
          mediaOptions = mediaOptions.filter(m => m.material_subtype === 'CALENDARED');
        }
        html += `
          <div style="${groupStyle}">
            <label style="${labelStyle}">Media *</label>
            <select style="${selectStyle}" id="lim-media" onchange="onLineItemMediaChange(this.value)">
              <option value="">-- Select Media --</option>
              ${mediaOptions.map(m => `<option value="${m.material_key}" ${state.selectedMedia === m.material_key ? 'selected' : ''}>${escapeHtml(m.Material)} - $${Number(m.mark_up || 0).toFixed(2)}/sqft</option>`).join('')}
            </select>
          </div>
        `;
      }
      
      // Lamination Dropdown (if requires_lamination)
      if (typeConfig && (typeConfig.requires_lamination === true || typeConfig.requires_lamination === 'TRUE')) {
        let lamOptions = (state.materials || []).filter(m => m.dropdown_field === 'lamination');
        
        // Filter by material_subtype based on Air Release qualifier
        if (state.qualifierAnswer === 'Yes') {
          // Air Release = Yes  Cast only
          lamOptions = lamOptions.filter(m => m.material_subtype === 'CAST');
        } else if (state.qualifierAnswer === 'No') {
          // Air Release = No  Calendared only
          lamOptions = lamOptions.filter(m => m.material_subtype === 'CALENDARED');
        }
        html += `
          <div style="${groupStyle}">
            <label style="${labelStyle}">Lamination</label>
            <select style="${selectStyle}" id="lim-lamination" onchange="onLineItemLaminationChange(this.value)">
              <option value="">-- None --</option>
              ${lamOptions.map(m => `<option value="${m.material_key}" ${state.selectedLamination === m.material_key ? 'selected' : ''}>${escapeHtml(m.Material)} - $${Number(m.mark_up || 0).toFixed(2)}/sqft</option>`).join('')}
            </select>
          </div>
        `;
      }
      
      // Transfer Tape Dropdown (if type has default_transfer_tape)
      if (typeConfig && typeConfig.default_transfer_tape) {
        let tapeOptions = (state.materials || []).filter(m => m.dropdown_field === 'transfer_tape');
        
        // Filter by material_subtype based on Air Release qualifier
        if (state.qualifierAnswer === 'Yes') {
          tapeOptions = tapeOptions.filter(m => m.material_subtype === 'CAST');
        } else if (state.qualifierAnswer === 'No') {
          tapeOptions = tapeOptions.filter(m => m.material_subtype === 'CALENDARED');
        }
        html += `
          <div style="${groupStyle}">
            <label style="${labelStyle}">Transfer Tape</label>
            <select style="${selectStyle}" id="lim-transfer-tape" onchange="onLineItemTransferTapeChange(this.value)">
              <option value="">-- None --</option>
              ${tapeOptions.map(m => `<option value="${m.material_key}" ${state.selectedTransferTape === m.material_key ? 'selected' : ''}>${escapeHtml(m.Material)} - $${Number(m.mark_up || 0).toFixed(2)}/sqft</option>`).join('')}
            </select>
          </div>
        `;
      }
      
      // Description
      html += `
        <div style="${groupStyle}">
          <label style="${labelStyle}">Description *</label>
          <input type="text" style="${inputStyle}" id="lim-description" 
                 value="${escapeHtml(state.description)}" 
                 onchange="onLineItemFieldChange('description', this.value)"
                 placeholder="e.g., Driver side door lettering">
        </div>
      `;
      
      // Dimensions - Sq Ft and Qty in a row
      html += `
        <div style="${rowStyle}">
          <div style="flex:1;">
            <label style="${labelStyle}">Square Feet *</label>
            <input type="number" style="${inputStyle}" id="lim-sqft" 
                   value="${state.sqft || ''}" min="0" step="0.1"
                   oninput="onLineItemFieldChange('sqft', parseFloat(this.value) || 0)"
                   placeholder="0.00">
          </div>
          <div style="flex:0 0 100px;">
            <label style="${labelStyle}">Qty</label>
            <input type="number" style="${inputStyle}" id="lim-qty" 
                   value="${state.qty || 1}" min="1" step="1"
                   oninput="onLineItemFieldChange('qty', parseInt(this.value) || 1)">
          </div>
        </div>
      `;
      
      // Price Summary
      html += renderLineItemPriceSummary();
    }
    
    document.getElementById('line-item-modal-body').innerHTML = html;
  }
  
  function renderLineItemPriceSummary() {
    const state = lineItemModalState;
    const typeConfig = (quoteBuilderConfig.lineItemTypes || []).find(t => t.type_key === state.selectedType);
    
    // Get material costs
    const media = (state.materials || []).find(m => m.material_key === state.selectedMedia);
    const lam = (state.materials || []).find(m => m.material_key === state.selectedLamination);
    const tape = (state.materials || []).find(m => m.material_key === state.selectedTransferTape);
    
    const mediaCost = media ? parseFloat(media.mark_up) || 0 : 0;
    const lamCost = lam ? parseFloat(lam.mark_up) || 0 : 0;
    const tapeCost = tape ? parseFloat(tape.mark_up) || 0 : 0;
    const laborCost = typeConfig ? parseFloat(typeConfig.labor_per_sqft) || 0 : 0;
    
    const costPerSqft = mediaCost + lamCost + tapeCost + laborCost;
    const sqft = state.sqft || 0;
    const qty = state.qty || 1;
    const lineTotal = costPerSqft * sqft * qty;
    
    const rowStyle = 'display:flex; justify-content:space-between; align-items:center; padding:8px 0; font-size:14px;';
    const labelStyle = 'color:var(--text-secondary, #94a3b8);';
    const valueStyle = 'color:var(--text-primary, #f1f5f9); font-weight:500;';
    
    // Only show transfer tape row if type uses it
    const showTape = typeConfig && typeConfig.default_transfer_tape;
    
    return `
      <div id="line-item-price-summary" style="background:var(--bg-elevated, #2a2a2a); border:1px solid var(--border-color, rgba(148,163,184,0.15)); border-radius:8px; padding:16px; margin-top:20px;">
        <div style="${rowStyle}">
          <span style="${labelStyle}">Media</span>
          <span style="${valueStyle}">$${mediaCost.toFixed(2)}/sqft</span>
        </div>
        <div style="${rowStyle}">
          <span style="${labelStyle}">Lamination</span>
          <span style="${valueStyle}">$${lamCost.toFixed(2)}/sqft</span>
        </div>
        ${showTape ? `
        <div style="${rowStyle}">
          <span style="${labelStyle}">Transfer Tape</span>
          <span style="${valueStyle}">$${tapeCost.toFixed(2)}/sqft</span>
        </div>
        ` : ''}
        <div style="${rowStyle}">
          <span style="${labelStyle}">Labor</span>
          <span style="${valueStyle}">$${laborCost.toFixed(2)}/sqft</span>
        </div>
        <div style="${rowStyle} border-top:1px solid var(--border-color, rgba(148,163,184,0.15)); margin-top:8px; padding-top:12px;">
          <span style="${labelStyle}">Rate</span>
          <span style="${valueStyle}">$${costPerSqft.toFixed(2)}/sqft</span>
        </div>
        <div style="${rowStyle}">
          <span style="${labelStyle}">${sqft} sqft  ${qty} qty</span>
          <span style="${valueStyle}"></span>
        </div>
        <div style="${rowStyle} border-top:1px solid var(--border-color, rgba(148,163,184,0.15)); margin-top:8px; padding-top:12px;">
          <span style="color:var(--text-primary, #f1f5f9); font-weight:600; font-size:16px;">Line Total</span>
          <span style="color:var(--accent-green, #22c55e); font-weight:600; font-size:16px;">$${lineTotal.toFixed(2)}</span>
        </div>
      </div>
    `;
  }
  
  function onLineItemTypeChange(typeKey) {
    lineItemModalState.selectedType = typeKey;
    lineItemModalState.selectedMedia = null;
    lineItemModalState.selectedLamination = null;
    lineItemModalState.selectedTransferTape = null;
    lineItemModalState.qualifierAnswer = null;
    
    // Set defaults if available
    const typeConfig = (quoteBuilderConfig.lineItemTypes || []).find(t => t.type_key === typeKey);
    if (typeConfig) {
      // If there's no qualifier, use default_media directly
      if (!typeConfig.qualifier_question && typeConfig.default_media) {
        lineItemModalState.selectedMedia = typeConfig.default_media;
      }
      if (typeConfig.default_lamination) {
        lineItemModalState.selectedLamination = typeConfig.default_lamination;
      }
      if (typeConfig.default_transfer_tape) {
        lineItemModalState.selectedTransferTape = typeConfig.default_transfer_tape;
      }
    }
    
    // Reload materials filtered for this type
    if (typeKey) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.ok) {
            lineItemModalState.materials = result.materials;
            renderLineItemModalBody();
          }
        })
        .withFailureHandler(function(err) {
          console.error('Failed to load materials for type:', err);
          renderLineItemModalBody();
        })
        .getMaterialsForType(typeKey);
    } else {
      renderLineItemModalBody();
    }
  }
  
  function onQualifierChange(answer) {
    lineItemModalState.qualifierAnswer = answer;
    
    // Clear current selections when qualifier changes
    lineItemModalState.selectedMedia = null;
    lineItemModalState.selectedLamination = null;
    
    // Set default media based on qualifier answer
    const typeConfig = (quoteBuilderConfig.lineItemTypes || []).find(t => t.type_key === lineItemModalState.selectedType);
    if (typeConfig) {
      if (answer === 'Yes' && typeConfig.default_media_if_yes) {
        lineItemModalState.selectedMedia = typeConfig.default_media_if_yes;
      } else if (answer === 'No' && typeConfig.default_media_if_no) {
        lineItemModalState.selectedMedia = typeConfig.default_media_if_no;
      }
    }
    
    renderLineItemModalBody();
  }
  
  function onLineItemMediaChange(materialKey) {
    lineItemModalState.selectedMedia = materialKey;
    renderLineItemModalBody();
  }
  
  function onLineItemLaminationChange(materialKey) {
    lineItemModalState.selectedLamination = materialKey;
    renderLineItemModalBody();
  }
  
  function onLineItemTransferTapeChange(materialKey) {
    lineItemModalState.selectedTransferTape = materialKey;
    renderLineItemModalBody();
  }
  
  function onLineItemFieldChange(field, value) {
    lineItemModalState[field] = value;
    
    // Update just the price summary without full re-render (to preserve focus)
    const summaryHtml = renderLineItemPriceSummary();
    const existingSummary = document.getElementById('line-item-price-summary');
    if (existingSummary) {
      existingSummary.outerHTML = summaryHtml;
    }
  }
  
  function confirmLineItem() {
    const state = lineItemModalState;
    
    // Validation
    if (!state.selectedType) {
      alert('Please select a type');
      return;
    }
    if (!state.description) {
      alert('Please enter a description');
      return;
    }
    if (!state.sqft || state.sqft <= 0) {
      alert('Please enter square footage');
      return;
    }
    
    const typeConfig = (quoteBuilderConfig.lineItemTypes || []).find(t => t.type_key === state.selectedType);
    
    // Calculate price
    const media = (state.materials || []).find(m => m.material_key === state.selectedMedia);
    const lam = (state.materials || []).find(m => m.material_key === state.selectedLamination);
    const tape = (state.materials || []).find(m => m.material_key === state.selectedTransferTape);
    
    const mediaCost = media ? parseFloat(media.mark_up) || 0 : 0;
    const lamCost = lam ? parseFloat(lam.mark_up) || 0 : 0;
    const tapeCost = tape ? parseFloat(tape.mark_up) || 0 : 0;
    const laborCost = typeConfig ? parseFloat(typeConfig.labor_per_sqft) || 0 : 0;
    const rate = mediaCost + lamCost + tapeCost + laborCost;
    
    // Create line item
    const lineItem = {
      group_id: state.groupId,
      category: state.category.category_key,
      line_type: state.selectedType,
      type_key: state.selectedType,
      description: state.description,
      sqft: state.sqft,
      quantity: state.qty,
      rate: rate,
      unit_price: rate,
      line_total: rate * state.sqft * state.qty,
      media_key: state.selectedMedia,
      lamination_key: state.selectedLamination,
      transfer_tape_key: state.selectedTransferTape,
      media_label: media ? media.Material : '',
      lamination_label: lam ? lam.Material : '',
      transfer_tape_label: tape ? tape.Material : '',
      attachments: []
    };
    
    lineItems.push(lineItem);
    renderLineItemGroups();
    recalculateTotals();
    closeLineItemModal();
  }
  
  function updateRowTotal(index) {
    const item = lineItems[index];
    if (!item) return;
    
    const qty = Number(item.qty) || Number(item.sqft) || Number(item.hours) || Number(item.quantity) || 1;
    const price = Number(item.rate) || Number(item.unit_price) || 0;
    const total = qty * price;
    
    const row = document.querySelector(`tr[data-index="${index}"]`);
    if (row) {
      const totalCell = row.querySelector('.col-total');
      if (totalCell) {
        totalCell.textContent = '$' + formatMoney(total);
      }
    }
  }
  
  function updateGroupTotals() {
    lineItemGroups.forEach(group => {
      const groupItems = lineItems.filter(item => item.group_id === group.group_id);
      const groupTotal = groupItems.reduce((sum, item) => {
        const qty = Number(item.qty) || Number(item.sqft) || Number(item.hours) || Number(item.quantity) || 1;
        const price = Number(item.rate) || Number(item.unit_price) || 0;
        return sum + (qty * price);
      }, 0);
      
      const groupEl = document.querySelector(`[data-group-id="${group.group_id}"]`);
      if (groupEl) {
        const totalEl = groupEl.querySelector('.line-item-group-total');
        if (totalEl) {
          totalEl.textContent = '$' + formatMoney(groupTotal);
        }
        const countEl = groupEl.querySelector('.line-item-group-count');
        if (countEl) {
          countEl.textContent = groupItems.length + ' item' + (groupItems.length !== 1 ? 's' : '');
        }
      }
    });
  }
  
  function deleteLineItem(index) {
    if (confirm('Delete this line item?')) {
      lineItems.splice(index, 1);
      
      // Remove empty groups
      lineItemGroups = lineItemGroups.filter(group => 
        lineItems.some(item => item.group_id === group.group_id)
      );
      
      renderLineItemGroups();
      recalculateTotals();
    }
  }
  
  function deleteGroup(groupId) {
    const groupItems = lineItems.filter(item => item.group_id === groupId);
    if (!confirm(`Delete this section and all ${groupItems.length} item(s)?`)) return;
    
    lineItems = lineItems.filter(item => item.group_id !== groupId);
    lineItemGroups = lineItemGroups.filter(g => g.group_id !== groupId);
    
    renderLineItemGroups();
    recalculateTotals();
  }
  
  function openSectionModal() {
    const categories = quoteBuilderConfig.categories || [];
    
    if (categories.length === 0) {
      addSection('OTHER');
      return;
    }
    
    // Group categories by parent
    const grouped = { AUTOMOTIVE: [], SIGNAGE: [], APPAREL: [], OTHER: [] };
    categories.forEach(cat => {
      const parent = cat.parent_category || 'OTHER';
      if (grouped[parent]) {
        grouped[parent].push(cat);
      } else {
        grouped.OTHER.push(cat);
      }
    });
    
    // Sort each group by sort_order
    Object.keys(grouped).forEach(key => {
      grouped[key].sort((a, b) => (a.sort_order || 99) - (b.sort_order || 99));
    });
    
    const modalHtml = `
      <div class="modal-backdrop" onclick="closeSectionModal()">
        <div class="modal" style="max-width: 500px;" onclick="event.stopPropagation()">
          <div class="modal-header">
            <div class="modal-title">Add Section</div>
            <button class="modal-close" onclick="closeSectionModal()">&times;</button>
          </div>
          <div class="modal-body" style="padding-top: 0;">
            <div class="section-modal-tabs">
              <button class="section-modal-tab active" onclick="switchSectionTab('AUTOMOTIVE', this)">Automotive</button>
              <button class="section-modal-tab" onclick="switchSectionTab('SIGNAGE', this)">Signage</button>
              <button class="section-modal-tab" onclick="switchSectionTab('APPAREL', this)">Apparel</button>
            </div>
            <div class="section-modal-grid" id="section-category-grid">
            </div>
          </div>
        </div>
      </div>
    `;
    
    const existing = document.querySelector('.modal-backdrop');
    if (existing) existing.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Store grouped data for tab switching
    window.sectionCategoriesGrouped = grouped;
    
    // Show first tab with categories
    switchSectionTab('AUTOMOTIVE', document.querySelector('.section-modal-tab.active'));
  }
  
  function switchSectionTab(parentKey, tabEl) {
    // Update active tab
    document.querySelectorAll('.section-modal-tab').forEach(t => t.classList.remove('active'));
    tabEl.classList.add('active');
    
    // Get categories for this parent
    const categories = window.sectionCategoriesGrouped[parentKey] || [];
    
    const grid = document.getElementById('section-category-grid');
    
    if (categories.length === 0) {
      grid.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No categories in this group</div>';
      return;
    }
    
    grid.innerHTML = categories.map(cat => `
      <div class="section-option" onclick="addSection('${cat.category_key}')">
        <div class="section-option-color" style="background: ${cat.calendar_color || '#6b7280'};"></div>
        <div class="section-option-label">${escapeHtml(cat.label || cat.category_key)}</div>
      </div>
    `).join('');
  }
  
  function closeSectionModal() {
    const modal = document.querySelector('.modal-backdrop');
    if (modal) modal.remove();
  }
  
  function addSection(categoryKey) {
    closeSectionModal();
    
    const groupId = 'grp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
    lineItemGroups.push({ group_id: groupId, category_key: categoryKey });
    
    const category = quoteBuilderConfig.categories.find(c => c.category_key === categoryKey);
    
    // Special handling for VINYL_GRAPHICS - use decision tree
    if (categoryKey === 'VINYL_GRAPHICS') {
      renderLineItemGroups();
      openVinylGraphicsDecisionModal(groupId);
      return;
    }
    
    // If category has types, open the line item modal directly
    if (category && (String(category.has_types).toUpperCase() === 'TRUE' || category.has_types === true)) {
      renderLineItemGroups();
      openLineItemModal(groupId, category);
    } else {
      // No types - add simple line item directly
      lineItems.push({
        group_id: groupId,
        category: categoryKey,
        description: '',
        quantity: 1,
        unit_price: category?.default_rate || 0,
        attachments: []
      });
      renderLineItemGroups();
      recalculateTotals();
    }
  }
  
  async function handleLineItemAttachment(lineIndex, lineItemId, event) {
    const files = event.target.files;
    if (!files || files.length === 0) return;
    
    const docId = currentDocument.doc_id || 'new';
    
    for (const file of files) {
      try {
        showToast('Uploading ' + file.name + '...', 'info');
        const result = await uploadToR2(file, 'doc-line-item', docId, lineIndex);
        
        if (result.ok) {
          if (!lineItems[lineIndex].attachments) {
            lineItems[lineIndex].attachments = [];
          }
          lineItems[lineIndex].attachments.push({
            file_id: result.file_id,
            name: file.name,
            url: result.url,
            size: file.size,
            type: file.type
          });
          showToast('Uploaded: ' + file.name, 'success');
        } else {
          showToast('Upload failed: ' + result.error, 'error');
        }
      } catch (error) {
        showToast('Upload error: ' + error.message, 'error');
      }
    }
    
    renderLineItems();
  }
  
  async function deleteAttachment(lineIndex, fileId) {
    if (!confirm('Delete this attachment?')) return;
    
    const atts = lineItems[lineIndex].attachments || [];
    const attIndex = atts.findIndex(a => (a.file_id || '') === fileId || atts.indexOf(a) === Number(fileId));
    
    if (attIndex > -1) {
      const att = atts[attIndex];
      
      // Delete from R2 if has file_id
      if (att.file_id) {
        try {
          await fetch(R2_WORKER_URL + '/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ file_id: att.file_id })
          });
        } catch (e) {
          console.log('R2 delete error:', e);
        }
      }
      
      atts.splice(attIndex, 1);
      lineItems[lineIndex].attachments = atts;
      renderLineItems();
      showToast('Attachment deleted', 'success');
    }
  }
  
  // ========================================================================
  // PROJECT FILES
  // ========================================================================
  function renderProjectFiles() {
    const container = document.getElementById('project-files-container');
    let html = '';
    
    projectFiles.forEach((file, index) => {
      const isImage = /\.(jpg|jpeg|png|gif|webp|svg)$/i.test(file.name || file.filename || '');
      const url = file.url || file.file_url || '';
      const name = file.name || file.filename || 'File';
      
      html += `
        <div class="project-file" onclick="openLightbox('${url}', '${escapeHtml(name)}')">
          ${isImage ? `<img src="${url}" alt="${escapeHtml(name)}">` : `
            <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--text-muted);">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="32" height="32"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
            </div>
          `}
          <div class="project-file-info">${escapeHtml(name)}</div>
          <button class="project-file-delete" onclick="event.stopPropagation(); deleteProjectFile('${file.file_id || index}')">&times;</button>
        </div>
      `;
    });
    
    // Add button (always at end)
    html += `
      <label class="project-file-add">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        <span>Add File</span>
        <input type="file" multiple accept=".jpg,.jpeg,.png,.svg,.pdf,.ai,.eps" onchange="handleProjectFileUpload(event)">
      </label>
    `;
    
    container.innerHTML = html;
  }
  
  async function handleProjectFileUpload(event) {
    const files = event.target.files;
    if (!files || files.length === 0) return;
    
    const docId = currentDocument.doc_id || 'new';
    
    for (const file of files) {
      try {
        showToast('Uploading ' + file.name + '...', 'info');
        const result = await uploadToR2(file, 'doc-project', docId, null);
        
        if (result.ok) {
          projectFiles.push({
            file_id: result.file_id,
            name: file.name,
            url: result.url,
            size: file.size,
            type: file.type
          });
          showToast('Uploaded: ' + file.name, 'success');
        } else {
          showToast('Upload failed: ' + result.error, 'error');
        }
      } catch (error) {
        showToast('Upload error: ' + error.message, 'error');
      }
    }
    
    renderProjectFiles();
  }
  
  async function deleteProjectFile(fileId) {
    if (!confirm('Delete this file?')) return;
    
    const index = projectFiles.findIndex(f => (f.file_id || '') === fileId || projectFiles.indexOf(f) === Number(fileId));
    
    if (index > -1) {
      projectFiles.splice(index, 1);
      renderProjectFiles();
      showToast('File deleted (remember to Save)', 'success');
    }
  }
  
  async function uploadToR2(file, pathPrefix, docId, lineIndex) {
    const timestamp = Date.now();
    const random = Math.random().toString(36).substring(2, 8);
    const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
    
    let path;
    if (lineIndex !== null) {
      path = `${pathPrefix}/${docId}-${lineIndex}/${timestamp}-${random}-${safeName}`;
    } else {
      path = `${pathPrefix}/${docId}/${timestamp}-${random}-${safeName}`;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('path', path);
    
    const response = await fetch(R2_WORKER_URL + '/upload', {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (result.success) {
      return {
        ok: true,
        file_id: result.key,
        url: result.url
      };
    } else {
      return { ok: false, error: result.error || 'Upload failed' };
    }
  }
  
  // ========================================================================
  // PAYMENTS (Invoice Only)
  // ========================================================================
  function renderPayments() {
    const container = document.getElementById('payments-list');
    const payments = currentDocument.payments || [];
    
    if (payments.length === 0) {
      container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);">No payments recorded</div>';
      return;
    }
    
    let html = '';
    payments.forEach(p => {
      html += `
        <div class="payment-item">
          <div class="payment-info">
            <div class="payment-amount">$${Number(p.amount).toLocaleString()}</div>
            <div class="payment-meta">${p.method || 'Payment'}  ${formatDate(p.paid_at || p.date)}</div>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = html;
  }
  
  function recordPayment() {
    const amount = Number(document.getElementById('payment-amount').value);
    const method = document.getElementById('payment-method').value;
    
    if (!amount || amount <= 0) {
      showToast('Please enter a valid amount', 'error');
      return;
    }
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.ok) {
          showToast('Payment recorded!', 'success');
          document.getElementById('payment-amount').value = '';
          loadDocument(currentDocument.doc_id);
        } else {
          showToast('Error: ' + result.error, 'error');
        }
      })
      .withFailureHandler(function(error) {
        showToast('Error: ' + error, 'error');
      })
      .addDocumentPayment(currentDocument.doc_id, { amount: amount, method: method });
  }

  // ============================================================================
  // DISCOUNT FUNCTIONS
  // ============================================================================
  
  function onDiscountTypeChange() {
    const type = document.getElementById('discount_type').value;
    const valueInput = document.getElementById('discount_value');
    
    if (type === 'flat' || type === 'custom%') {
      valueInput.style.display = 'block';
      valueInput.placeholder = type === 'flat' ? 'Amount' : 'Percent';
      valueInput.value = '';
      valueInput.focus();
    } else {
      valueInput.style.display = 'none';
    }
    
    calculateDiscount();
  }
  
  function calculateDiscount() {
    const type = document.getElementById('discount_type').value;
    const valueInput = document.getElementById('discount_value');
    const discountAmountInput = document.getElementById('discount_amount');
    const discountDisplay = document.getElementById('discount_display');
    
    // Calculate subtotal for percentage discounts
    const subtotal = lineItems.reduce((sum, item) => {
      const qty = Number(item.qty) || Number(item.sqft) || Number(item.hours) || Number(item.quantity) || 1;
      const price = Number(item.rate) || Number(item.unit_price) || 0;
      return sum + (qty * price);
    }, 0);
    
    let discountAmount = 0;
    
    if (type === 'none') {
      discountAmount = 0;
    } else if (type === 'flat') {
      discountAmount = Number(valueInput.value) || 0;
    } else if (type === 'custom%') {
      const percent = Number(valueInput.value) || 0;
      discountAmount = (subtotal * percent) / 100;
    } else if (type.endsWith('%')) {
      const percent = parseInt(type);
      discountAmount = (subtotal * percent) / 100;
    }
    
    discountAmountInput.value = discountAmount.toFixed(2);
    discountDisplay.textContent = '-' + formatCurrency(discountAmount);
    
    recalculateTotals();
  }
  
  function setDiscountFromDocument(discountAmount, subtotal) {
    const discountInput = document.getElementById('discount_amount');
    const discountType = document.getElementById('discount_type');
    const discountValue = document.getElementById('discount_value');
    const discountDisplay = document.getElementById('discount_display');
    
    discountInput.value = discountAmount;
    
    if (discountAmount === 0) {
      discountType.value = 'none';
      discountValue.style.display = 'none';
    } else if (subtotal > 0) {
      // Try to detect if it matches a preset percentage
      const percent = (discountAmount / subtotal) * 100;
      const roundedPercent = Math.round(percent);
      
      if ([5, 10, 15, 20, 25].includes(roundedPercent) && Math.abs(percent - roundedPercent) < 0.5) {
        discountType.value = roundedPercent + '%';
        discountValue.style.display = 'none';
      } else {
        discountType.value = 'flat';
        discountValue.value = discountAmount;
        discountValue.style.display = 'block';
      }
    } else {
      discountType.value = 'flat';
      discountValue.value = discountAmount;
      discountValue.style.display = 'block';
    }
    
    discountDisplay.textContent = '-' + formatCurrency(discountAmount);
  }
  
  // ========================================================================
  // TOTALS
  // ========================================================================
  function recalculateTotals() {
    const subtotal = lineItems.reduce((sum, item) => {
      const qty = Number(item.qty) || Number(item.sqft) || Number(item.hours) || Number(item.quantity) || 1;
      const price = Number(item.rate) || Number(item.unit_price) || 0;
      return sum + (qty * price);
    }, 0);
    
    const discount = Number(document.getElementById('discount_amount').value) || 0;
    const tax = Number(document.getElementById('tax_amount').value) || 0;
    const feesTotal = getFeesTotal();
    const total = subtotal + feesTotal - discount + tax;
    const amountPaid = Number(currentDocument.amount_paid) || 0;
    const balanceDue = total - amountPaid;
    
    document.getElementById('subtotal-display').textContent = formatCurrency(subtotal);
    document.getElementById('total-display').textContent = formatCurrency(total);
    document.getElementById('amount-paid-display').textContent = formatCurrency(amountPaid);
    document.getElementById('balance-due-display').textContent = formatCurrency(balanceDue);
  }
  
  // ========================================================================
  // ACTIONS
  // ========================================================================
  function renderActions() {
    const container = document.getElementById('doc-actions');
    const doc = currentDocument;
    const isQuote = doc.doc_type === 'quote';
    const isInvoice = doc.doc_type === 'invoice';
    const isArchived = doc.bucket === 'ARCHIVE_WON' || doc.bucket === 'ARCHIVE_LOST';
    const hasBeenSent = doc.sent_at || doc.status === 'Sent' || doc.status === 'Viewed';
    
    let html = '';
    
    // Copy customer link
    html += `
      <button class="btn btn-secondary btn-sm" onclick="copyCustomerLink()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
        Copy Link
      </button>
    `;
    
    // Status-specific actions
    if (isQuote) {
      // Always show Send button for quotes (except declined/expired/archived)
      if (doc.status !== 'Declined' && doc.status !== 'Expired' && !isArchived) {
        html += `
          <button class="btn btn-secondary btn-sm" onclick="sendDocument()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            Send
          </button>
        `;
      }
      
      // Follow-Up button if already sent and not archived
      if (hasBeenSent && !isArchived && doc.status !== 'Approved' && doc.status !== 'Declined' && doc.status !== 'Expired') {
        html += `
          <button class="btn btn-secondary btn-sm" onclick="openFollowUpModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
            Follow Up${doc.followup_count ? ' (' + doc.followup_count + ')' : ''}
          </button>
        `;
      }
      
      // Always allow convert to invoice for quotes (except declined/expired/archived)
      if (doc.status !== 'Declined' && doc.status !== 'Expired' && !isArchived) {
        html += `
          <button class="btn btn-success btn-sm" onclick="convertToInvoice()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>
            Convert to Invoice
          </button>
        `;
      }
    }
    
    if (isInvoice) {
      // Always show Send button for invoices (except void/paid/archived)
      if (doc.status !== 'Void' && doc.status !== 'Paid' && !isArchived) {
        html += `
          <button class="btn btn-secondary btn-sm" onclick="sendDocument()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            Send
          </button>
        `;
      }
      
      // Follow-Up button if sent but not paid/archived
      if (hasBeenSent && !isArchived && doc.status !== 'Paid' && doc.status !== 'Void') {
        html += `
          <button class="btn btn-secondary btn-sm" onclick="openFollowUpModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
            Follow Up${doc.followup_count ? ' (' + doc.followup_count + ')' : ''}
          </button>
        `;
      }
      
      if (!isArchived) {
        html += `
          <button class="btn btn-primary btn-sm" onclick="openScheduleModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            Schedule It
          </button>
        `;
      }
    }
    
    // Move to Cold button (for non-archived, sent docs that aren't already cold)
    const isCold = doc.bucket === 'COLD';
    if (!isArchived && !isCold && hasBeenSent) {
      html += `
        <button class="btn btn-secondary btn-sm" onclick="moveToCold()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12h4m12 0h4M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/><circle cx="12" cy="12" r="4"/></svg>
          Move to Cold
        </button>
      `;
    }
    
    // Move to Production button (for invoices not already in production)
    const inProduction = doc.in_production === true || doc.in_production === 'TRUE' || doc.bucket === 'IN_PRODUCTION';
    if (isInvoice && !isArchived && !inProduction) {
      html += `
        <button class="btn btn-primary btn-sm" onclick="moveToProduction()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"></path><circle cx="12" cy="12" r="3"></circle></svg>
          Move to Production
        </button>
      `;
    }
    
    // Archive button (for non-archived docs)
    if (!isArchived) {
      html += `
        <button class="btn btn-secondary btn-sm" onclick="openArchiveModal()" style="margin-left:auto;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line></svg>
          Archive
        </button>
      `;
    } else {
      // Unarchive button
      html += `
        <button class="btn btn-secondary btn-sm" onclick="unarchiveDocument()" style="margin-left:auto;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>
          Unarchive
        </button>
      `;
    }
    
    container.innerHTML = html;
  }
  
  function updateStatus(newStatus) {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.ok) {
          showToast('Status updated to ' + newStatus, 'success');
          loadDocument(currentDocument.doc_id);
        } else {
          showToast('Error: ' + result.error, 'error');
        }
      })
      .withFailureHandler(function(error) {
        showToast('Error: ' + error, 'error');
      })
      .updateDocumentStatus(currentDocument.doc_id, newStatus);
  }
  
  function sendDocument() {
    console.log('sendDocument called');
    const doc = currentDocument;
    console.log('currentDocument:', doc);
    const hasPhone = doc.customer_phone && String(doc.customer_phone).replace(/\D/g, '').length >= 10;
    const hasEmail = doc.customer_email && doc.customer_email.includes('@');
    console.log('hasPhone:', hasPhone, 'hasEmail:', hasEmail);
    
    if (!hasPhone && !hasEmail) {
      showToast('No phone or email on file. Add contact info first.', 'error');
      return;
    }
    
    console.log('Opening send modal...');
    openSendModal();
  }
  
  function openSendModal() {
    const doc = currentDocument;
    const isQuote = doc.doc_type === 'quote';
    const hasPhone = doc.customer_phone && String(doc.customer_phone).replace(/\D/g, '').length >= 10;
    const hasEmail = doc.customer_email && doc.customer_email.includes('@');
    const total = Number(doc.total) || 0;
    
    let lineAttachmentCount = 0;
    (doc.line_items || []).forEach(item => {
      try {
        const attachments = item.attachments_json ? 
          (typeof item.attachments_json === 'string' ? JSON.parse(item.attachments_json) : item.attachments_json) : [];
        if (Array.isArray(attachments)) lineAttachmentCount += attachments.length;
      } catch(e) {}
    });
    const projectAttachmentCount = (doc.project_files || []).length;
    
    const modalHtml = `
      <div class="modal-backdrop" onclick="closeSendModal()">
        <div class="modal" style="max-width:520px;" onclick="event.stopPropagation()">
          <div class="modal-header">
            <div class="modal-title">Send ${isQuote ? 'Quote' : 'Invoice'}</div>
            <button class="modal-close" onclick="closeSendModal()">&times;</button>
          </div>
          <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
            
            <div style="margin-bottom:20px;">
              <div style="font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:10px;">Delivery Method</div>
              <label style="display:flex;align-items:center;gap:10px;padding:12px;background:var(--bg-elevated);border-radius:var(--radius-sm);margin-bottom:8px;cursor:${hasPhone ? 'pointer' : 'not-allowed'};opacity:${hasPhone ? '1' : '0.5'};">
                <input type="checkbox" id="send-sms" ${hasPhone ? 'checked' : 'disabled'}>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                <span style="flex:1;">SMS</span>
                <span style="font-size:12px;color:var(--text-muted);">${hasPhone ? doc.customer_phone : 'No phone'}</span>
              </label>
              <label style="display:flex;align-items:center;gap:10px;padding:12px;background:var(--bg-elevated);border-radius:var(--radius-sm);cursor:${hasEmail ? 'pointer' : 'not-allowed'};opacity:${hasEmail ? '1' : '0.5'};">
                <input type="checkbox" id="send-email" ${hasEmail ? 'checked' : 'disabled'}>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                <span style="flex:1;">Email</span>
                <span style="font-size:12px;color:var(--text-muted);">${hasEmail ? doc.customer_email : 'No email'}</span>
              </label>
            </div>
            
            ${isQuote ? `
            <div style="margin-bottom:20px;">
              <div style="font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:10px;">Requesting Approval For</div>
              <label style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg-elevated);border-radius:var(--radius-sm);margin-bottom:6px;cursor:pointer;">
                <input type="radio" name="approval-type" value="design">
                <span>Design Approval</span>
              </label>
              <label style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg-elevated);border-radius:var(--radius-sm);margin-bottom:6px;cursor:pointer;">
                <input type="radio" name="approval-type" value="price">
                <span>Quote/Price Approval</span>
              </label>
              <label style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg-elevated);border-radius:var(--radius-sm);margin-bottom:6px;cursor:pointer;">
                <input type="radio" name="approval-type" value="both" checked>
                <span>Both Design & Price</span>
              </label>
              <label style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg-elevated);border-radius:var(--radius-sm);cursor:pointer;">
                <input type="radio" name="approval-type" value="custom">
                <span>Custom</span>
              </label>
              <input type="text" id="custom-approval-text" placeholder="Enter custom approval request..." style="display:none;margin-top:8px;width:100%;padding:10px;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-primary);">
            </div>
            ` : ''}
            
            <div style="margin-bottom:20px;">
              <div style="font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:10px;">Attachments to Include</div>
              <label style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg-elevated);border-radius:var(--radius-sm);margin-bottom:6px;cursor:pointer;">
                <input type="checkbox" id="include-line-attachments" ${lineAttachmentCount > 0 ? 'checked' : ''}>
                <span style="flex:1;">Line Item Attachments</span>
                <span style="font-size:12px;color:var(--text-muted);">${lineAttachmentCount > 0 ? '(' + lineAttachmentCount + ' files)' : '(none)'}</span>
              </label>
              <label style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg-elevated);border-radius:var(--radius-sm);cursor:pointer;">
                <input type="checkbox" id="include-project-attachments">
                <span style="flex:1;">Project Level Attachments</span>
                <span style="font-size:12px;color:var(--text-muted);">${projectAttachmentCount > 0 ? '(' + projectAttachmentCount + ' files)' : '(none)'}</span>
              </label>
            </div>
            
            <div style="margin-bottom:20px;">
              <div style="font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:10px;">Payment Terms</div>
              <label style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg-elevated);border-radius:var(--radius-sm);margin-bottom:6px;cursor:pointer;">
                <input type="radio" name="payment-terms" value="deposit_50" checked>
                <span style="flex:1;">50% Deposit Required</span>
                <span style="font-size:12px;color:var(--text-muted);">$${(total * 0.5).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</span>
              </label>
              <label style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg-elevated);border-radius:var(--radius-sm);margin-bottom:6px;cursor:pointer;">
                <input type="radio" name="payment-terms" value="full">
                <span style="flex:1;">Pay in Full</span>
                <span style="font-size:12px;color:var(--text-muted);">$${total.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</span>
              </label>
              <label style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg-elevated);border-radius:var(--radius-sm);cursor:pointer;">
                <input type="radio" name="payment-terms" value="custom">
                <span>Custom Amount</span>
              </label>
              <div id="custom-amount-row" style="display:none;margin-top:8px;">
                <span style="color:var(--text-muted);">$</span>
                <input type="number" id="custom-payment-amount" placeholder="0.00" style="width:120px;padding:8px;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-primary);">
              </div>
            </div>
            
            <div>
              <div style="font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:4px;">Customer Confirmation Preference</div>
              <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px;">How should the customer receive payment confirmations?</div>
              <div style="display:flex;gap:8px;">
                <label style="display:flex;align-items:center;gap:6px;padding:10px 16px;background:var(--bg-elevated);border-radius:var(--radius-sm);cursor:pointer;">
                  <input type="radio" name="notification-pref" value="sms" checked>
                  <span>SMS</span>
                </label>
                <label style="display:flex;align-items:center;gap:6px;padding:10px 16px;background:var(--bg-elevated);border-radius:var(--radius-sm);cursor:pointer;">
                  <input type="radio" name="notification-pref" value="email">
                  <span>Email</span>
                </label>
                <label style="display:flex;align-items:center;gap:6px;padding:10px 16px;background:var(--bg-elevated);border-radius:var(--radius-sm);cursor:pointer;">
                  <input type="radio" name="notification-pref" value="both">
                  <span>Both</span>
                </label>
              </div>
            </div>
            
          </div>
          <div class="modal-footer" style="display:flex;justify-content:flex-end;gap:12px;padding:16px 20px;border-top:1px solid var(--border-color);">
            <button type="button" class="btn btn-secondary" onclick="closeSendModal()">Cancel</button>
            <button type="button" class="btn btn-primary" id="btn-confirm-send" onclick="confirmSendDocument()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
              Send
            </button>
          </div>
        </div>
      </div>
    `;
    
    document.getElementById('send-modal-container').innerHTML = modalHtml;
    
    if (isQuote) {
      document.querySelectorAll('input[name="approval-type"]').forEach(radio => {
        radio.onchange = function() {
          document.getElementById('custom-approval-text').style.display = this.value === 'custom' ? 'block' : 'none';
        };
      });
    }
    
    document.querySelectorAll('input[name="payment-terms"]').forEach(radio => {
      radio.onchange = function() {
        document.getElementById('custom-amount-row').style.display = this.value === 'custom' ? 'block' : 'none';
      };
    });
  }
  
  function closeSendModal() {
    document.getElementById('send-modal-container').innerHTML = '';
  }
  
  function confirmSendDocument() {
    const doc = currentDocument;
    const isQuote = doc.doc_type === 'quote';
    const sendSms = document.getElementById('send-sms').checked;
    const sendEmail = document.getElementById('send-email').checked;
    
    if (!sendSms && !sendEmail) {
      showToast('Select at least one delivery method', 'error');
      return;
    }
    
    // Gather all options
    const approvalType = isQuote ? (document.querySelector('input[name="approval-type"]:checked')?.value || 'both') : null;
    const customApprovalTextEl = document.getElementById('custom-approval-text');
    const customApprovalText = customApprovalTextEl ? customApprovalTextEl.value.trim() : '';
    const includeLineAttachments = document.getElementById('include-line-attachments').checked;
    const includeProjectAttachments = document.getElementById('include-project-attachments').checked;
    const paymentTerms = document.querySelector('input[name="payment-terms"]:checked')?.value || 'deposit_50';
    const customPaymentAmountEl = document.getElementById('custom-payment-amount');
    const customPaymentAmount = customPaymentAmountEl ? (parseFloat(customPaymentAmountEl.value) || 0) : 0;
    const notificationPref = document.querySelector('input[name="notification-pref"]:checked')?.value || 'sms';
    
    const options = {
      sms: sendSms,
      email: sendEmail,
      approvalType: doc.doc_type === 'quote' ? approvalType : null,
      customApprovalText: approvalType === 'custom' ? customApprovalText : null,
      includeLineAttachments: includeLineAttachments,
      includeProjectAttachments: includeProjectAttachments,
      paymentTerms: paymentTerms,
      customPaymentAmount: paymentTerms === 'custom' ? customPaymentAmount : null,
      customerNotificationPref: notificationPref
    };
    
    // Update button state
    const btn = document.getElementById('btn-confirm-send');
    btn.disabled = true;
    btn.innerHTML = '<span class="btn-loading"></span> Sending...';
    
    google.script.run
      .withSuccessHandler(function(result) {
        btn.disabled = false;
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg> Send Document';
        
        if (result.ok) {
          closeSendModal();
          showToast(result.message || 'Document sent!', 'success');
          loadDocument(currentDocument.doc_id);
        } else {
          showToast('Error: ' + result.error, 'error');
        }
      })
      .withFailureHandler(function(error) {
        btn.disabled = false;
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg> Send Document';
        showToast('Error: ' + error, 'error');
      })
      .sendDocumentNotification(currentDocument.doc_id, options);
  }

  function moveToProduction() {
    if (!confirm('Move this invoice to Production? This will generate production tasks based on line item categories.')) {
      return;
    }
    
    showToast('Generating production tasks...', 'info');
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result && result.ok) {
          showToast('Moved to Production! ' + result.tasks_created + ' tasks created.', 'success');
          currentDocument.in_production = true;
          currentDocument.bucket = 'IN_PRODUCTION';
          renderActions();
        } else {
          showToast(result?.error || 'Failed to move to production', 'error');
        }
      })
      .withFailureHandler(function(error) {
        showToast('Error: ' + error, 'error');
      })
      .generateProductionTasks(currentDocument.doc_id);
  }

  function moveToCold() {
    if (!confirm('Move this ' + currentDocument.doc_type + ' to Cold?')) {
      return;
    }
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result && result.ok) {
          showToast('Moved to Cold', 'success');
          currentDocument.bucket = 'COLD';
          goBack();
        } else {
          showToast(result?.error || 'Failed to move to cold', 'error');
        }
      })
      .withFailureHandler(function(error) {
        showToast('Error: ' + error, 'error');
      })
      .updateDocumentBucket(currentDocument.doc_id, 'COLD');
  }
  
  function convertToInvoice() {
    if (confirm('Convert this quote to an invoice? This cannot be undone.')) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.ok) {
            showToast('Converted to Invoice!', 'success');
            loadDocument(currentDocument.doc_id);
          } else {
            showToast('Error: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showToast('Error: ' + error, 'error');
        })
        .convertToInvoice(currentDocument.doc_id);
    }
  }
  
  function copyCustomerLink() {
    google.script.run
      .withSuccessHandler(function(baseUrl) {
        const link = baseUrl + '?page=customer_document&id=' + currentDocument.doc_id;
        navigator.clipboard.writeText(link).then(() => {
          showToast('Link copied to clipboard!', 'success');
        }).catch(() => {
          prompt('Copy this link:', link);
        });
      })
      .withFailureHandler(function() {
        // Fallback
        const link = window.location.origin + window.location.pathname + '?page=customer_document&id=' + currentDocument.doc_id;
        navigator.clipboard.writeText(link).then(() => {
          showToast('Link copied!', 'success');
        }).catch(() => {
          prompt('Copy this link:', link);
        });
      })
      .getWebAppUrl();
  }
  
  // ========================================================================
  // SAVE
  // ========================================================================
  function saveDocument() {
    const btn = document.getElementById('btn-save');
    btn.innerHTML = '<span class="btn-loading"></span>';
    btn.disabled = true;
    
    // Gather data
    const docData = {
      doc_id: currentDocument.doc_id,
      doc_type: currentDocument.doc_type || 'quote',
      customer_name: document.getElementById('customer_name').value,
      company_name: document.getElementById('company_name').value,
      customer_email: document.getElementById('customer_email').value,
      customer_phone: document.getElementById('customer_phone').value,
      vehicle_description: document.getElementById('vehicle_description').value,
      project_description: document.getElementById('project_description').value,
      notes: document.getElementById('notes').value,
      discount_amount: Number(document.getElementById('discount_amount').value) || 0,
      tax_amount: Number(document.getElementById('tax_amount').value) || 0,
      deposit_required: Number(document.getElementById('deposit_required').value) || 0,
      line_items: lineItems.map(item => {
        const qty = Number(item.qty) || Number(item.sqft) || Number(item.hours) || Number(item.quantity) || 1;
        const price = Number(item.rate) || Number(item.unit_price) || 0;
        
        return {
          line_id: item.line_id || '',
          description: item.description || '',
          category: item.category || 'OTHER',
          quantity: qty,
          unit_price: price,
          line_total: qty * price,
          attachments_json: JSON.stringify(item.attachments || []),
          custom_fields_json: JSON.stringify({
            group_id: item.group_id,
            qty: item.qty,
            sqft: item.sqft,
            rate: item.rate,
            hours: item.hours,
            material: item.material,
            coverage: item.coverage,
            package_key: item.package_key,
            line_type: item.line_type,
            size: item.size,
            color: item.color,
            item_type: item.item_type,
            dimensions: item.dimensions,
            thread_colors: item.thread_colors,
            stitch_count: item.stitch_count
          })
        };
      }),
      project_files_json: JSON.stringify(projectFiles),
      fees: documentFees
    };
    
    // Calculate totals
    docData.subtotal = docData.line_items.reduce((sum, item) => sum + item.line_total, 0);
    docData.total = docData.subtotal - docData.discount_amount + docData.tax_amount;
    
    // Auto-default deposit to 50% of total if not manually set or if it's still at old default
    const currentDeposit = Number(document.getElementById('deposit_required').value) || 0;
    const oldTotal = Number(currentDocument.total) || 0;
    const oldDefault = Math.round(oldTotal * 50) / 100; // 50% of old total
    
    // If deposit is 0, or matches the old 50% default (meaning user hasn't manually changed it)
    if (currentDeposit === 0 || currentDeposit === oldDefault || currentDeposit === Math.round(oldTotal / 2 * 100) / 100) {
      docData.deposit_required = Math.round(docData.total * 50) / 100; // 50% of new total
    }
    
    // DEBUG - remove after testing
    console.log('=== SAVE DEBUG ===');
    console.log('lineItems array:', JSON.stringify(lineItems, null, 2));
    console.log('docData.line_items:', JSON.stringify(docData.line_items, null, 2));
    console.log('Calculated subtotal:', docData.subtotal);
    console.log('Calculated total:', docData.total);
    
    const saveFunction = isNewDocument ? 'createDocument' : 'updateDocument';
    
    
    
    google.script.run
      .withSuccessHandler(function(result) {
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Save';
        btn.disabled = false;
        
        if (result.ok) {
          showToast('Saved successfully!', 'success');
          if (isNewDocument && result.doc_id) {
            isNewDocument = false;
            loadDocument(result.doc_id);
          } else {
            loadDocument(currentDocument.doc_id);
          }
        } else {
          showToast('Error saving: ' + result.error, 'error');
        }
      })
      .withFailureHandler(function(error) {
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Save';
        btn.disabled = false;
        showToast('Error: ' + error, 'error');
      })
      [saveFunction](isNewDocument ? docData : currentDocument.doc_id, isNewDocument ? undefined : docData);
  }
  
  // ========================================================================
  // NAVIGATION
  // ========================================================================
  function goBack() {
    // Try to go back in dashboard or browser history
    if (window.parent !== window) {
      // In iframe or embedded - try calling dashboard function
      try {
        if (typeof showView === 'function') {
          showView(currentDocument.doc_type === 'invoice' ? 'invoices' : 'quotes');
          return;
        }
      } catch(e) {}
    }
    window.history.back();
  }
  
  // ========================================================================
  // LIGHTBOX - Advanced with zoom, pan, navigation
  // ========================================================================
  let lightboxImages = [];
  let lightboxCurrentIndex = 0;
  let lightboxZoom = 1;
  let lightboxPanX = 0;
  let lightboxPanY = 0;
  let lightboxIsDragging = false;
  let lightboxStartX = 0;
  let lightboxStartY = 0;
  
  function openLightbox(imageUrl, filename, imageArray, startIndex) {
    // If imageArray provided, use it for navigation
    if (imageArray && Array.isArray(imageArray)) {
      lightboxImages = imageArray;
      lightboxCurrentIndex = startIndex || 0;
    } else {
      // Single image mode - collect all images from current context
      lightboxImages = collectAllImages();
      lightboxCurrentIndex = lightboxImages.findIndex(img => img.url === imageUrl);
      if (lightboxCurrentIndex === -1) {
        lightboxImages = [{ url: imageUrl, name: filename }];
        lightboxCurrentIndex = 0;
      }
    }
    
    lightboxResetZoom();
    showLightboxImage();
    document.getElementById('lightbox').classList.add('active');
    document.body.style.overflow = 'hidden';
    
    // Setup touch/mouse handlers
    setupLightboxHandlers();
  }
  
  function collectAllImages() {
    const images = [];
    
    // Collect from line items
    lineItems.forEach(item => {
      const atts = item.attachments || [];
      atts.forEach(att => {
        const url = att.url || att.file_url || '';
        const name = att.name || att.filename || 'File';
        if (url && /\.(jpg|jpeg|png|gif|webp|svg)/i.test(url + name)) {
          images.push({ url, name });
        }
      });
    });
    
    // Collect from project files
    projectFiles.forEach(file => {
      const url = file.url || file.file_url || '';
      const name = file.name || file.filename || 'File';
      if (url && /\.(jpg|jpeg|png|gif|webp|svg)/i.test(url + name)) {
        images.push({ url, name });
      }
    });
    
    return images;
  }
  
  function showLightboxImage() {
    const img = lightboxImages[lightboxCurrentIndex];
    if (!img) return;
    
    document.getElementById('lightbox-img').src = img.url;
    document.getElementById('lightbox-filename').textContent = img.name || '';
    document.getElementById('lightbox-download').href = img.url;
    document.getElementById('lightbox-counter').textContent = 
      `${lightboxCurrentIndex + 1} / ${lightboxImages.length}`;
    
    // Update nav button states
    document.getElementById('lightbox-prev').classList.toggle('disabled', lightboxCurrentIndex === 0);
    document.getElementById('lightbox-next').classList.toggle('disabled', lightboxCurrentIndex === lightboxImages.length - 1);
    
    // Hide nav if only one image
    const hideNav = lightboxImages.length <= 1;
    document.getElementById('lightbox-prev').style.display = hideNav ? 'none' : 'flex';
    document.getElementById('lightbox-next').style.display = hideNav ? 'none' : 'flex';
  }
  
  function lightboxPrev() {
    if (lightboxCurrentIndex > 0) {
      lightboxCurrentIndex--;
      lightboxResetZoom();
      showLightboxImage();
    }
  }
  
  function lightboxNext() {
    if (lightboxCurrentIndex < lightboxImages.length - 1) {
      lightboxCurrentIndex++;
      lightboxResetZoom();
      showLightboxImage();
    }
  }
  
  function lightboxZoomIn() {
    lightboxZoom = Math.min(lightboxZoom * 1.5, 5);
    applyLightboxTransform();
  }
  
  function lightboxZoomOut() {
    lightboxZoom = Math.max(lightboxZoom / 1.5, 1);
    if (lightboxZoom === 1) {
      lightboxPanX = 0;
      lightboxPanY = 0;
    }
    applyLightboxTransform();
  }
  
  function lightboxResetZoom() {
    lightboxZoom = 1;
    lightboxPanX = 0;
    lightboxPanY = 0;
    applyLightboxTransform();
  }
  
  function applyLightboxTransform() {
    const img = document.getElementById('lightbox-img');
    img.style.transform = `translate(${lightboxPanX}px, ${lightboxPanY}px) scale(${lightboxZoom})`;
    img.classList.toggle('zoomed', lightboxZoom > 1);
  }
  
  function setupLightboxHandlers() {
    const container = document.getElementById('lightbox-container');
    const img = document.getElementById('lightbox-img');
    
    // Mouse events for pan
    img.onmousedown = function(e) {
      if (lightboxZoom > 1) {
        lightboxIsDragging = true;
        lightboxStartX = e.clientX - lightboxPanX;
        lightboxStartY = e.clientY - lightboxPanY;
        img.style.cursor = 'grabbing';
      }
    };
    
    document.onmousemove = function(e) {
      if (lightboxIsDragging && lightboxZoom > 1) {
        lightboxPanX = e.clientX - lightboxStartX;
        lightboxPanY = e.clientY - lightboxStartY;
        applyLightboxTransform();
      }
    };
    
    document.onmouseup = function() {
      lightboxIsDragging = false;
      img.style.cursor = lightboxZoom > 1 ? 'move' : 'grab';
    };
    
    // Touch events for pinch zoom and pan
    let initialDistance = 0;
    let initialZoom = 1;
    
    container.ontouchstart = function(e) {
      if (e.touches.length === 2) {
        initialDistance = Math.hypot(
          e.touches[0].clientX - e.touches[1].clientX,
          e.touches[0].clientY - e.touches[1].clientY
        );
        initialZoom = lightboxZoom;
      } else if (e.touches.length === 1 && lightboxZoom > 1) {
        lightboxIsDragging = true;
        lightboxStartX = e.touches[0].clientX - lightboxPanX;
        lightboxStartY = e.touches[0].clientY - lightboxPanY;
      }
    };
    
    container.ontouchmove = function(e) {
      e.preventDefault();
      if (e.touches.length === 2) {
        const distance = Math.hypot(
          e.touches[0].clientX - e.touches[1].clientX,
          e.touches[0].clientY - e.touches[1].clientY
        );
        lightboxZoom = Math.min(Math.max(initialZoom * (distance / initialDistance), 1), 5);
        applyLightboxTransform();
      } else if (e.touches.length === 1 && lightboxIsDragging && lightboxZoom > 1) {
        lightboxPanX = e.touches[0].clientX - lightboxStartX;
        lightboxPanY = e.touches[0].clientY - lightboxStartY;
        applyLightboxTransform();
      }
    };
    
    container.ontouchend = function() {
      lightboxIsDragging = false;
    };
    
    // Double tap to zoom
    let lastTap = 0;
    container.onclick = function(e) {
      if (e.target === container) {
        closeLightbox();
        return;
      }
      
      const now = Date.now();
      if (now - lastTap < 300) {
        if (lightboxZoom > 1) {
          lightboxResetZoom();
        } else {
          lightboxZoom = 2.5;
          applyLightboxTransform();
        }
      }
      lastTap = now;
    };
  }
  
  function closeLightbox() {
    document.getElementById('lightbox').classList.remove('active');
    document.body.style.overflow = '';
    lightboxResetZoom();
  }

  // ========================================================================
  // CUSTOMER AUTOCOMPLETE
  // ========================================================================
  let customerCache = [];
  let customerSearchTimeout = null;
  let selectedAutocompleteIndex = -1;
  
  function handleCustomerSearch(query) {
    clearTimeout(customerSearchTimeout);
    
    if (!query || query.length < 2) {
      hideCustomerAutocomplete();
      return;
    }
    
    customerSearchTimeout = setTimeout(() => {
      searchCustomers(query);
    }, 200);
  }
  
  function searchCustomers(query) {
    // If we have cache, filter locally
    if (customerCache.length > 0) {
      showCustomerResults(filterCustomers(query));
      return;
    }
    
    // Fetch from backend
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.ok) {
          customerCache = result.customers || [];
          showCustomerResults(filterCustomers(query));
        }
      })
      .withFailureHandler(function() {
        // Silent fail
      })
      .getCustomerList();
  }
  
  function filterCustomers(query) {
    const q = query.toLowerCase();
    return customerCache.filter(c => {
      const name = (c.customer_name || '').toLowerCase();
      const company = (c.company_name || '').toLowerCase();
      const email = (c.customer_email || '').toLowerCase();
      const phone = (c.customer_phone || '').toLowerCase();
      return name.includes(q) || company.includes(q) || email.includes(q) || phone.includes(q);
    }).slice(0, 8);
  }
  
  function showCustomerResults(customers) {
    const dropdown = document.getElementById('customer-autocomplete');
    
    if (customers.length === 0) {
      dropdown.innerHTML = '<div class="autocomplete-empty">No matching customers</div>';
      dropdown.classList.add('active');
      return;
    }
    
    let html = '';
    customers.forEach((c, i) => {
      const details = [c.company_name, c.customer_email, c.customer_phone].filter(Boolean).join(' | ');
      html += `
        <div class="autocomplete-item ${i === selectedAutocompleteIndex ? 'selected' : ''}" 
             onclick="selectCustomer(${i})" 
             data-index="${i}">
          <div class="autocomplete-item-name">${escapeHtml(c.customer_name)}</div>
          ${details ? `<div class="autocomplete-item-details">${escapeHtml(details)}</div>` : ''}
        </div>
      `;
    });
    
    dropdown.innerHTML = html;
    dropdown.classList.add('active');
    
    // Store for selection
    dropdown.dataset.customers = JSON.stringify(customers);
  }
  
  function selectCustomer(index) {
    const dropdown = document.getElementById('customer-autocomplete');
    const customers = JSON.parse(dropdown.dataset.customers || '[]');
    const customer = customers[index];
    
    if (customer) {
      document.getElementById('customer_name').value = customer.customer_name || '';
      document.getElementById('company_name').value = customer.company_name || '';
      document.getElementById('customer_email').value = customer.customer_email || '';
      document.getElementById('customer_phone').value = customer.customer_phone || '';
    }
    
    hideCustomerAutocomplete();
  }
  
  function hideCustomerAutocomplete() {
    document.getElementById('customer-autocomplete').classList.remove('active');
    selectedAutocompleteIndex = -1;
  }
  
  // Handle keyboard navigation in autocomplete
  document.addEventListener('keydown', function(e) {
    const dropdown = document.getElementById('customer-autocomplete');
    if (!dropdown.classList.contains('active')) return;
    
    const items = dropdown.querySelectorAll('.autocomplete-item');
    if (items.length === 0) return;
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedAutocompleteIndex = Math.min(selectedAutocompleteIndex + 1, items.length - 1);
      updateAutocompleteSelection(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedAutocompleteIndex = Math.max(selectedAutocompleteIndex - 1, 0);
      updateAutocompleteSelection(items);
    } else if (e.key === 'Enter' && selectedAutocompleteIndex >= 0) {
      e.preventDefault();
      selectCustomer(selectedAutocompleteIndex);
    } else if (e.key === 'Escape') {
      hideCustomerAutocomplete();
    }
  });
  
  function updateAutocompleteSelection(items) {
    items.forEach((item, i) => {
      item.classList.toggle('selected', i === selectedAutocompleteIndex);
    });
  }
  
  // Close autocomplete when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.autocomplete-wrapper')) {
      hideCustomerAutocomplete();
    }
  });
  
  // ========================================================================
  // SCHEDULED EVENTS
  // ========================================================================
  let scheduledEvents = [];
  
  function loadScheduledEvents() {
    if (!currentDocument || !currentDocument.doc_id) return;
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.ok) {
          scheduledEvents = result.events || [];
          renderScheduledEvents();
        }
      })
      .withFailureHandler(function() {
        // Silent fail
      })
      .getDocumentCalendarEvents(currentDocument.doc_id);
  }
  
  function renderScheduledEvents() {
    const container = document.getElementById('scheduled-events-list');
    
    if (scheduledEvents.length === 0) {
      container.innerHTML = '<div class="no-events-message">No events scheduled</div>';
      return;
    }
    
    let html = '';
    scheduledEvents.forEach(evt => {
      const startDate = new Date(evt.start_time);
      const endDate = new Date(evt.end_time);
      const dateStr = startDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
      const timeStr = startDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) + 
                      ' - ' + endDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      
      html += `
        <div class="scheduled-event-item">
          <div class="scheduled-event-color" style="background: ${evt.category_color || '#d71cd1'};"></div>
          <div class="scheduled-event-info">
            <div class="scheduled-event-title">${escapeHtml(evt.title || 'Scheduled Event')}</div>
            <div class="scheduled-event-time">${dateStr} | ${timeStr}</div>
          </div>
          <div class="scheduled-event-actions">
            <button class="scheduled-event-btn" onclick="editScheduledEvent('${evt.event_id}')">Edit</button>
            <button class="scheduled-event-btn delete" onclick="cancelScheduledEvent('${evt.event_id}')">Cancel</button>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = html;
  }
  
  function openScheduleModal(existingEventId) {
    const doc = currentDocument;
    const isEdit = !!existingEventId;
    const existingEvent = isEdit ? scheduledEvents.find(e => e.event_id === existingEventId) : null;
    
    // Default values
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const dateValue = existingEvent 
      ? new Date(existingEvent.start_time).toISOString().split('T')[0]
      : tomorrow.toISOString().split('T')[0];
    
    // Only show end date if it's different from start date (multi-day event)
    const existingEndDate = existingEvent ? new Date(existingEvent.end_time).toISOString().split('T')[0] : null;
    const existingStartDate = existingEvent ? new Date(existingEvent.start_time).toISOString().split('T')[0] : null;
    const endDateValue = (existingEvent && existingEndDate !== existingStartDate) ? existingEndDate : '';
    
    const startTime = existingEvent 
      ? new Date(existingEvent.start_time).toTimeString().slice(0, 5)
      : '09:00';
    const endTime = existingEvent 
      ? new Date(existingEvent.end_time).toTimeString().slice(0, 5)
      : '17:00';
    
    // Build title from document info: "Name Vehicle Project"
    let defaultTitle = existingEvent?.title;
    if (!defaultTitle) {
      const parts = [];
      if (doc.customer_name) parts.push(doc.customer_name);
      if (doc.vehicle_description) parts.push(doc.vehicle_description);
      if (doc.project_description) parts.push(doc.project_description);
      defaultTitle = parts.join(' ') || 'Scheduled Job';
    }
    
    const modalHtml = `
      <div class="modal-backdrop" onclick="closeScheduleModal()">
        <div class="modal" style="max-width:500px;" onclick="event.stopPropagation()">
          <div class="modal-header">
            <div class="modal-title">${isEdit ? 'Edit' : 'Schedule'} Event</div>
            <button class="modal-close" onclick="closeScheduleModal()"></button>
          </div>
          <div class="modal-body">
            <div class="schedule-form">
              <div class="schedule-form-group full-width">
                <label class="schedule-form-label">Event Title</label>
                <input type="text" class="schedule-form-input" id="sched-title" value="${escapeHtml(defaultTitle)}" required>
              </div>
              
              <div class="schedule-form-group full-width">
                <label class="schedule-form-label">Event Type</label>
                <select class="schedule-form-select" id="sched-type">
                  <option value="Job" ${existingEvent?.event_type === 'Job' ? 'selected' : ''}>Job / Install</option>
                  <option value="Drop-off" ${existingEvent?.event_type === 'Drop-off' ? 'selected' : ''}>Vehicle Drop-off</option>
                  <option value="Pickup" ${existingEvent?.event_type === 'Pickup' ? 'selected' : ''}>Customer Pickup</option>
                  <option value="Consultation" ${existingEvent?.event_type === 'Consultation' ? 'selected' : ''}>Consultation</option>
                  <option value="Other" ${existingEvent?.event_type === 'Other' ? 'selected' : ''}>Other</option>
                </select>
              </div>
              
              <div class="schedule-form-row">
                <div class="schedule-form-group">
                  <label class="schedule-form-label">Start Date</label>
                  <input type="date" class="schedule-form-input" id="sched-start-date" value="${dateValue}" required>
                </div>
                <div class="schedule-form-group">
                  <label class="schedule-form-label">Start Time</label>
                  <input type="time" class="schedule-form-input" id="sched-start-time" value="${startTime}" required>
                </div>
              </div>
              
              <div class="schedule-form-row">
                <div class="schedule-form-group">
                  <label class="schedule-form-label">End Date <span style="font-weight:400;text-transform:none;">(optional, for multi-day)</span></label>
                  <input type="date" class="schedule-form-input" id="sched-end-date" value="${endDateValue}">
                </div>
                <div class="schedule-form-group">
                  <label class="schedule-form-label">End Time</label>
                  <input type="time" class="schedule-form-input" id="sched-end-time" value="${endTime}" required>
                </div>
              </div>
              
              <div class="schedule-form-group full-width">
                <label class="schedule-form-label">Notes</label>
                <textarea class="schedule-form-textarea" id="sched-notes" placeholder="Additional notes...">${escapeHtml(existingEvent?.notes || '')}</textarea>
              </div>
              
              <div class="modal-footer" style="margin:0;padding:16px 0 0 0;border-top:1px solid var(--border-color);">
                <button type="button" class="btn btn-secondary" onclick="closeScheduleModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveScheduledEvent('${existingEventId || ''}')">${isEdit ? 'Update' : 'Schedule'}</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    
    document.getElementById('schedule-modal-container').innerHTML = modalHtml;
  }
  
  function closeScheduleModal() {
    document.getElementById('schedule-modal-container').innerHTML = '';
  }

  // ========================================================================
  // FOLLOW-UP MODAL
  // ========================================================================
  function openFollowUpModal() {
    const doc = currentDocument;
    const firstName = (doc.customer_name || 'there').split(' ')[0];
    const docType = doc.doc_type || 'quote';
    
    // Default expiry date (7 days from now)
    const expiryDate = new Date();
    expiryDate.setDate(expiryDate.getDate() + 7);
    const expiryDateStr = expiryDate.toISOString().split('T')[0];
    
    // Default message
    const defaultMessage = 'Hi ' + firstName + ', just checking in on the ' + docType + ' we sent over. Let me know if you have any questions!';
    
    const modalHtml = `
      <div class="modal-backdrop" onclick="closeFollowUpModal()">
        <div class="modal" style="max-width:550px;" onclick="event.stopPropagation()">
          <div class="modal-header">
            <div class="modal-title">Follow Up</div>
            <button class="modal-close" onclick="closeFollowUpModal()"></button>
          </div>
          <div class="modal-body">
            <p style="color:var(--text-secondary);margin-bottom:16px;">
              Send a follow-up message to <strong>${escapeHtml(doc.customer_name || 'customer')}</strong>
              ${doc.followup_count ? '<span style="color:var(--text-muted);"> (Follow-up #' + (Number(doc.followup_count) + 1) + ')</span>' : ''}
            </p>
            
            <label style="font-size:12px;font-weight:500;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;display:block;margin-bottom:8px;">Message Template</label>
            <div class="followup-templates">
              <label class="followup-template-option selected" onclick="selectFollowUpTemplate(this, 'CHECKING_IN')">
                <input type="radio" name="followup-template" value="CHECKING_IN" checked>
                <div>
                  <div class="followup-template-label">Just Checking In</div>
                  <div class="followup-template-preview">Hi ${escapeHtml(firstName)}, just checking in on the ${docType} we sent over...</div>
                </div>
              </label>
              <label class="followup-template-option" onclick="selectFollowUpTemplate(this, 'READY_TO_PROCEED')">
                <input type="radio" name="followup-template" value="READY_TO_PROCEED">
                <div>
                  <div class="followup-template-label">Ready When You Are</div>
                  <div class="followup-template-preview">Hi ${escapeHtml(firstName)}, wanted to follow up on your ${docType}. We're ready to get started...</div>
                </div>
              </label>
            </div>
            
            <div style="margin-top:16px;">
              <label style="font-size:12px;font-weight:500;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;display:block;margin-bottom:8px;">Message Preview (editable)</label>
              <textarea id="followup-message" class="schedule-form-textarea" style="min-height:100px;">${escapeHtml(defaultMessage)}</textarea>
            </div>
            
            <div class="followup-incentive-section">
              <label class="followup-incentive-toggle">
                <input type="checkbox" id="followup-incentive-enabled" onchange="toggleIncentiveOptions()">
                <span style="font-weight:500;">Include a limited-time discount incentive</span>
              </label>
              <div class="followup-incentive-options" id="followup-incentive-options">
                <div class="schedule-form-row" style="gap:12px;">
                  <div class="schedule-form-group" style="flex:1;">
                    <label class="schedule-form-label">Discount Type</label>
                    <select class="schedule-form-select" id="followup-discount-type" onchange="toggleDiscountInputs()">
                      <option value="percent">Percentage (%)</option>
                      <option value="dollar">Dollar Amount ($)</option>
                    </select>
                  </div>
                  <div class="schedule-form-group" style="flex:1;" id="followup-percent-group">
                    <label class="schedule-form-label">Discount %</label>
                    <input type="number" class="schedule-form-input" id="followup-discount-percent" value="10" min="1" max="100" step="1" oninput="updateDiscountPreview()">
                  </div>
                  <div class="schedule-form-group" style="flex:1;display:none;" id="followup-dollar-group">
                    <label class="schedule-form-label">Discount $</label>
                    <input type="number" class="schedule-form-input" id="followup-discount-dollar" value="50" min="1" step="0.01" oninput="updateDiscountPreview()">
                  </div>
                  <div class="schedule-form-group" style="flex:1;">
                    <label class="schedule-form-label">Expires On</label>
                    <input type="date" class="schedule-form-input" id="followup-expiry-date" value="${expiryDateStr}" onchange="updateDiscountPreview()">
                  </div>
                </div>
                <div style="margin-top:8px;padding:10px;background:var(--bg-elevated);border-radius:var(--radius-md);font-size:13px;color:var(--text-secondary);" id="followup-discount-preview">
                  Discount preview will appear here
                </div>
              </div>
            </div>
            
            <div style="margin-top:16px;">
              <label style="font-size:12px;font-weight:500;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;display:block;margin-bottom:8px;">Deposit Required</label>
              <div class="schedule-form-row" style="gap:12px;align-items:center;">
                <div class="schedule-form-group" style="flex:0 0 auto;">
                  <select class="schedule-form-select" id="followup-deposit-type" onchange="updateDepositAmount()">
                    <option value="50">50%</option>
                    <option value="100">100%</option>
                    <option value="custom">Custom</option>
                  </select>
                </div>
                <div class="schedule-form-group" style="flex:1;">
                  <div style="display:flex;align-items:center;gap:8px;">
                    <span style="color:var(--text-secondary);">$</span>
                    <input type="number" class="schedule-form-input" id="followup-deposit-amount" value="${((Number(doc.total) || 0) * 0.5).toFixed(2)}" min="0" step="0.01">
                  </div>
                </div>
              </div>
            </div>
            
            <div class="modal-footer" style="margin:20px -20px -20px;padding:16px 20px;border-top:1px solid var(--border-color);">
              <button type="button" class="btn btn-secondary" onclick="closeFollowUpModal()">Cancel</button>
              <button type="button" class="btn btn-primary" onclick="sendFollowUp()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;margin-right:6px;"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                Send Follow-Up
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    document.getElementById('followup-modal-container').innerHTML = modalHtml;
    updateDiscountPreview();
  }
  
  function closeFollowUpModal() {
    document.getElementById('followup-modal-container').innerHTML = '';
  }
  
  function selectFollowUpTemplate(el, templateKey) {
    document.querySelectorAll('.followup-template-option').forEach(opt => opt.classList.remove('selected'));
    el.classList.add('selected');
    el.querySelector('input[type="radio"]').checked = true;
    
    // Update the message textarea based on template
    const doc = currentDocument;
    const firstName = (doc.customer_name || 'there').split(' ')[0];
    const docType = doc.doc_type || 'quote';
    
    let message = '';
    if (templateKey === 'CHECKING_IN') {
      message = 'Hi ' + firstName + ', just checking in on the ' + docType + ' we sent over. Let me know if you have any questions!';
    } else if (templateKey === 'READY_TO_PROCEED') {
      message = 'Hi ' + firstName + ', wanted to follow up on your ' + docType + '. We\'re ready to get started whenever works for you.';
    }
    
    document.getElementById('followup-message').value = message;
  }
  
  function toggleIncentiveOptions() {
    const enabled = document.getElementById('followup-incentive-enabled').checked;
    const options = document.getElementById('followup-incentive-options');
    if (enabled) {
      options.classList.add('show');
      updateDiscountPreview();
    } else {
      options.classList.remove('show');
    }
  }
  
  function toggleDiscountInputs() {
    const type = document.getElementById('followup-discount-type').value;
    const percentGroup = document.getElementById('followup-percent-group');
    const dollarGroup = document.getElementById('followup-dollar-group');
    
    if (type === 'percent') {
      percentGroup.style.display = 'block';
      dollarGroup.style.display = 'none';
    } else {
      percentGroup.style.display = 'none';
      dollarGroup.style.display = 'block';
    }
    updateDiscountPreview();
  }
  
  function updateDiscountPreview() {
    const doc = currentDocument;
    const subtotal = Number(doc.subtotal) || 0;
    const type = document.getElementById('followup-discount-type')?.value || 'percent';
    const percent = Number(document.getElementById('followup-discount-percent')?.value) || 10;
    const dollar = Number(document.getElementById('followup-discount-dollar')?.value) || 50;
    const expiryDate = document.getElementById('followup-expiry-date')?.value || '';
    
    let discountAmount = 0;
    let discountText = '';
    
    if (type === 'percent') {
      discountAmount = Math.round(subtotal * percent) / 100;
      discountText = percent + '% off';
    } else {
      discountAmount = dollar;
      discountText = '$' + dollar.toFixed(2) + ' off';
    }
    
    const newTotal = subtotal - discountAmount;
    
    const preview = document.getElementById('followup-discount-preview');
    if (preview) {
      preview.innerHTML = '<strong>' + discountText + '</strong> = $' + discountAmount.toFixed(2) + ' discount<br>' +
        'New total: <strong>$' + newTotal.toFixed(2) + '</strong>' +
        (expiryDate ? '<br>Valid until: ' + expiryDate : '');
    }
  }

  function updateDepositAmount() {
    const doc = currentDocument;
    const type = document.getElementById('followup-deposit-type').value;
    const depositInput = document.getElementById('followup-deposit-amount');
    
    // Get current total (accounting for any discount)
    const subtotal = Number(doc.subtotal) || 0;
    const discountEnabled = document.getElementById('followup-incentive-enabled')?.checked;
    let total = subtotal;
    
    if (discountEnabled) {
      const discountType = document.getElementById('followup-discount-type')?.value || 'percent';
      if (discountType === 'percent') {
        const percent = Number(document.getElementById('followup-discount-percent')?.value) || 0;
        total = subtotal - (subtotal * percent / 100);
      } else {
        const dollar = Number(document.getElementById('followup-discount-dollar')?.value) || 0;
        total = subtotal - dollar;
      }
    }
    
    if (type === '50') {
      depositInput.value = (total * 0.5).toFixed(2);
    } else if (type === '100') {
      depositInput.value = total.toFixed(2);
    }
    // 'custom' leaves the input as-is for manual entry
  }
  
  function sendFollowUp() {
    const doc = currentDocument;
    const message = document.getElementById('followup-message')?.value || '';
    const incentiveEnabled = document.getElementById('followup-incentive-enabled').checked;
    
    if (!message.trim()) {
      showToast('Please enter a message', 'error');
      return;
    }
    
    const options = {
      customMessage: message
    };
    
    if (incentiveEnabled) {
      const discountType = document.getElementById('followup-discount-type').value;
      const subtotal = Number(doc.subtotal) || 0;
      
      let discountPercent = 0;
      let discountAmount = 0;
      
      if (discountType === 'percent') {
        discountPercent = Number(document.getElementById('followup-discount-percent').value) || 10;
        discountAmount = Math.round(subtotal * discountPercent) / 100;
      } else {
        discountAmount = Number(document.getElementById('followup-discount-dollar').value) || 50;
        discountPercent = subtotal > 0 ? Math.round((discountAmount / subtotal) * 100 * 100) / 100 : 0;
      }
      
      options.incentive = {
        type: discountType,
        percent: discountPercent,
        amount: discountAmount,
        expiresAt: document.getElementById('followup-expiry-date').value,
        expiryDays: Math.ceil((new Date(document.getElementById('followup-expiry-date').value) - new Date()) / (1000 * 60 * 60 * 24))
      };
    }
    
    // Include deposit amount
    const depositAmount = Number(document.getElementById('followup-deposit-amount')?.value) || 0;
    options.depositRequired = depositAmount;
    
    // Disable button and show loading
    const btn = document.querySelector('#followup-modal-container .btn-primary');
    btn.disabled = true;
    btn.innerHTML = 'Sending...';
    
    google.script.run
      .withSuccessHandler(function(result) {
        closeFollowUpModal();
        if (result.ok) {
          showToast('Follow-up sent!' + (result.sms_sent ? '' : ' (SMS delivery pending)'), 'success');
          loadDocument(doc.doc_id);
        } else {
          showToast('Error: ' + result.error, 'error');
        }
      })
      .withFailureHandler(function(error) {
        closeFollowUpModal();
        showToast('Error: ' + error, 'error');
      })
      .sendFollowUp(doc.doc_id, options);
  }
  
  // ========================================================================
  // ARCHIVE MODAL
  // ========================================================================
  function openArchiveModal() {
    const doc = currentDocument;
    const isQuote = doc.doc_type === 'quote';
    const isPaid = doc.status === 'Paid';
    
    // Default to Won if paid, Lost otherwise
    const defaultBucket = isPaid ? 'won' : 'lost';
    
    const modalHtml = `
      <div class="modal-backdrop" onclick="closeDocArchiveModal()">
        <div class="modal" style="max-width:450px;" onclick="event.stopPropagation()">
          <div class="modal-header">
            <div class="modal-title">Archive ${isQuote ? 'Quote' : 'Invoice'}</div>
            <button class="modal-close" onclick="event.stopPropagation();closeDocArchiveModal()"></button>
          </div>
          <div class="modal-body">
            <div class="bucket-select-section">
              <label style="font-size:12px;font-weight:500;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;">Archive As</label>
              <div class="bucket-select-options">
                <button type="button" class="bucket-select-btn won ${defaultBucket === 'won' ? 'selected' : ''}" onclick="selectArchiveBucket('won', this)">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;margin-bottom:4px;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                  <div>Won</div>
                </button>
                <button type="button" class="bucket-select-btn lost ${defaultBucket === 'lost' ? 'selected' : ''}" onclick="selectArchiveBucket('lost', this)">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;margin-bottom:4px;"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
                  <div>Lost</div>
                </button>
              </div>
            </div>
            
            <div id="archive-reason-section" style="${defaultBucket === 'won' ? 'display:none;' : ''}">
              <label style="font-size:12px;font-weight:500;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;display:block;margin-bottom:8px;">Reason</label>
              <div class="archive-reason-options">
                <label class="archive-reason-option" onclick="selectArchiveReason(this, 'COMPETITOR')">
                  <input type="radio" name="archive-reason" value="COMPETITOR">
                  <span>Went with competitor</span>
                </label>
                <label class="archive-reason-option" onclick="selectArchiveReason(this, 'BUDGET')">
                  <input type="radio" name="archive-reason" value="BUDGET">
                  <span>Budget issues</span>
                </label>
                <label class="archive-reason-option" onclick="selectArchiveReason(this, 'NO_RESPONSE')">
                  <input type="radio" name="archive-reason" value="NO_RESPONSE">
                  <span>No response</span>
                </label>
                <label class="archive-reason-option" onclick="selectArchiveReason(this, 'TIMING')">
                  <input type="radio" name="archive-reason" value="TIMING">
                  <span>Bad timing</span>
                </label>
                <label class="archive-reason-option" onclick="selectArchiveReason(this, 'OTHER')">
                  <input type="radio" name="archive-reason" value="OTHER">
                  <span>Other</span>
                </label>
              </div>
              <div class="archive-other-input" id="archive-other-input">
                <input type="text" class="schedule-form-input" id="archive-other-reason" placeholder="Enter reason..." style="margin-top:12px;">
              </div>
            </div>
            
            <div class="modal-footer" style="margin:20px -20px -20px;padding:16px 20px;border-top:1px solid var(--border-color);">
              <button type="button" class="btn btn-secondary" onclick="event.stopPropagation();closeDocArchiveModal()">Cancel</button>
              <button type="button" class="btn btn-primary" id="archive-submit-btn" onclick="submitArchive()">Archive</button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    document.getElementById('archive-modal-container').innerHTML = modalHtml;
  }
  
  function closeDocArchiveModal() {
    document.getElementById('archive-modal-container').innerHTML = '';
  }
  
  let selectedArchiveBucket = 'lost';
  
  function selectArchiveBucket(bucket, el) {
    selectedArchiveBucket = bucket;
    document.querySelectorAll('.bucket-select-btn').forEach(btn => btn.classList.remove('selected'));
    el.classList.add('selected');
    
    const reasonSection = document.getElementById('archive-reason-section');
    if (bucket === 'won') {
      reasonSection.style.display = 'none';
    } else {
      reasonSection.style.display = 'block';
    }
  }
  
  function selectArchiveReason(el, reasonKey) {
    document.querySelectorAll('.archive-reason-option').forEach(opt => opt.classList.remove('selected'));
    el.classList.add('selected');
    el.querySelector('input[type="radio"]').checked = true;
    
    const otherInput = document.getElementById('archive-other-input');
    if (reasonKey === 'OTHER') {
      otherInput.classList.add('show');
    } else {
      otherInput.classList.remove('show');
    }
  }
  
  function submitArchive() {
    const doc = currentDocument;
    const bucket = selectedArchiveBucket;
    
    let reason = '';
    if (bucket === 'lost') {
      const selectedReason = document.querySelector('input[name="archive-reason"]:checked');
      if (!selectedReason) {
        showToast('Please select a reason', 'error');
        return;
      }
      reason = selectedReason.value;
      if (reason === 'OTHER') {
        reason = document.getElementById('archive-other-reason').value || 'Other';
      } else {
        // Map to readable label
        const labels = {
          'COMPETITOR': 'Went with competitor',
          'BUDGET': 'Budget issues',
          'NO_RESPONSE': 'No response',
          'TIMING': 'Bad timing'
        };
        reason = labels[reason] || reason;
      }
    }
    
    const btn = document.getElementById('archive-submit-btn');
    btn.disabled = true;
    btn.innerHTML = 'Archiving...';
    
    google.script.run
      .withSuccessHandler(function(result) {
        closeDocArchiveModal();
        if (result.ok) {
          showToast('Archived as ' + (bucket === 'won' ? 'Won' : 'Lost'), 'success');
          loadDocument(doc.doc_id);
        } else {
          showToast('Error: ' + result.error, 'error');
        }
      })
      .withFailureHandler(function(error) {
        closeDocArchiveModal();
        showToast('Error: ' + error, 'error');
      })
      .archiveDocument(doc.doc_id, bucket, reason);
  }
  
  function unarchiveDocument() {
    const doc = currentDocument;
    
    if (!confirm('Move this document back to "Ready for Action"?')) {
      return;
    }
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.ok) {
          showToast('Document unarchived', 'success');
          loadDocument(doc.doc_id);
        } else {
          showToast('Error: ' + result.error, 'error');
        }
      })
      .withFailureHandler(function(error) {
        showToast('Error: ' + error, 'error');
      })
      .moveDocumentToBucket(doc.doc_id, 'READY_FOR_ACTION');
  }

  function saveScheduledEvent(existingEventId) {
    const doc = currentDocument;
    const startDateVal = document.getElementById('sched-start-date').value;
    const startTimeVal = document.getElementById('sched-start-time').value;
    const endDateVal = document.getElementById('sched-end-date').value || startDateVal;
    const endTimeVal = document.getElementById('sched-end-time').value;
    
    // Get category from first line item for color
    const firstItem = lineItems.length > 0 ? lineItems[0] : null;
    const categoryKey = firstItem?.category || doc.category_key || '';
    
    const eventData = {
      title: document.getElementById('sched-title').value,
      event_type: document.getElementById('sched-type').value,
      start_time: startDateVal + 'T' + startTimeVal + ':00',
      end_time: endDateVal + 'T' + endTimeVal + ':00',
      customer_name: doc.customer_name,
      customer_phone: doc.customer_phone,
      vehicle_description: doc.vehicle_description,
      invoice_id: doc.doc_id,
      doc_id: doc.doc_id,
      category_key: categoryKey,
      notes: document.getElementById('sched-notes').value
    };
    
    // Get the submit button and disable it
    const submitBtn = document.querySelector('#schedule-modal-container .btn-primary');
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.textContent = existingEventId ? 'Updating...' : 'Scheduling...';
    }
    
    if (existingEventId) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.ok) {
            closeScheduleModal();
            showToast('Event updated!', 'success');
            loadScheduledEvents();
          } else {
            showToast('Error: ' + result.error, 'error');
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = 'Update';
            }
          }
        })
        .withFailureHandler(function(error) {
          showToast('Error: ' + error, 'error');
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Update';
          }
        })
        .updateCalendarEvent(existingEventId, eventData);
    } else {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.ok) {
            closeScheduleModal();
            showToast('Event scheduled!', 'success');
            loadScheduledEvents();
          } else {
            showToast('Error: ' + result.error, 'error');
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = 'Schedule';
            }
          }
        })
        .withFailureHandler(function(error) {
          showToast('Error: ' + error, 'error');
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Schedule';
          }
        })
        .createCalendarEvent(eventData);
    }
  }
  
  
  function editScheduledEvent(eventId) {
    openScheduleModal(eventId);
  }
  
  function cancelScheduledEvent(eventId) {
    if (!confirm('Cancel this scheduled event?')) return;
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.ok) {
          showToast('Event cancelled', 'success');
          loadScheduledEvents();
        } else {
          showToast('Error: ' + result.error, 'error');
        }
      })
      .withFailureHandler(function(error) {
        showToast('Error: ' + error, 'error');
      })
      .cancelCalendarEvent(eventId);
  }
  
  // ========================================================================
  // UTILITIES
  // ========================================================================
  function showToast(message, type) {
    const existing = document.querySelector('.toast');
    if (existing) existing.remove();
    
    const toast = document.createElement('div');
    toast.className = 'toast ' + (type || '');
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.remove(), 3500);
  }
  
  function formatCurrency(amount) {
    return '$' + Number(amount || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }
  
  function formatDate(dateStr) {
    if (!dateStr) return '';
    try {
      const d = new Date(dateStr);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    } catch (e) {
      return dateStr;
    }
  }
  
  function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
  }
  
  // ========================================================================
  // LINKED TASKS
  // ========================================================================
  
  let linkedTasks = [];
  
  function loadLinkedTasks() {
    const doc = currentDocument;
    if (!doc || !doc.doc_id) return;
    
    const docType = doc.doc_type === 'quote' ? 'quote' : 'invoice';
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result && result.ok) {
          linkedTasks = result.tasks || [];
          renderLinkedTasks();
        }
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load linked tasks:', error);
      })
      .getTasksForDocument(doc.doc_id, docType);
  }
  
  function renderLinkedTasks() {
    const container = document.getElementById('linked-tasks-list');
    if (!container) return;
    
    if (linkedTasks.length === 0) {
      container.innerHTML = '<div class="no-tasks-message" style="color:var(--text-muted);font-size:13px;padding:12px 0;">No tasks linked to this document</div>';
      return;
    }
    
    let html = '';
    linkedTasks.forEach(task => {
      const isCompleted = task.status === 'COMPLETED' || task.status === 'DONE';
      const priorityClass = (task.priority || 'normal').toLowerCase();
      
      html += `
        <div class="linked-task-item ${isCompleted ? 'completed' : ''}" data-task-id="${task.task_id}">
          <input type="checkbox" class="linked-task-checkbox" 
                 ${isCompleted ? 'checked' : ''} 
                 onchange="toggleLinkedTaskComplete('${task.task_id}', this.checked)">
          <div class="linked-task-content">
            <div class="linked-task-title">${escapeHtml(task.title)}</div>
            <div class="linked-task-meta">
              ${task.due_date ? 'Due: ' + formatDate(task.due_date) : ''}
              ${task.description ? ' - ' + escapeHtml(task.description).substring(0, 50) : ''}
            </div>
          </div>
          <span class="linked-task-priority ${priorityClass}">${task.priority || 'NORMAL'}</span>
          <button class="linked-task-delete" onclick="deleteLinkedTask('${task.task_id}')" title="Delete task">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
          </button>
        </div>
      `;
    });
    
    container.innerHTML = html;
  }
  
  function toggleLinkedTaskComplete(taskId, isComplete) {
    // Optimistic update
    const task = linkedTasks.find(t => t.task_id === taskId);
    if (task) {
      task.status = isComplete ? 'COMPLETED' : 'TODO';
      renderLinkedTasks();
    }
    
    if (isComplete) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (!result.ok) {
            // Revert
            if (task) task.status = 'TODO';
            renderLinkedTasks();
            showToast('Error: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          if (task) task.status = 'TODO';
          renderLinkedTasks();
          showToast('Error: ' + error, 'error');
        })
        .completeTask(taskId);
    } else {
      google.script.run
        .withSuccessHandler(function(result) {
          if (!result.ok) {
            if (task) task.status = 'COMPLETED';
            renderLinkedTasks();
            showToast('Error: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          if (task) task.status = 'COMPLETED';
          renderLinkedTasks();
          showToast('Error: ' + error, 'error');
        })
        .reopenTask(taskId);
    }
  }
  
  function deleteLinkedTask(taskId) {
    if (!confirm('Delete this task?')) return;
    
    // Optimistic update
    const taskIndex = linkedTasks.findIndex(t => t.task_id === taskId);
    const removedTask = taskIndex >= 0 ? linkedTasks.splice(taskIndex, 1)[0] : null;
    renderLinkedTasks();
    showToast('Task deleted', 'success');
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (!result.ok) {
          if (removedTask) linkedTasks.push(removedTask);
          renderLinkedTasks();
          showToast('Error: ' + result.error, 'error');
        }
      })
      .withFailureHandler(function(error) {
        if (removedTask) linkedTasks.push(removedTask);
        renderLinkedTasks();
        showToast('Error: ' + error, 'error');
      })
      .deleteTask(taskId);
  }
  
  function openAddLinkedTaskModal() {
    const doc = currentDocument;
    const docType = doc.doc_type === 'quote' ? 'quote' : 'invoice';
    const docLabel = docType.charAt(0).toUpperCase() + docType.slice(1) + ' ' + doc.doc_id;
    
    const modalHtml = `
      <div class="modal-backdrop" onclick="closeAddLinkedTaskModal()">
        <div class="modal" style="max-width:450px;" onclick="event.stopPropagation()">
          <div class="modal-header">
            <div class="modal-title">Add Task</div>
            <button class="modal-close" onclick="closeAddLinkedTaskModal()"></button>
          </div>
          <div class="modal-body">
            <p style="color:var(--text-secondary);margin-bottom:16px;font-size:13px;">
              Create a task linked to <strong>${escapeHtml(docLabel)}</strong>
            </p>
            
            <div class="form-group" style="margin-bottom:12px;">
              <label class="form-label" style="font-size:12px;font-weight:500;color:var(--text-muted);margin-bottom:4px;display:block;">Task Title *</label>
              <input type="text" id="linked-task-title" class="form-input" style="width:100%;padding:8px 12px;background:var(--bg-elevated);border:1px solid var(--border-color);border-radius:var(--radius-md);color:var(--text-primary);" placeholder="What needs to be done?">
            </div>
            
            <div class="form-group" style="margin-bottom:12px;">
              <label class="form-label" style="font-size:12px;font-weight:500;color:var(--text-muted);margin-bottom:4px;display:block;">Description</label>
              <textarea id="linked-task-description" class="form-textarea" style="width:100%;padding:8px 12px;background:var(--bg-elevated);border:1px solid var(--border-color);border-radius:var(--radius-md);color:var(--text-primary);min-height:60px;resize:vertical;" placeholder="Optional details..."></textarea>
            </div>
            
            <div style="display:flex;gap:12px;">
              <div class="form-group" style="flex:1;">
                <label class="form-label" style="font-size:12px;font-weight:500;color:var(--text-muted);margin-bottom:4px;display:block;">Priority</label>
                <select id="linked-task-priority" class="form-select" style="width:100%;padding:8px 12px;background:var(--bg-elevated);border:1px solid var(--border-color);border-radius:var(--radius-md);color:var(--text-primary);">
                  <option value="LOW">Low</option>
                  <option value="NORMAL" selected>Normal</option>
                  <option value="HIGH">High</option>
                  <option value="URGENT">Urgent</option>
                </select>
              </div>
              <div class="form-group" style="flex:1;">
                <label class="form-label" style="font-size:12px;font-weight:500;color:var(--text-muted);margin-bottom:4px;display:block;">Due Date</label>
                <input type="date" id="linked-task-due-date" class="form-input" style="width:100%;padding:8px 12px;background:var(--bg-elevated);border:1px solid var(--border-color);border-radius:var(--radius-md);color:var(--text-primary);">
              </div>
            </div>
            
            <div class="modal-footer" style="margin:20px -20px -20px;padding:16px 20px;border-top:1px solid var(--border-color);display:flex;justify-content:flex-end;gap:8px;">
              <button type="button" class="btn btn-secondary" onclick="closeAddLinkedTaskModal()">Cancel</button>
              <button type="button" class="btn btn-primary" onclick="saveLinkedTask()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;margin-right:6px;"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Add Task
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // Create container if not exists
    let container = document.getElementById('linked-task-modal-container');
    if (!container) {
      container = document.createElement('div');
      container.id = 'linked-task-modal-container';
      document.body.appendChild(container);
    }
    container.innerHTML = modalHtml;
  }
  
  function closeAddLinkedTaskModal() {
    const container = document.getElementById('linked-task-modal-container');
    if (container) container.innerHTML = '';
  }
  
  function saveLinkedTask() {
    const title = document.getElementById('linked-task-title').value.trim();
    if (!title) {
      showToast('Please enter a task title', 'error');
      return;
    }
    
    const doc = currentDocument;
    const docType = doc.doc_type === 'quote' ? 'quote' : 'invoice';
    
    const taskData = {
      title: title,
      description: document.getElementById('linked-task-description').value.trim(),
      priority: document.getElementById('linked-task-priority').value,
      due_date: document.getElementById('linked-task-due-date').value || null,
      quote_id: docType === 'quote' ? doc.doc_id : '',
      invoice_id: docType === 'invoice' ? doc.doc_id : ''
    };
    
    // Disable button
    const btn = document.querySelector('#linked-task-modal-container .btn-primary');
    if (btn) {
      btn.disabled = true;
      btn.innerHTML = 'Adding...';
    }
    
    google.script.run
      .withSuccessHandler(function(result) {
        closeAddLinkedTaskModal();
        if (result && result.ok) {
          showToast('Task added!', 'success');
          loadLinkedTasks();
        } else {
          showToast('Error: ' + (result?.error || 'Unknown error'), 'error');
        }
      })
      .withFailureHandler(function(error) {
        closeAddLinkedTaskModal();
        showToast('Error: ' + error, 'error');
      })
      .createTask(taskData);
  }
  
  // Keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    // Lightbox shortcuts
    const lightbox = document.getElementById('lightbox');
    if (lightbox.classList.contains('active')) {
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') lightboxPrev();
      if (e.key === 'ArrowRight') lightboxNext();
      if (e.key === '+' || e.key === '=') lightboxZoomIn();
      if (e.key === '-') lightboxZoomOut();
      if (e.key === '0') lightboxResetZoom();
      return;
    }
    
    if (e.key === 'Escape') {
      closeScheduleModal();
      hideCustomerAutocomplete();
    }
    if ((e.metaKey || e.ctrlKey) && e.key === 's') {
      e.preventDefault();
      saveDocument();
    }
  });
</script>